<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroDashboard v5.5 - Global Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AstroDash">
    <link rel="apple-touch-icon" href="astro_logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://aladin.cds.unistra.fr/AladinLite/api/v2/latest/aladin.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://aladin.cds.unistra.fr/AladinLite/api/v2/latest/aladin.min.js"></script>

    <script src="database.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #121212; color: #e0e0e0; text-align: center; margin: 0; padding: 20px; }
        h2 { color: #bb86fc; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; display: flex; align-items: center; justify-content: center; gap: 10px;}
        h3 { margin-top: 0; color: #fff; display: flex; align-items: center; gap: 8px;}
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 20px; max-width: 1200px; margin: 0 auto; }
        .panel { background-color: #1e1e1e; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); text-align: left; flex: 1; min-width: 320px; }
        
        .info-icon { font-size: 0.9em; cursor: pointer; opacity: 0.6; transition: 0.2s; filter: grayscale(100%); margin-left: 5px; }
        .info-icon:hover { opacity: 1; filter: grayscale(0) drop-shadow(0 0 5px rgba(187, 134, 252, 0.8)); transform: scale(1.1);}
        
        .main-header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; max-width: 1200px; margin: 0 auto 20px auto; background: #1a1a1a; padding: 15px 25px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5); box-sizing: border-box; width: 100%;}
        .logo-container { justify-self: center; }
        .center-logo { height: 100px; object-fit: contain; filter: drop-shadow(0 0 8px rgba(187, 134, 252, 0.2));}
        .author-section { display: flex; align-items: center; gap: 15px; justify-self: end; text-align: right;}
        .btn-guide { background: transparent; border: 1px solid #bb86fc; color: #bb86fc; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: 0.2s; font-weight: bold; margin-top: 5px;}
        .btn-guide:hover { background: #bb86fc; color: #121212;}
        
        .lang-container { justify-self: start; text-align: left; display: flex; flex-direction: column; gap: 5px; }
        .lang-toggle { display: inline-flex; background: #1a1a1a; border-radius: 20px; border: 1px solid #444; overflow: hidden; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .lang-btn { background: transparent; border: none; color: #777; padding: 6px 14px; font-size: 0.95em; cursor: pointer; transition: 0.3s; font-weight: bold; display: flex; align-items: center; }
        .lang-btn.active { background: #bb86fc; color: #121212; }
        .lang-btn:hover:not(.active) { color: #fff; background: #333; }

        .ephemeris-box { display: flex; justify-content: space-around; align-items: center; background-color: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; width: 100%; flex-wrap: wrap;}
        .moon-container { display: flex; flex-direction: column; align-items: center; margin-right: 20px; min-width: 120px;}
        .moon-icon { font-size: 3.5em; text-shadow: 0 0 15px rgba(255, 255, 170, 0.4); margin-bottom: 5px;}
        .moon-phase-name { font-size: 0.9em; font-weight: bold; color: #bb86fc; text-transform: uppercase; text-align: center;}
        .weather-container { display: flex; flex-direction: column; align-items: center; justify-content: center; border-left: 1px solid #444; border-right: 1px solid #444; padding: 0 20px; min-width: 100px; margin: 10px 0;}
        .times-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; width: 100%; flex: 1; min-width: 300px; padding-left: 20px;}
        .time-item { text-align: center; font-size: 0.9em; color: #aaa;}
        .icon-normal { font-style: normal; font-size: 1.8em; display: block; margin-bottom: 5px; }
        .time-item span { font-size: 1.3em; font-weight: bold; color: #fff; display: block; margin-top: 3px;}

        .input-group { margin-bottom: 12px; position: relative; }
        label { display: inline-block; width: 100px; color: #aaa; font-size: 0.9em;}
        input[type="text"]:not(.search-local-input), input[type="number"], select { width: calc(100% - 125px); cursor: pointer; }
        input[type="text"], input[type="number"], select, input[type="time"] { padding: 8px; border-radius: 4px; border: 1px solid #333; background-color: #2c2c2c; color: #fff; font-family: inherit; box-sizing: border-box;}
        input[type="time"] { width: 130px !important; text-align: center; } 
        #dropdown-risultati { list-style: none; padding: 0; margin: 0; position: absolute; width: calc(100% - 125px); background-color: #2c2c2c; border: 1px solid #444; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; left: 105px; display: none; text-align: left;}
        #dropdown-risultati li { padding: 10px; cursor: pointer; border-bottom: 1px solid #444; font-size: 0.9em; }
        #dropdown-risultati li:hover { background-color: #bb86fc; color: #121212; font-weight: bold; }
        #map { height: 500px; width: 100%; border: 2px solid #333; border-radius: 8px; z-index: 1; }
        
        .timeline-container { margin-top: 20px; padding: 15px; background-color: #2a2a2a; border-radius: 8px; text-align: center; width: 100%; box-sizing: border-box;}
        input[type="range"] { width: 100%; cursor: pointer; margin-top: 10px;}
        .time-display { font-size: 1.3em; color: #bb86fc; font-weight: bold; margin-bottom: 5px; text-transform: capitalize;}
        
        .meteo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-top: 15px; }
        .meteo-item { background-color: #2a2a2a; padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; transition: 0.3s; user-select: none; border: 2px solid transparent;}
        .meteo-item:hover { filter: brightness(1.2); }
        .meteo-item h4 { margin: 0 0 5px 0; font-size: 0.85em; color: #aaa; }
        .meteo-item span { font-size: 1.4em; font-weight: bold; }
        .jet-unit { font-size: 0.6em; font-weight: normal; color: #ccc; }
        .disabled { opacity: 0.4; filter: grayscale(100%); background-color: #1a1a1a; }
        .m-bassa.active { border-color: #ff4444; } .m-media.active { border-color: #44ff44; } .m-alta.active { border-color: #4444ff; } .m-jet.active { border-color: #ff00ff; } .m-luna.active { border-color: #ffffaa; } .m-umidita.active { border-color: #00ffff;} .m-seeing { border-color: #bb86fc; cursor: default;}

        .dso-container { margin-top: 20px; text-align: left; padding: 20px; background-color: #1a1a1a; border-radius: 8px;}
        .astro-section { width: 100%; display: block; }
        .horizontal-scroll { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 15px; margin-top: 10px; scrollbar-width: thin; scrollbar-color: #bb86fc #2a2a2a; flex-wrap: nowrap;}
        .horizontal-scroll::-webkit-scrollbar { height: 8px; }
        .horizontal-scroll::-webkit-scrollbar-track { background-color: #1e1e1e; border-radius: 4px; }
        .horizontal-scroll::-webkit-scrollbar-thumb { background-color: #444; border-radius: 4px; }
        .horizontal-scroll::-webkit-scrollbar-thumb:hover { background-color: #bb86fc; }

        .dso-card { flex: 0 0 auto; width: 220px; background-color: #2a2a2a; border: 1px solid #333; padding: 15px; border-radius: 8px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.5); position: relative;}
        .card-clickable { cursor: pointer; transition: transform 0.2s; }
        .card-clickable:hover { transform: translateY(-5px); background-color: #333;}
        .card-static { cursor: default; opacity: 0.7; filter: grayscale(50%);}
        .dso-icon { font-size: 2.5em; margin-right: 15px; filter: drop-shadow(0px 0px 5px rgba(187, 134, 252, 0.4));}
        .dso-info h4 { margin: 0 0 5px 0; font-size: 0.9em; color: #fff;}
        .dso-info p { margin: 0; font-size: 0.85em; color: #aaa;}
        .dso-direction { display: inline-block; padding: 2px 6px; background-color: #bb86fc; color: #121212; border-radius: 4px; font-weight: bold; font-size: 0.8em; margin-top: 5px;}
        .top-target { border: 2px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .top-target::after { content: '‚≠ê'; position: absolute; top: -10px; right: 10px; background-color: #ffd700; color: #000; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: bold;}

        .search-local-box { background-color: #2a2a2a; padding: 15px; border-radius: 8px; margin-top: 25px; text-align: center; border: 1px solid #444; }
        .search-local-box h4 { margin: 0 0 10px 0; color: #fff; font-size: 1.1em;}
        .search-wrapper { position: relative; display: inline-block; text-align: left; }
        .search-local-input { width: 350px !important; max-width: 100%; padding: 12px 15px !important; border-radius: 5px; border: 1px solid #555 !important; background-color: #1e1e1e !important; color: #fff !important; font-size: 1.1em !important; cursor: text !important; letter-spacing: 0.5px;}
        .search-local-input:focus { outline: none; border-color: #bb86fc !important; box-shadow: 0 0 8px rgba(187,134,252,0.3); }
        .btn-search { padding: 12px 25px; background-color: #bb86fc; color: #121212; border: none; border-radius: 5px; font-weight: bold; font-size: 1.1em; cursor: pointer; transition: 0.2s; margin-left: 10px;}
        .btn-search:hover { background-color: #a361f9; }
        .search-suggestions { position: absolute; top: 100%; left: 0; width: 350px; background-color: #2c2c2c; border: 1px solid #555; border-top: none; border-radius: 0 0 5px 5px; max-height: 250px; overflow-y: auto; z-index: 2000; list-style: none; padding: 0; margin: 0; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.8);}
        .search-suggestions li { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #333; color: #ddd; font-size: 1em; display: flex; align-items: center; gap: 10px;}
        .search-suggestions li:hover { background-color: #bb86fc; color: #121212; font-weight: bold; }
        .search-status { margin: 10px 0 0 0; font-size: 0.9em; display: none; text-align: center; width: 100%; font-weight: bold;}

        #planning-view { display: none; text-align: left; max-width: 1200px; margin: 0 auto;}
        .btn-back { background: linear-gradient(135deg, #7c4dff 0%, #bb86fc 100%); color: #ffffff; border: none; padding: 12px 28px; border-radius: 50px; cursor: pointer; font-size: 1.1em; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(124, 77, 255, 0.3); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); letter-spacing: 0.5px; text-transform: uppercase;}
        .btn-back:hover { background: linear-gradient(135deg, #9e75ff 0%, #d2aaff 100%); box-shadow: 0 8px 25px rgba(187, 134, 252, 0.5), 0 0 10px rgba(255,255,255,0.2) inset; transform: translateY(-3px) scale(1.02); color: #fff; }
        .planning-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}

        .stat-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;}
        .stat-box { background: #2a2a2a; padding: 10px; border-radius: 5px; flex: 1; min-width: 120px; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .stat-box.t-type { border-left: 3px solid #bb86fc; }
        .stat-box.t-mag { border-left: 3px solid #44ff44; }
        .stat-box.t-dist { border-left: 3px solid #ffaa00; }
        .stat-box span { font-size: 0.8em; color: #aaa; text-transform: uppercase;}
        .stat-box b { display: block; font-size: 1.1em; color: #fff; margin-top: 3px;}
        .info-box { background-color: #222; border-left: 4px solid #bb86fc; padding: 15px; margin-bottom: 10px; border-radius: 4px; font-size: 0.95em; line-height: 1.5; color: #ddd;}
        .tip-box { background-color: rgba(255, 215, 0, 0.1); border-left: 4px solid #ffd700; padding: 15px; border-radius: 4px; font-size: 0.95em; color: #fff;}
        .wiki-link { display: inline-block; margin-top: 10px; color: #bb86fc; text-decoration: none; font-weight: bold;}

        .planning-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        @media (max-width: 768px) { .planning-grid { grid-template-columns: 1fr; } }
        .fov-simulator-container { background-color: #000; height: 400px; border-radius: 8px; border: 2px solid #444; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center;}
        #aladin-lite-div { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;}
        #fov-rectangle { position: absolute; pointer-events: none; transition: width 0.1s, height 0.1s; z-index: 1000;}
        .center-cross { position: absolute; color: rgba(68, 255, 68, 0.7); font-size: 1.5em; pointer-events: none; z-index: 1000;}
        .chart-container { background-color: #1e1e1e; padding: 15px; border-radius: 8px; height: 160px; margin-top: 15px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);}
        .zoom-control { display: flex; align-items: center; justify-content: center; padding: 10px; background: #2a2a2a; border-radius: 0 0 8px 8px;}

        .session-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 768px) { .session-grid { grid-template-columns: 1fr; } }
        
        .calc-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: #222; border-radius: 5px; border-left: 3px solid #555;}
        .calc-row label { color: #fff; font-weight: bold; margin: 0; font-size: 0.9em; cursor: pointer;}
        .calc-inputs { display: flex; gap: 10px; align-items: center;}
        .calc-inputs input { width: 70px !important; padding: 5px !important; text-align: center;}
        .calc-total { width: 80px; text-align: right; color: #aaa; font-size: 0.9em;}
        .f-l { border-color: #fff !important; } .f-r { border-color: #ff4444 !important; } .f-g { border-color: #44ff44 !important; } .f-b { border-color: #4444ff !important; }
        .f-ha { border-color: #ff0055 !important; } .f-oiii { border-color: #00ffff !important; } .f-sii { border-color: #ffaa00 !important; }
        .f-dark { border-color: #555 !important; } .f-bias { border-color: #888 !important; }
        
        .time-summary { background-color: #2a2a2a; padding: 20px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center;}
        .summary-box { padding: 15px; margin-bottom: 10px; border-radius: 5px; background: #1a1a1a; border: 1px solid #333;}
        .summary-box h4 { margin: 0 0 5px 0; color: #aaa;}
        .summary-box span { font-size: 1.5em; font-weight: bold; color: #fff;}
        .text-red { color: #ff4444 !important; }
        .text-green { color: #44ff44 !important; }
        .twilight-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background-color: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;}
        .twilight-item span.icon { font-size: 1.8em; display: block; margin-bottom: 5px; }
        .twilight-item span.label { color: #aaa; font-size: 0.8em; text-transform: uppercase; }
        .twilight-item b { display: block; font-size: 1.2em; margin-top: 5px; color: #fff;}
        .twilight-night { color: #bb86fc !important; }
        
        .smart-button-container { text-align: center; margin: 15px 0 25px 0; padding: 15px; background: rgba(187, 134, 252, 0.1); border-radius: 8px; border: 1px dashed #bb86fc; }
        .btn-smart { background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); color: white; padding: 12px 30px; font-size: 1.1em; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);}
        .btn-smart:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 20px rgba(0, 114, 255, 0.5);}

        /* MODAL REPORT & TOOLTIP STYLES */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: #1e1e1e; margin: 5% auto; padding: 25px; border: 1px solid #bb86fc; border-radius: 12px; width: 90%; max-width: 600px; position: relative; color: #fff; box-shadow: 0 0 20px rgba(187,134,252,0.3); max-height: 85vh; overflow-y: auto; text-align: left;}
        .close-btn { position: absolute; right: 20px; top: 15px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #ff4444; }
        .report-section { background: #2a2a2a; border-left: 4px solid #bb86fc; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .report-section h4 { margin: 0 0 10px 0; color: #bb86fc; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px; }
        .report-line { display: flex; justify-content: space-between; border-bottom: 1px dashed #444; padding: 5px 0; font-size: 0.95em; }
        .report-line:last-child { border-bottom: none; }
        .btn-copy { background: #333; color: #fff; border: 1px solid #bb86fc; padding: 12px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; transition: 0.3s; font-size: 1em; }
        .btn-copy:hover { background: #bb86fc; color: #121212; }

        .floating-tooltip {
            position: absolute;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #bb86fc;
            border-left: 4px solid #bb86fc;
            color: #ddd;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 0.95em;
            max-width: 280px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.9);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            z-index: 10000;
            display: none;
            text-align: left;
            line-height: 1.5;
        }

        #guide-view { display: none; text-align: left; max-width: 1000px; margin: 0 auto; background-color: #1e1e1e; padding: 40px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.8); line-height: 1.7; color: #ddd; }
        .guide-section { margin-bottom: 35px; padding-bottom: 25px; border-bottom: 1px solid #333;}
        .guide-section h3 { color: #bb86fc; margin-top: 0; font-size: 1.5em; border-bottom: none;}
        .guide-section ul { margin-left: 20px; color: #bbb; }
        .guide-section li { margin-bottom: 12px; }
        .guide-section strong { color: #fff; }
        .filosofia-box { background: rgba(187,134,252,0.1); padding: 20px; border-left: 4px solid #bb86fc; border-radius: 4px; margin-bottom: 30px;}
        
        @media (max-width: 768px) {
            .main-header { display: flex !important; flex-direction: column; gap: 15px; align-items: center; justify-content: center; text-align: center; padding: 20px 15px; width: 100%; box-sizing: border-box; }
            .main-header > div { justify-self: center !important; width: 100%; display: flex; flex-direction: column; align-items: center; }
            .lang-container { align-items: center; text-align: center; }
            .author-section { flex-direction: column; align-items: center; justify-content: center; text-align: center; }
            .author-section > div { align-items: center; text-align: center; }
            .center-logo { height: 80px; }
            .search-local-input { width: 100% !important; box-sizing: border-box; }
            .search-suggestions { width: 100%; }
            .ephemeris-box { flex-direction: column; gap: 15px; text-align: center; }
            .weather-container { border: none; border-top: 1px solid #444; border-bottom: 1px solid #444; padding: 10px 0; width: 100%; }
            .times-grid { grid-template-columns: 1fr 1fr; padding-left: 0; }
            .input-group { display: flex; flex-direction: column; align-items: flex-start; }
            .input-group label { width: 100%; margin-bottom: 5px; text-align: left; }
            input[type="text"]:not(.search-local-input), input[type="number"], select, input[type="time"] { width: 100% !important; max-width: 100%; }
            .calc-row { flex-direction: column; align-items: flex-start; gap: 10px; padding-bottom: 15px; }
            .calc-total { text-align: left; width: 100%; padding-left: 10px; font-weight: bold; border-top: 1px dashed #444; padding-top: 5px; }
            .twilight-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div class="main-header">
        <div class="lang-container">
            <span style="font-size: 0.75em; color: #aaa; font-weight: bold; letter-spacing: 1px; padding-left: 5px;">LANGUAGE</span>
            <div class="lang-toggle">
                <button class="lang-btn active" id="btn-lang-it" onclick="changeLanguage('it')">
                    <svg viewBox="0 0 3 2" style="width: 18px; height: 12px; border-radius: 2px; margin-right: 6px;"><rect width="1" height="2" fill="#009246"/><rect x="1" width="1" height="2" fill="#F1F2F1"/><rect x="2" width="1" height="2" fill="#CE2B37"/></svg>ITA
                </button>
                <button class="lang-btn" id="btn-lang-en" onclick="changeLanguage('en')">
                    <svg viewBox="0 0 60 30" style="width: 18px; height: 12px; border-radius: 2px; margin-right: 6px;"><clipPath id="t"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath><path d="M0,0 v30 h60 v-30 z" fill="#012169"/><path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t)" stroke="#C8102E" stroke-width="4"/><path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/><path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/></svg>ENG
                </button>
                <button class="lang-btn" id="btn-lang-es" onclick="changeLanguage('es')">
                    <svg viewBox="0 0 750 500" style="width: 18px; height: 12px; border-radius: 2px; margin-right: 6px;"><rect width="750" height="500" fill="#c60b1e"/><rect y="125" width="750" height="250" fill="#ffc400"/></svg>ESP
                </button>
                <button class="lang-btn" id="btn-lang-zh" onclick="changeLanguage('zh')">
                    <svg viewBox="0 0 30 20" style="width: 18px; height: 12px; border-radius: 2px; margin-right: 6px;"><rect width="30" height="20" fill="#de2910"/><path d="M5,5 l-1,3.07 2.61,-1.9 -2.61,-1.9 1,3.07z" fill="#ffde00"/></svg>CHN
                </button>
            </div>
        </div>
        <div class="logo-container">
            <img src="astro_logo.png" alt="AstroDashboard Pro" class="center-logo">
        </div>
        <div class="author-section">
            <div>
                <p style="margin: 0 0 6px 0; font-size: 0.9em; color: #fff; font-weight: bold;">v5.5.0-Global</p>
                <button class="btn-guide" onclick="apriGuida()" style="margin: 0;"><span data-i18n="manual_btn">üìñ Apri Manuale</span></button>
            </div>
            <img src="logo astro enrico sfondo.png" alt="Enrico Salis Logo" style="height: 60px; object-fit: contain; border-radius: 5px;">
        </div>
    </div>

    <div id="dashboard-view">
        <div class="container" style="margin-bottom: 0;">
            <div class="ephemeris-box">
                <div class="moon-container">
                    <div id="moon-emoji" class="moon-icon">üåï</div>
                    <div id="moon-phase-name" class="moon-phase-name">Caricamento...</div>
                </div>
                <div class="weather-container">
                    <span style="font-size: 2em; margin-bottom: 5px;">üå°Ô∏è</span>
                    <span id="meteo-temp" style="font-size: 1.4em; font-weight: bold; color: #fff;">--¬∞C</span>
                    <span id="meteo-umidita" style="font-size: 0.9em; color: #44ff44;"><span data-i18n="humidity">Umidit√†</span>: --%</span>
                </div>
                <div class="times-grid">
                    <div class="time-item"><span class="icon-normal">üåÖ</span> <span data-i18n="sunrise">Alba</span> <span data-i18n="sun">Sole</span><br><span id="alba-sole">--:--</span></div>
                    <div class="time-item"><span class="icon-normal">üåá</span> <span data-i18n="sunset">Tramonto</span> <span data-i18n="sun">Sole</span><br><span id="tramonto-sole">--:--</span></div>
                    <div class="time-item"><span class="icon-normal">üåí</span> <span data-i18n="sunrise">Alba</span> <span data-i18n="moon">Luna</span><br><span id="alba-luna">--:--</span></div>
                    <div class="time-item"><span class="icon-normal">üåò</span> <span data-i18n="sunset">Tramonto</span> <span data-i18n="moon">Luna</span><br><span id="tramonto-luna">--:--</span></div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="panel">
                <h3><span data-i18n="pos_title">üìç Posizione</span> <span class="info-icon" onmouseenter="mostraTooltip(this, 'info_pos')" onmouseleave="nascondiTooltip()">‚ÑπÔ∏è</span></h3>
                <div class="input-group">
                    <label for="ricerca" data-i18n="find_place">Trova Luogo:</label>
                    <input type="text" id="ricerca" placeholder="..." data-i18n="search_place" oninput="cercaIndirizzo()">
                    <ul id="dropdown-risultati"></ul>
                </div>
                <div class="input-group"><label for="lat" data-i18n="lat">Latitudine:</label><input type="text" id="lat" readonly value="46.06200"></div>
                <div class="input-group"><label for="lon" data-i18n="lon">Longitudine:</label><input type="text" id="lon" readonly value="13.23500"></div>
            </div>

            <div class="panel">
                <h3><span data-i18n="env_data">üéõÔ∏è Dati Ambientali</span> <span class="info-icon" onmouseenter="mostraTooltip(this, 'info_env')" onmouseleave="nascondiTooltip()">‚ÑπÔ∏è</span></h3>
                <div class="meteo-grid">
                    <div class="meteo-item m-bassa active" id="btn-basse" onclick="toggleLayer('basse')"><h4 data-i18n="low_clouds">Nuvole Basse</h4><span id="val-basse">--%</span></div>
                    <div class="meteo-item m-media disabled" id="btn-medie" onclick="toggleLayer('medie')"><h4 data-i18n="mid_clouds">Nuvole Medie</h4><span id="val-medie">--%</span></div>
                    <div class="meteo-item m-alta disabled" id="btn-alte" onclick="toggleLayer('alte')"><h4 data-i18n="high_clouds">Nuvole Alte</h4><span id="val-alte">--%</span></div>
                    <div class="meteo-item m-jet disabled" id="btn-jet" onclick="toggleLayer('jet')"><h4>Jet Stream</h4><span id="val-jet">--<span class="jet-unit">km/h</span></span></div>
                    <div class="meteo-item m-luna disabled" id="btn-luna" onclick="toggleLayer('luna')"><h4 data-i18n="moon_poll">Inq. Lunare</h4><span id="val-luna">--%</span></div>
                    <div class="meteo-item m-umidita disabled" id="btn-umidita" onclick="toggleLayer('umidita')"><h4 data-i18n="humidity">Umidit√†</h4><span id="val-umidita-layer" style="color:#00ffff;">--%</span></div>
                    <div class="meteo-item m-seeing active" id="btn-seeing"><h4 data-i18n="seeing_est">Stima Seeing</h4><span id="val-seeing" style="color:#bb86fc;">--/5</span></div>
                </div>
            </div>
        </div>

        <div class="container" style="flex-direction: column;">
            <div class="timeline-container" style="position: relative;">
                <span class="info-icon" style="position: absolute; right: 15px; top: 15px; font-size: 1.2em;" onmouseenter="mostraTooltip(this, 'info_map')" onmouseleave="nascondiTooltip()">‚ÑπÔ∏è</span>
                <div id="time-display" class="time-display">Caricamento Timeline Meteo...</div>
                <input type="range" id="timeSlider" min="0" max="23" value="0" oninput="syncSliders(this.value)" disabled>
                <div style="display:flex; justify-content: space-between; font-size:0.8em; color:#aaa; padding-top: 5px;">
                    <span data-i18n="now">Adesso</span><span>+12h</span><span>+24h</span>
                </div>
            </div>
            <div id="map"></div>
        </div>

        <div class="container dso-container" style="flex-direction: column;">
            <h3><span data-i18n="hybrid_planetarium">üî≠ Planetario Predittivo Ibrido</span> <span class="info-icon" onmouseenter="mostraTooltip(this, 'info_planetarium')" onmouseleave="nascondiTooltip()">‚ÑπÔ∏è</span></h3>
            
            <div class="timeline-container" style="margin-top: 10px; margin-bottom: 20px; padding: 10px; background-color: #222;">
                <div id="astro-time-display" class="time-display" style="color: #44ff44;">Caricamento Timeline Astro...</div>
                <input type="range" id="astroSlider" min="0" max="23" value="0" oninput="syncSliders(this.value)" disabled>
            </div>

            <div class="astro-section">
                <h4 style="color: #ffaa00; margin-bottom: 0; margin-top: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;" data-i18n="solar_system">ü™ê Sistema Solare</h4>
                <div class="horizontal-scroll" id="planets-list"></div>
            </div>

            <div class="astro-section" style="margin-top: 15px; margin-bottom: 25px;">
                <h4 style="color: #bb86fc; margin-bottom: 0; margin-top: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;" data-i18n="rec_targets">üåå Oggetti Consigliati</h4>
                <div class="horizontal-scroll" id="dso-list"></div>
            </div>

            <div class="search-local-box">
                <h4><span data-i18n="free_search">üîç Ricerca Libera Oggetto</span> <span class="info-icon" onmouseenter="mostraTooltip(this, 'info_search')" onmouseleave="nascondiTooltip()">‚ÑπÔ∏è</span></h4>
                <div style="display: flex; justify-content: center; align-items: flex-start; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                    <div class="search-wrapper">
                        <input type="text" id="search-dash-input" class="search-local-input" placeholder="..." data-i18n="search_target" autocomplete="off">
                        <ul id="sugg-dash" class="search-suggestions"></ul>
                    </div>
                    <button class="btn-search" onclick="eseguiRicerca('search-dash-input')" data-i18n="plan_target_btn">Pianifica üöÄ</button>
                </div>
                <p id="status-search-dash-input" class="search-status"></p>
            </div>
        </div>
    </div>

    <div id="planning-view">
        <div class="planning-header-row">
            <button class="btn-back" onclick="tornaDashboard()" data-i18n="back_dash">Torna alla Dashboard</button>
            <div class="search-wrapper" style="margin-bottom: 30px;">
                <div style="display: flex; align-items: center;">
                    <input type="text" id="search-plan-input" class="search-local-input" placeholder="..." autocomplete="off">
                    <button class="btn-search" onclick="eseguiRicerca('search-plan-input')" data-i18n="change_target">Cambia</button>
                </div>
                <ul id="sugg-plan" class="search-suggestions"></ul>
                <p id="status-search-plan-input" class="search-status" style="position:absolute; top:100%; left:0; text-align: left;"></p>
            </div>
        </div>
        
        <h2 id="plan-target-name">Nome Oggetto</h2>
        
        <div class="panel" style="margin-bottom: 20px;">
            <h3 style="margin-top:0;" data-i18n="dossier">üìñ Dossier Astrofotografico</h3>
            <div class="stat-grid">
                <div class="stat-box t-type"><span data-i18n="type">Tipologia</span><b id="stat-type">--</b></div>
                <div class="stat-box t-mag"><span data-i18n="app_mag">Magnitudine App.</span><b id="stat-mag">--</b></div>
                <div class="stat-box t-dist"><span data-i18n="distance">Distanza</span><b id="stat-dist">--</b></div>
            </div>
            <div class="info-box"><span id="target-description">Caricamento...</span><br><a href="#" id="target-wiki" class="wiki-link" target="_blank" data-i18n="wiki_link">üîó Wikipedia</a></div>
            <div class="tip-box"><b data-i18n="tactical_tip">üí° Consiglio Tattico:</b> <span id="target-tips">--</span></div>
        </div>

        <div class="planning-grid">
            <div class="panel">
                <h3><span data-i18n="optical_setup">üì∏ Setup Ottico</span> <span class="info-icon" onmouseenter="mostraTooltip(this, 'info_setup')" onmouseleave="nascondiTooltip()">‚ÑπÔ∏è</span></h3>
                <div class="input-group">
                    <label data-i18n="telescope">Telescopio:</label>
                    <select id="preset-telescope" onchange="applicaPresetTelescopio()">
                        <option value="" data-i18n="select_opt">-- Seleziona --</option>
                    </select>
                </div>
                <div class="input-group">
                    <label data-i18n="focal_len">Focale (mm):</label>
                    <input type="number" id="focal-length" value="400" oninput="aggiornaFOV()">
                </div>
                <hr style="border: 1px solid #333; margin: 15px 0;">
                <div class="input-group">
                    <label data-i18n="sensor">Sensore:</label>
                    <select id="preset-sensor" onchange="applicaPresetSensore()">
                        <option value="" data-i18n="select_opt">-- Seleziona --</option>
                    </select>
                </div>
                <div class="input-group"><label data-i18n="width">Larg. W (mm):</label><input type="number" id="sensor-width" value="23.5" step="0.1" oninput="aggiornaFOV()"></div>
                <div class="input-group"><label data-i18n="height">Alet. H (mm):</label><input type="number" id="sensor-height" value="15.7" step="0.1" oninput="aggiornaFOV()"></div>
                
                <div style="margin-top: 15px; padding: 15px; background-color: #222; border-radius: 8px; border: 1px solid #444;">
                    <div class="input-group" style="margin-bottom: 5px; display: flex; align-items: center;">
                        <label data-i18n="mode" style="width: auto; margin-right:10px; font-weight: bold; color: #bb86fc;">Modalit√†:</label>
                        <select id="capture-mode" onchange="toggleMosaic()" style="flex: 1; padding: 6px; font-size: 0.95em; background: #1a1a1a; cursor: pointer;">
                            <option value="single" data-i18n="single_panel">Scatto Singolo</option>
                            <option value="mosaic" data-i18n="mosaic">Mosaico</option>
                        </select>
                    </div>
                    <div id="mosaic-settings" style="display: none; flex-direction: column; gap: 10px; margin-top: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <label data-i18n="panels" style="width: auto; margin:0;">Pannelli (X, Y):</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="number" id="mosaic-x" value="2" min="1" max="10" oninput="aggiornaFOV(); calcolaTempi();" style="width: 50px !important; padding: 4px !important; text-align: center;"> x 
                                <input type="number" id="mosaic-y" value="2" min="1" max="10" oninput="aggiornaFOV(); calcolaTempi();" style="width: 50px !important; padding: 4px !important; text-align: center;">
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <label data-i18n="overlap" style="width: auto; margin:0;">Sovrapposizione:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="number" id="mosaic-overlap" value="20" min="5" max="50" step="5" oninput="aggiornaFOV()" style="width: 60px !important; padding: 4px !important; text-align: center;"> %
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 25px; padding: 15px; background-color: #2a2a2a; border-radius: 8px; text-align: center;">
                    <h4 style="margin:0 0 5px 0; color:#aaa;" data-i18n="fov_calc">Campo Inquadrato Calcolato</h4>
                    <p id="fov-result" style="font-weight: bold; color: #44ff44; font-size: 1.4em; margin: 0;">--¬∞ x --¬∞</p>
                    <p id="mosaic-fov-result" style="margin: 5px 0 0 0; font-size: 1em; color: #bb86fc; font-weight: bold; display: none;">Totale: --¬∞ x --¬∞</p>
                    <p id="fov-warning-msg" style="color: #ffaa00; font-size: 0.85em; margin-top: 10px; display: none; font-weight: bold;" data-i18n="fov_warning">‚ö†Ô∏è L'oggetto √® pi√π grande del tuo campo inquadrato! Valuta un mosaico.</p>
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column;">
                <div class="panel" style="padding:0; overflow:hidden;">
                    <h3 style="padding: 15px 20px 0 20px;" data-i18n="fov_sim">üìê Simulatore FOV Realistico (DSS2)</h3>
                    <div class="fov-simulator-container" id="fov-simulator-container">
                        <div id="aladin-lite-div"></div>
                        <div class="center-cross">+</div>
                        <div id="fov-rectangle"></div>
                    </div>
                    <div class="zoom-control">
                        <span style="font-size: 1.2em; margin-right: 10px;">‚ûñ</span>
                        <input type="range" id="fov-zoom" min="20" max="500" value="100" style="width: 60%; margin: 0;" oninput="aggiornaFOV()">
                        <span style="font-size: 1.2em; margin-left: 10px;">‚ûï</span>
                    </div>
                </div>
                <div class="chart-container"><canvas id="altitudeChart"></canvas></div>
            </div>
        </div>

        <h2 id="calc-title" style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;"><span data-i18n="smart_calc">‚è±Ô∏è Calcolatore Sessione Smart AI</span> <span class="info-icon" onmouseenter="mostraTooltip(this, 'info_smart')" onmouseleave="nascondiTooltip()">‚ÑπÔ∏è</span></h2>
        
        <div class="twilight-grid">
            <div class="twilight-item"><span class="icon">üåá</span><span class="label" data-i18n="sunset">Tramonto</span><b id="info-sunset">--:--</b></div>
            <div class="twilight-item"><span class="icon">‚ú®</span><span class="label" data-i18n="night_start">Inizio Notte Astr.</span><b id="info-nightstart" class="twilight-night">--:--</b></div>
            <div class="twilight-item"><span class="icon">üî≠</span><span class="label" data-i18n="night_end">Fine Notte Astr.</span><b id="info-nightend" class="twilight-night">--:--</b></div>
            <div class="twilight-item"><span class="icon">üåÖ</span><span class="label" data-i18n="sunrise">Alba</span><b id="info-sunrise">--:--</b></div>
        </div>
        
        <div class="panel" style="margin-bottom: 20px; text-align: center; display: flex; justify-content: space-around; flex-wrap: wrap;">
            <div class="input-group" style="margin: 0;"><label style="width: auto; margin-right: 10px; color:#fff;" data-i18n="session_start">Inizio Sessione:</label><input type="time" id="time-start" onchange="calcolaTempi()"></div>
            <div class="input-group" style="margin: 0;"><label style="width: auto; margin-right: 10px; color:#fff;" data-i18n="session_end">Fine Sessione:</label><input type="time" id="time-end" onchange="calcolaTempi()"></div>
            <div class="input-group" style="margin: 0;">
                <label style="width: auto; margin-right: 10px; color:#bb86fc;" data-i18n="sensor_type">Tipo Sensore:</label>
                <select id="sensor-type" onchange="toggleSensorMode(); calcolaTempi();" style="border-color: #bb86fc; width: auto !important;">
                    <option value="color">OSC (Color)</option>
                    <option value="mono">Mono</option>
                </select>
            </div>
        </div>

        <div class="session-grid">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                    <h3 style="margin: 0;"><span data-i18n="seq_setup">Impostazione Sequenza</span></h3>
                    <span id="mosaic-total-badge" style="display:none; background: #bb86fc; color: #121212; padding: 4px 10px; border-radius: 4px; font-size: 0.9em; font-weight: bold;"></span>
                </div>
                
                <div class="smart-button-container">
                    <button class="btn-smart" onclick="generaSequenzaOttimale()" data-i18n="gen_seq_btn">‚ú® Genera Sequenza Ottimale</button>
                </div>

                <div style="display:flex; justify-content: space-between; margin-bottom: 10px; padding:0 10px; font-size:0.8em; color:#aaa;">
                    <span style="width:140px;" data-i18n="use_frame">Usa | Frame</span>
                    <span data-i18n="poses_sec">Pose x Sec.</span>
                    <span style="width:80px; text-align:right;" data-i18n="total">Totale</span>
                </div>
                
                <div id="frames-container"></div>

                <div class="calc-row" style="border-left-color: #ffaa00; margin-top: 10px; background: #2a2a2a;">
                    <div style="display:flex; align-items:center; width: 140px;">
                        <input type="checkbox" id="dither-check" checked style="margin-right:10px; transform: scale(1.2); cursor: pointer;" onchange="calcolaTempi()">
                        <label style="cursor: pointer; color: #ffaa00;" onclick="document.getElementById('dither-check').click()">Dither</label>
                        <span class="info-icon" style="margin-left: 8px; color: #ffaa00; font-size: 1.1em;" onmouseenter="mostraTooltip(this, 'info_dither')" onmouseleave="nascondiTooltip()">‚ÑπÔ∏è</span>
                    </div>
                    <div class="calc-inputs" style="font-size: 0.85em; color: #aaa; display: flex; align-items: center; gap: 6px;">
                        <span data-i18n="every">Ogni</span> <input type="number" id="dither-freq" value="3" min="1" oninput="calcolaTempi()" style="width: 45px !important; padding: 5px !important; text-align: center;">
                        t <input type="number" id="dither-duration" value="15" min="0" oninput="calcolaTempi()" style="width: 45px !important; padding: 5px !important; text-align: center;"> s
                    </div>
                    <div class="calc-total" id="dither-tot" style="color: #ffaa00;">0m</div>
                </div>
            </div>

            <div class="time-summary">
                <div class="summary-box"><h4 data-i18n="avail_window">Finestra Disponibile</h4><span id="calc-available">--h --m</span></div>
                <div class="summary-box"><h4 data-i18n="acq_time">Tempo Acquisizione</h4><span id="calc-total" style="color: #bb86fc;">--h --m</span></div>
                <div class="summary-box" style="border-color: #444; background-color: #222;">
                    <h4 data-i18n="res_time">Tempo Residuo</h4><span id="calc-residual" class="text-green">--h --m</span>
                    <p id="calc-warning" style="margin: 5px 0 0 0; font-size: 0.85em; display: none;" class="text-red" data-i18n="time_overflow">‚ö†Ô∏è Sforamento tempo!</p>
                </div>
            </div>
        </div>

        <div class="panel" style="margin-top: 20px; border: 1px solid #bb86fc; background: linear-gradient(180deg, #1a1a1a 0%, #121212 100%);">
            <h3><span style="color: #bb86fc;" data-i18n="nina_export_title">üöÄ Esportazione N.I.N.A. Advanced Sequencer</span> <span class="info-icon" onmouseenter="mostraTooltip(this, 'info_nina')" onmouseleave="nascondiTooltip()">‚ÑπÔ∏è</span></h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: #222; padding: 15px; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: #fff;" data-i18n="seq_start">Avvio Sequenza</h4>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-cool" checked style="transform: scale(1.2);"> <span data-i18n="cool_cam">Raffredda Camera a</span> <input type="number" id="nina-temp" value="-10" style="width: 60px!important; padding: 4px!important;"> ¬∞C
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-slew" checked style="transform: scale(1.2);"> <span data-i18n="slew_center">Slew & Center (Plate Solve)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-guide" checked style="transform: scale(1.2);"> <span data-i18n="start_guide">Avvia Autoguida</span>
                    </label>
                </div>
                <div style="background: #222; padding: 15px; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: #fff;" data-i18n="end_sec">Fine / Sicurezza</h4>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-warm" checked style="transform: scale(1.2);"> <span data-i18n="warm_cam">Riscalda Camera (Warm Up)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-park" checked style="transform: scale(1.2);"> <span data-i18n="park_mount">Parcheggia Montatura</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-flip" checked style="transform: scale(1.2);"> <span data-i18n="meridian_flip">Attiva Meridian Flip</span>
                    </label>
                </div>
                <div style="background: #222; padding: 15px; border-radius: 8px; grid-column: 1 / -1;">
                    <h4 style="margin: 0 0 5px 0; color: #fff;"><span data-i18n="filter_map">Mappatura Nomi Filtri</span></h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;" id="nina-filters-container">
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button id="btn-export-nina" class="btn-smart" style="background: linear-gradient(135deg, #ff4444 0%, #aa0000 100%); box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);" onclick="esportaNINA()" data-i18n="gen_nina_btn">üíæ Genera File per N.I.N.A.</button>
                <button id="btn-report-mosaic" class="btn-smart" style="display: none; background: linear-gradient(135deg, #7c4dff 0%, #3f51b5 100%); box-shadow: 0 4px 15px rgba(124, 77, 255, 0.3);" onclick="apriReport()" data-i18n="gen_report_btn">üìù Genera Report Strategico</button>
                <p id="nina-mosaic-msg" style="display: none; color: #ffaa00; font-size: 0.9em; text-align: justify; line-height: 1.5; margin-top: 15px; padding: 15px; background: rgba(255, 170, 0, 0.1); border-left: 3px solid #ffaa00; border-radius: 4px;" data-i18n="nina_mosaic_msg">üìå Modalit√† Mosaico attiva. Usa il Framing Assistant di N.I.N.A. per le coordinate.</p>
            </div>
        </div>
    </div>

    <div id="floating-tooltip" class="floating-tooltip"></div>

    <div id="report-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="chiudiReport()">&times;</span>
            <h2 style="color: #bb86fc; margin-top:0; border-bottom: none; display: flex; align-items: center; gap: 10px;"><span data-i18n="report_title">Dossier Mosaico</span></h2>
            <div id="report-content"></div>
            <button class="btn-copy" onclick="copiaReport()" id="btn-copy-report"><span data-i18n="copy_report">üìã Copia negli Appunti</span></button>
        </div>
    </div>

    <div id="guide-view">
        <button class="btn-back" style="margin-bottom: 40px;" onclick="chiudiGuida()" data-i18n="back_dash">Torna Indietro</button>
        
        <div id="guide-it">
            <h2 style="font-size: 2.4em; border-bottom: 2px solid #bb86fc; padding-bottom: 15px; margin-bottom: 30px;">üìñ Manuale AstroDashboard PRO</h2>
            <div class="filosofia-box"><h3 style="color: #fff; margin-top:0;">La Filosofia del Software</h3><p>AstroDashboard √® progettata per essere il "Direttore d'Orchestra" della tua strumentazione. Fonde dati ambientali, calcoli trigonometrici e intelligenza artificiale per eliminare i tempi morti e ottimizzare ogni singolo secondo della tua notte sotto le stelle.</p></div>
            <div class="guide-section"><h3>üåç 1. Dati Ambientali e Meteo Tattico</h3><ul><li><strong>Mappa a Raggio (50 Km):</strong> Pensata per gli astrofotografi itineranti. Il cerchio ti permette di valutare rapidamente dove spostarti per trovare "buchi di sereno" se la tua zona √® coperta.</li><li><strong>Jet Stream:</strong> Il vero nemico del Seeing. Un valore inferiore a 50 km/h garantisce cieli stabili. Oltre i 100 km/h la turbolenza devaster√† i dettagli.</li><li><strong>Allarme Umidit√†:</strong> Se supera l'85% (rosso), accendi le fasce anticondensa al massimo della potenza prima che l'ottica si appanni.</li></ul></div>
            <div class="guide-section"><h3>üî≠ 2. Planetario Ibrido e Motore SIMBAD</h3><ul><li><strong>Database Locale (Consigliati):</strong> Memoria di target celebri. Cliccandoli riceverai "Consigli Tattici" specifici (es. filtri raccomandati).</li><li><strong>Ricerca Universale (SIMBAD):</strong> Inserendo il nome di un oggetto esotico (es. NGC o IC rari), l'AI si collegher√† in tempo reale all'Universit√† di Strasburgo per estrarne le coordinate assolute.</li></ul></div>
            <div class="guide-section"><h3>üì∏ 3. Setup Ottico e Pianificazione Mosaici</h3><ul><li><strong>Simulatore FOV:</strong> Inserisci i parametri del tuo telescopio e sensore. La mappa si adatter√† istantaneamente per mostrarti l'inquadratura millimetrica.</li><li><strong>Motore Mosaici:</strong> Se il target scelto √® pi√π grande del tuo sensore, scatta un allarme visivo (‚ö†Ô∏è). Attivando la modalit√† <strong>Mosaico</strong> e impostando la griglia (es. 2x2), vedrai i pannelli sovrapposti direttamente sulla mappa stellare.</li></ul></div>
            <div class="guide-section"><h3>‚ú® 4. Calcolatore Sessione Smart AI</h3><ul><li><strong>Ripartizione Intelligente:</strong> L'AI analizza la tua "finestra di buio" e la riempie con esposizioni ottimali in base al tipo di oggetto e al sensore.</li><li><strong>Calcolo Mosaici:</strong> In modalit√† mosaico, l'AI √® istruita per dividere il tempo notturno totale per il numero di pannelli.</li><li><strong>Dithering:</strong> Inserendo la frequenza di dithering e i secondi di riassestamento, l'AI sottrae questo "tempo fantasma" dal totale, garantendo calcoli precisi.</li></ul></div>
            <div class="guide-section"><h3>ü§ñ 5. Esportazione N.I.N.A. e Dossier</h3><ul><li><strong>Export JSON (Scatto Singolo):</strong> Genera un file di sequenza perfetto. Trascinalo nell' "Advanced Sequencer" di N.I.N.A. per avviare la sessione in totale autonomia. <em>‚ö†Ô∏è I nomi dei filtri nella Dashboard devono essere identici a quelli impostati su N.I.N.A.</em></li><li><strong>Report Strategico (Mosaici):</strong> In modalit√† Mosaico, la Dashboard disabilita l'export JSON e genera un <strong>Dossier Strategico</strong>. Copialo, usa il Framing di N.I.N.A. per le coordinate rotazionali, e applica i tempi di posa che l'AI ha calcolato per te.</li></ul></div>
        </div>

        <div id="guide-en" style="display:none;">
            <h2 style="font-size: 2.4em; border-bottom: 2px solid #bb86fc; padding-bottom: 15px; margin-bottom: 30px;">üìñ AstroDashboard PRO Manual</h2>
            <div class="filosofia-box"><h3 style="color: #fff; margin-top:0;">Project Philosophy</h3><p>AstroDashboard is designed to be the "Conductor" of your astrophotography setup. It merges environmental data, math, and AI to optimize your night.</p></div>
            <div class="guide-section"><h3>üåç 1. Tactical Weather Data</h3><ul><li><strong>50km Radius Map:</strong> Crucial for mobile astrophotographers to spot "clear sky holes" in real-time.</li><li><strong>Jet Stream:</strong> The true enemy of Seeing. Below 50 km/h means stable skies. Above 100 km/h: avoid long focal lengths.</li><li><strong>Humidity Alarm:</strong> If it turns red (>85%), max out your dew heaters immediately to prevent fogging.</li></ul></div>
            <div class="guide-section"><h3>üî≠ 2. Planetarium & SIMBAD Engine</h3><ul><li><strong>Local DB:</strong> Famous targets come with specific "Tactical Tips" (e.g., core saturation warnings).</li><li><strong>SIMBAD Engine:</strong> Search for exotic objects and the AI fetches absolute coordinates from the University of Strasbourg.</li></ul></div>
            <div class="guide-section"><h3>üì∏ 3. FOV Simulator & Mosaics</h3><ul><li><strong>Field of View:</strong> Real-time DSS2 framing based on your specific optical tube and sensor geometry.</li><li><strong>Mosaic Engine:</strong> If the target is too large, a warning (‚ö†Ô∏è) triggers. Switch to "Mosaic" mode to visualize overlapping panels directly on the star map.</li></ul></div>
            <div class="guide-section"><h3>‚ú® 4. Smart AI & Dithering</h3><ul><li><strong>Smart Allocation:</strong> AI calculates your dark window and fills it with optimal subs. For Mono cameras, it automatically balances LRGB times.</li><li><strong>Mosaic Math:</strong> The AI intelligently splits your total night time by the number of panels.</li><li><strong>Dithering:</strong> Input settling seconds. The AI subtracts this "ghost time" from your available night window for frame-perfect calculations.</li></ul></div>
            <div class="guide-section"><h3>ü§ñ 5. N.I.N.A. Export & Strategic Dossier</h3><ul><li><strong>JSON Export (Single Panel):</strong> Generates a fully automated sequence. Drag it into N.I.N.A.'s Advanced Sequencer. <em>‚ö†Ô∏è Filter names must match your N.I.N.A. config exactly.</em></li><li><strong>Strategic Report (Mosaics):</strong> The Dashboard generates a text <strong>Dossier</strong>: use it to manually input the AI-calculated exposures for each N.I.N.A. panel.</li></ul></div>
        </div>

        <div id="guide-es" style="display:none;">
            <h2 style="font-size: 2.4em; border-bottom: 2px solid #bb86fc; padding-bottom: 15px; margin-bottom: 30px;">üìñ Manual AstroDashboard PRO</h2>
            <div class="filosofia-box"><h3 style="color: #fff; margin-top:0;">Filosof√≠a</h3><p>Una plataforma dise√±ada para ser el "Director de Orquesta" de tu equipo, fusionando datos y matem√°ticas para optimizar cada segundo de tu noche bajo las estrellas.</p></div>
            <div class="guide-section"><h3>üåç 1. Clima T√°ctico</h3><ul><li><strong>Mapa 50km:</strong> Ideal para fot√≥grafos itinerantes para encontrar "claros en las nubes".</li><li><strong>Jet Stream:</strong> < 50 km/h indica cielos estables. > 100 km/h: turbulencia extrema, evita focales largas.</li><li><strong>Humedad:</strong> Si se pone rojo (>85%), enciende las cintas calentadoras al m√°ximo.</li></ul></div>
            <div class="guide-section"><h3>üî≠ 2. Planetario y SIMBAD</h3><ul><li><strong>Motor SIMBAD:</strong> Busca objetos raros y la IA descargar√° las coordenadas precisas de la Universidad de Estrasburgo.</li></ul></div>
            <div class="guide-section"><h3>üì∏ 3. FOV y Mosaicos</h3><ul><li><strong>Alarma FOV:</strong> Si el objeto no cabe en tu sensor, sonar√° una alarma. Usa el Modo Mosaico para ver la cuadr√≠cula de paneles superpuestos.</li></ul></div>
            <div class="guide-section"><h3>‚ú® 4. IA Smart y Dithering</h3><ul><li><strong>Tiempo Dividido:</strong> La IA divide tus horas de oscuridad entre el n√∫mero de paneles del mosaico y resta el tiempo de estabilizaci√≥n de la montura.</li></ul></div>
            <div class="guide-section"><h3>ü§ñ 5. Exportaci√≥n a N.I.N.A.</h3><ul><li><strong>JSON (Panel √önico):</strong> Arr√°stralo al Secuenciador Avanzado para automatizar toda la sesi√≥n.</li><li><strong>Dosier Estrat√©gico (Mosaicos):</strong> La app genera un reporte para que copies los tiempos de exposici√≥n perfectos en el software NINA.</li></ul></div>
        </div>

        <div id="guide-zh" style="display:none;">
            <h2 style="font-size: 2.4em; border-bottom: 2px solid #bb86fc; padding-bottom: 15px; margin-bottom: 30px;">üìñ AstroDashboard PRO Áî®Êà∑ÊâãÂÜå</h2>
            <div class="filosofia-box"><h3 style="color: #fff; margin-top:0;">ËÆæËÆ°ÁêÜÂøµ</h3><p>Â∞ÜÂ§öÁßçËßÑÂàíÂ∑•ÂÖ∑ËûçÂêà‰∏∫‰∏Ä‰∏™Êô∫ËÉΩÂπ≥Âè∞ÔºåÂÖÖÂΩìÊÇ®Â§©ÊñáËÆæÂ§áÁöÑ‚ÄúÊåáÊå•ÂÆ∂‚ÄùÔºå‰ºòÂåñÊÇ®Âú®ÊòüÁ©∫‰∏ãÁöÑÊØè‰∏ÄÁßí„ÄÇ</p></div>
            <div class="guide-section"><h3>üåç 1. ÊàòÊúØÂ§©Ê∞î‰∏éÁéØÂ¢ÉÊï∞ÊçÆ</h3><ul><li><strong>50ÂÖ¨ÈáåÈõ∑ËææÂú∞Âõæ:</strong> Â∏ÆÂä©ÁßªÂä®ÊëÑÂΩ±Â∏àÂú®‰∫ëÂ±Ç‰∏ãÂØªÊâæ‚ÄúÊô¥Á©∫Ê¥û‚Äù„ÄÇ</li><li><strong>ÊÄ•ÊµÅ (Jet Stream):</strong> ËßÜÂÆÅÂ∫¶ÁöÑÊïå‰∫∫„ÄÇ‰Ωé‰∫é 50 km/h ÊÑèÂë≥ÁùÄÂ§©Á©∫Á®≥ÂÆö„ÄÇÈ´ò‰∫é 100 km/h ËØ∑ÈÅøÂÖç‰ΩøÁî®ÈïøÁÑ¶ÊÆµ„ÄÇ</li><li><strong>ÊπøÂ∫¶Ë≠¶Êä•:</strong> Êï∞ÂÄºÂèòÁ∫¢ (>85%) Êó∂ÔºåËØ∑Á´ãÂç≥Â∞ÜÈô§Èú≤Â∏¶ÂºÄÂà∞ÊúÄÂ§ß„ÄÇ</li></ul></div>
            <div class="guide-section"><h3>üî≠ 2. Ê∑∑ÂêàÊòüÂõæ‰∏é SIMBAD</h3><ul><li><strong>SIMBAD ÂºïÊìé:</strong> ÊêúÁ¥¢ÂÜ∑Èó®ÁõÆÊ†áÊó∂ÔºåAI ‰ºöËá™Âä®ËøûÊé•ÊñØÁâπÊãâÊñØÂ†°Â§ßÂ≠¶Ëé∑ÂèñÁªùÂØπÂùêÊ†á„ÄÇ</li></ul></div>
            <div class="guide-section"><h3>üì∏ 3. ËßÜÂú∫ (FOV) ‰∏é ÊãºÊé•</h3><ul><li><strong>ÊãºÊé•ËßÑÂàí:</strong> Â¶ÇÊûúÁõÆÊ†áÂ§ß‰∫éÊÇ®ÁöÑ‰º†ÊÑüÂô®ÔºåÁ≥ªÁªü‰ºöÂèëÂá∫Ë≠¶Âëä„ÄÇÂºÄÂêØÊãºÊé•Ê®°ÂºèÔºåÂú∞ÂõæÂ∞ÜÂÆûÊó∂ÁªòÂà∂ÈáçÂè†ÁöÑÈù¢ÊùøÁΩëÊ†º„ÄÇ</li></ul></div>
            <div class="guide-section"><h3>‚ú® 4. Êô∫ËÉΩ AI ‰∏é ÊäñÂä®</h3><ul><li><strong>Êó∂Èó¥ÂàÜÈÖç:</strong> AI Ëá™Âä®Â∞ÜÈªëÂ§úÊó∂Èó¥Èô§‰ª•Èù¢ÊùøÊï∞ÈáèÔºåÂπ∂Êâ£Èô§Ëµ§ÈÅì‰ª™ÊäñÂä®Á®≥ÂÆöÁöÑ‚ÄúÈöêÂΩ¢ËÄóÊó∂‚Äù„ÄÇ</li></ul></div>
            <div class="guide-section"><h3>ü§ñ 5. N.I.N.A. ÂØºÂá∫‰∏éÊàòÊúØÊä•Âëä</h3><ul><li><strong>JSON ÂØºÂá∫ (ÂçïÁõÆÊ†á):</strong> ÊãñÂÖ•È´òÁ∫ßÂ∫èÂàóÂô®ÂÆûÁé∞ÂÖ®Ëá™Âä®ÊãçÊëÑ (ÈúÄÁ°Æ‰øùÊª§ÈïúÂêçÁß∞ÂåπÈÖç)„ÄÇ</li><li><strong>ÊàòÊúØÊä•Âëä (ÊãºÊé•Ê®°Âºè):</strong> Á≥ªÁªü‰ºöÁîüÊàêÁ≠ñÁï•Êä•ÂëäÔºå‰æõÊÇ®Â§çÂà∂ AI ËÆ°ÁÆóÂá∫ÁöÑÂÆåÁæéÊõùÂÖâÊó∂Èó¥Âà∞ÊûÑÂõæÂä©Êâã‰∏≠„ÄÇ</li></ul></div>
        </div>
    </div>
<script>
        // --- MOTORE MULTI-LINGUA (i18n) ---
        const i18n = {
            it: {
                "manual_btn": "üìñ Apri Manuale", "pos_title": "üìç Posizione", "find_place": "Trova Luogo:", "search_place": "Es. Monte Lussari...",
                "lat": "Latitudine:", "lon": "Longitudine:", "env_data": "üéõÔ∏è Dati Ambientali",
                "low_clouds": "Nuvole Basse", "mid_clouds": "Nuvole Medie", "high_clouds": "Nuvole Alte", "moon_poll": "Inq. Lunare",
                "humidity": "Umidit√†", "seeing_est": "Stima Seeing", "now": "Adesso",
                "hybrid_planetarium": "üî≠ Planetario Predittivo Ibrido", "solar_system": "ü™ê Sistema Solare",
                "rec_targets": "üåå Oggetti Consigliati Visibili", "free_search": "üîç Ricerca Libera Oggetto", "search_target": "Es. M31, Pleiadi...",
                "plan_target_btn": "Pianifica üöÄ", "back_dash": "Torna alla Dashboard", "change_target": "Cambia",
                "dossier": "üìñ Dossier Astrofotografico", "type": "Tipologia", "app_mag": "Magnitudine App.", "distance": "Distanza", "wiki_link": "üîó Wikipedia",
                "tactical_tip": "üí° Consiglio Tattico:", "optical_setup": "üì∏ Setup Ottico", "telescope": "Telescopio:", "focal_len": "Focale (mm):",
                "sensor": "Sensore:", "width": "Larg. W (mm):", "height": "Alet. H (mm):", "fov_calc": "Campo Inquadrato Calcolato",
                "fov_sim": "üìê Simulatore FOV Realistico (DSS2)", "smart_calc": "‚è±Ô∏è Calcolatore Sessione Smart AI",
                "sunset": "Tramonto", "night_start": "Inizio Notte Astr.", "night_end": "Fine Notte Astr.", "sunrise": "Alba",
                "session_start": "Inizio Sessione:", "session_end": "Fine Sessione:", "sensor_type": "Tipo Sensore:",
                "seq_setup": "Impostazione Sequenza", "gen_seq_btn": "‚ú® Genera Sequenza Ottimale", "use_frame": "Usa | Frame", "poses_sec": "Pose x Sec.",
                "total": "Totale", "every": "Ogni", "avail_window": "Finestra Disponibile", "acq_time": "Tempo Acquisizione", "res_time": "Tempo Residuo", "time_overflow": "‚ö†Ô∏è Sforamento tempo!",
                "nina_export_title": "üöÄ Esportazione N.I.N.A. Advanced Sequencer", "seq_start": "Avvio Sequenza", "cool_cam": "Raffredda Camera a",
                "slew_center": "Slew & Center (Plate Solve)", "start_guide": "Avvia Autoguida", "end_sec": "Fine / Sicurezza", "warm_cam": "Riscalda Camera (Warm Up)",
                "park_mount": "Parcheggia Montatura", "meridian_flip": "Attiva Meridian Flip", "filter_map": "Mappatura Nomi Filtri", "gen_nina_btn": "üíæ Genera File per N.I.N.A.",
                "clear": "Sereno", "partly_cloudy": "Poco Nuvoloso", "mostly_cloudy": "Nubi Sparse", "overcast": "Coperto", "daytime": "Giorno",
                "new_moon": "Luna Nuova", "waxing_crescent": "Falce Crescente", "first_quarter": "Primo Quarto", "waxing_gibbous": "Gibbosa Crescente", "full_moon": "Luna Piena", "waning_gibbous": "Gibbosa Calante", "last_quarter": "Ultimo Quarto", "waning_crescent": "Falce Calante",
                "galaxy": "Galassia", "nebula": "Nebulosa", "cluster": "Ammasso", "star": "Stella", "unknown": "Sconosciuta",
                "alert_planetarium": "Scegli prima un bersaglio dal Planetario üî≠!", "alert_noseq": "Nessuna posa calcolata! Clicca prima su 'Genera Sequenza Ottimale'.",
                "alert_calib": "I frame di calibrazione occupano tutto il tempo!", "alert_nolight": "Seleziona almeno un filtro Light.", "alert_times": "Imposta prima gli orari di Inizio e Fine.", "no_target": "Nessun oggetto visibile.", "too_bright": "‚òÄÔ∏è Cielo troppo luminoso.", "dso_too_bright": "‚òÄÔ∏è Cielo troppo luminoso per il Deep Sky.", "select_opt": "-- Seleziona --",
                "jupiter": "Giove", "mars": "Marte", "venus": "Venere", "moon": "Luna", "sun": "Sole", "weather": "Meteo",
                "mode": "Modalit√†:", "single_panel": "Scatto Singolo", "mosaic": "Mosaico", "panels": "Pannelli (X, Y):", "overlap": "Sovrapposizione:", "time_per_panel": "Tempo per Pannello", "fov_warning": "‚ö†Ô∏è L'oggetto √® pi√π grande del campo! Valuta un mosaico.", "nina_mosaic_msg": "üìå Modalit√† Mosaico attiva. Usa il Framing Assistant di N.I.N.A. per le coordinate.",
                "gen_report_btn": "üìù Genera Report Strategico", "report_title": "Dossier Mosaico", "copy_report": "Copia negli Appunti", "copied": "Copiato!", "report_general": "Info Generali Mosaico", "report_strategy": "Strategia Singolo Pannello", "report_plan": "Piano di Scatto (Per Pannello)",
                
                "info_pos": "Cerca un luogo o inserisci coordinate. La mappa mostra un raggio di 50km utile per trovare 'buchi di sereno' spostandoti.",
                "info_env": "Dati meteo professionali estratti dal satellite in tempo reale.",
                "info_planetarium": "Mostra i target visibili calcolando l'altezza sull'orizzonte. Sposta lo slider per simulare la volta celeste stanotte.",
                "info_search": "Cerca un oggetto non in lista. L'AI interrogher√† l'universit√† di Strasburgo (SIMBAD) per scaricare le coordinate assolute.",
                "info_setup": "Inquadra il bersaglio sulla mappa. Se √® troppo grande, attiva la modalit√† 'Mosaico' per far dividere automaticamente all'AI i tempi notturni.",
                "info_smart": "L'AI riempie il tuo buio notturno generando pose ottimali per cluster, galassie o nebulose, calcolando anche le calibrazioni per sensori Mono.",
                "info_dither": "Muove leggermente la montatura tra uno scatto e l'altro per ridurre il rumore. L'AI sottrarr√† i secondi persi dal totale disponibile.",
                "info_nina": "Salva un file JSON perfetto. Trascinalo dentro N.I.N.A. (Advanced Sequencer) e la sessione partir√† in autonomia totale."
            },
            en: {
                "manual_btn": "üìñ Open Manual", "pos_title": "üìç Location", "find_place": "Find Place:", "search_place": "E.g. Yellowstone...",
                "lat": "Latitude:", "lon": "Longitude:", "env_data": "üéõÔ∏è Env Data",
                "low_clouds": "Low Clouds", "mid_clouds": "Mid Clouds", "high_clouds": "High Clouds", "moon_poll": "Moon Poll.",
                "humidity": "Humidity", "seeing_est": "Seeing Est.", "now": "Now",
                "hybrid_planetarium": "üî≠ Hybrid Predictive Planetarium", "solar_system": "ü™ê Solar System",
                "rec_targets": "üåå Recommended Targets", "free_search": "üîç Free Target Search", "search_target": "E.g. M31, Pleiades...",
                "plan_target_btn": "Plan Target üöÄ", "back_dash": "Back to Dashboard", "change_target": "Change",
                "dossier": "üìñ Astrophotography Dossier", "type": "Type", "app_mag": "App. Magnitude", "distance": "Distance", "wiki_link": "üîó Wikipedia",
                "tactical_tip": "üí° Tactical Tip:", "optical_setup": "üì∏ Optical Setup", "telescope": "Telescope:", "focal_len": "Focal (mm):",
                "sensor": "Sensor:", "width": "Width (mm):", "height": "Height (mm):", "fov_calc": "Calculated Field of View",
                "fov_sim": "üìê Realistic FOV Simulator (DSS2)", "smart_calc": "‚è±Ô∏è Smart AI Session Calculator",
                "sunset": "Sunset", "night_start": "Astr. Night Starts", "night_end": "Astr. Night Ends", "sunrise": "Sunrise",
                "session_start": "Session Start:", "session_end": "Session End:", "sensor_type": "Sensor Type:",
                "seq_setup": "Sequence Setup", "gen_seq_btn": "‚ú® Generate Optimal Sequence", "use_frame": "Use | Frame", "poses_sec": "Exposures x Sec",
                "total": "Total", "every": "Every", "avail_window": "Available Window", "acq_time": "Acquisition Time", "res_time": "Residual Time", "time_overflow": "‚ö†Ô∏è Time Overflow!",
                "nina_export_title": "üöÄ N.I.N.A. Advanced Sequencer Export", "seq_start": "Sequence Start", "cool_cam": "Cool Camera to",
                "slew_center": "Slew & Center (Plate Solve)", "start_guide": "Start Autoguiding", "end_sec": "End / Safety", "warm_cam": "Warm Up Camera",
                "park_mount": "Park Mount", "meridian_flip": "Enable Meridian Flip", "filter_map": "Filter Name Mapping", "gen_nina_btn": "üíæ Generate N.I.N.A. File",
                "clear": "Clear", "partly_cloudy": "Partly Cloudy", "mostly_cloudy": "Mostly Cloudy", "overcast": "Overcast", "daytime": "Daytime",
                "new_moon": "New Moon", "waxing_crescent": "Waxing Crescent", "first_quarter": "First Quarter", "waxing_gibbous": "Waxing Gibbous", "full_moon": "Full Moon", "waning_gibbous": "Waning Gibbous", "last_quarter": "Last Quarter", "waning_crescent": "Waning Crescent",
                "galaxy": "Galaxy", "nebula": "Nebula", "cluster": "Cluster", "star": "Star", "unknown": "Unknown",
                "alert_planetarium": "Choose a target from the Planetarium first üî≠!", "alert_noseq": "No exposures calculated! Click 'Generate Optimal Sequence' first.",
                "alert_calib": "Calibration frames take up all the time!", "alert_nolight": "Select at least one Light filter.", "alert_times": "Please set Start and End times.", "no_target": "No visible objects.", "too_bright": "‚òÄÔ∏è Sky is too bright.", "dso_too_bright": "‚òÄÔ∏è Sky is too bright for Deep Sky.", "select_opt": "-- Select --",
                "jupiter": "Jupiter", "mars": "Mars", "venus": "Venus", "moon": "Moon", "sun": "Sun", "weather": "Weather",
                "mode": "Mode:", "single_panel": "Single Panel", "mosaic": "Mosaic", "panels": "Panels (X, Y):", "overlap": "Overlap:", "time_per_panel": "Time per Panel", "fov_warning": "‚ö†Ô∏è Target is larger than your FOV! Consider a mosaic.", "nina_mosaic_msg": "üìå Mosaic Mode active. Use N.I.N.A.'s Framing Assistant to generate panel coordinates.",
                "gen_report_btn": "üìù Generate Strategic Report", "report_title": "Mosaic Dossier", "copy_report": "Copy to Clipboard", "copied": "Copied!", "report_general": "General Info", "report_strategy": "Per-Panel Strategy", "report_plan": "Exposure Plan (Per Panel)",

                "info_pos": "Search a location. The map shows a 50km radius to help you find 'clear sky holes' while moving under the clouds.",
                "info_env": "Professional real-time satellite weather data.",
                "info_planetarium": "Shows visible targets based on altitude. Use the slider to simulate the night sky hours.",
                "info_search": "Search any custom object. The AI will connect to SIMBAD Strasbourg to download absolute coordinates.",
                "info_setup": "Calculate your FOV. If the target is too big, use 'Mosaic' mode: the AI will automatically split your available darkness time.",
                "info_smart": "The AI generates optimal exposures based on darkness, target type, and sensor type (Mono or Color).",
                "info_dither": "Shifts the mount slightly between shots to reduce noise. The AI subtracts the lost time from your available night window.",
                "info_nina": "Export a perfect JSON file. Drag & drop it into N.I.N.A. Advanced Sequencer for a fully autonomous night."
            },
            es: {
                "manual_btn": "üìñ Abrir Manual", "pos_title": "üìç Ubicaci√≥n", "find_place": "Buscar Lugar:", "search_place": "Ej. Atacama...",
                "lat": "Latitud:", "lon": "Longitud:", "env_data": "üéõÔ∏è Datos Ambientales",
                "low_clouds": "Nubes Bajas", "mid_clouds": "Nubes Medias", "high_clouds": "Nubes Altas", "moon_poll": "Ilum. Lunar",
                "humidity": "Humedad", "seeing_est": "Est. Seeing", "now": "Ahora",
                "hybrid_planetarium": "üî≠ Planetario H√≠brido", "solar_system": "ü™ê Sistema Solar",
                "rec_targets": "üåå Objetivos Recomendados", "free_search": "üîç B√∫squeda Libre", "search_target": "Ej. M31, Pl√©yades...",
                "plan_target_btn": "Planificar üöÄ", "back_dash": "Volver al Panel", "change_target": "Cambiar",
                "dossier": "üìñ Dosier Fotogr√°fico", "type": "Tipo", "app_mag": "Magnitud", "distance": "Distancia", "wiki_link": "üîó Wikipedia",
                "tactical_tip": "üí° Consejo T√°ctico:", "optical_setup": "üì∏ Equipo √ìptico", "telescope": "Telescopio:", "focal_len": "Focal (mm):",
                "sensor": "Sensor:", "width": "Ancho (mm):", "height": "Alto (mm):", "fov_calc": "Campo de Visi√≥n (FOV)",
                "fov_sim": "üìê Simulador FOV Realista (DSS2)", "smart_calc": "‚è±Ô∏è Calculadora de Sesi√≥n IA",
                "sunset": "Atardecer", "night_start": "Inicio Noche Oscura", "night_end": "Fin Noche Oscura", "sunrise": "Amanecer",
                "session_start": "Inicio Sesi√≥n:", "session_end": "Fin Sesi√≥n:", "sensor_type": "Tipo de Sensor:",
                "seq_setup": "Configuraci√≥n de Secuencia", "gen_seq_btn": "‚ú® Generar Secuencia √ìptima", "use_frame": "Usar | Frame", "poses_sec": "Tomas x Seg",
                "total": "Total", "every": "Cada", "avail_window": "Tiempo Disponible", "acq_time": "Tiempo de Captura", "res_time": "Tiempo Restante", "time_overflow": "‚ö†Ô∏è ¬°Tiempo excedido!",
                "nina_export_title": "üöÄ Exportar Secuencia a N.I.N.A.", "seq_start": "Inicio Secuencia", "cool_cam": "Enfriar C√°mara a",
                "slew_center": "Apuntar y Centrar (Plate Solve)", "start_guide": "Iniciar Guiado", "end_sec": "Fin / Seguridad", "warm_cam": "Calentar C√°mara",
                "park_mount": "Aparcar Montura", "meridian_flip": "Activar Meridian Flip", "filter_map": "Mapeo Nombres de Filtros", "gen_nina_btn": "üíæ Generar Archivo N.I.N.A.",
                "clear": "Despejado", "partly_cloudy": "Poco Nublado", "mostly_cloudy": "Nublado", "overcast": "Cubierto", "daytime": "D√≠a",
                "new_moon": "Luna Nueva", "waxing_crescent": "Luna Creciente", "first_quarter": "Cuarto Creciente", "waxing_gibbous": "Gibosa Creciente", "full_moon": "Luna Llena", "waning_gibbous": "Gibosa Menguante", "last_quarter": "Cuarto Menguante", "waning_crescent": "Luna Menguante",
                "galaxy": "Galaxia", "nebula": "Nebulosa", "cluster": "C√∫mulo", "star": "Estrella", "unknown": "Desconocido",
                "alert_planetarium": "¬°Elige primero un objetivo en el Planetario üî≠!", "alert_noseq": "¬°No se han calculado tomas! Haz clic en 'Generar Secuencia √ìptima'.",
                "alert_calib": "¬°Las tomas de calibraci√≥n ocupan todo el tiempo!", "alert_nolight": "Selecciona al menos un filtro Light.", "alert_times": "Configura las horas de Inicio y Fin.", "no_target": "No hay objetos visibles.", "too_bright": "‚òÄÔ∏è Cielo demasiado brillante.", "dso_too_bright": "‚òÄÔ∏è Cielo demasiado brillante para cielo profundo.", "select_opt": "-- Seleccionar --",
                "jupiter": "J√∫piter", "mars": "Marte", "venus": "Venus", "moon": "Luna", "sun": "Sol", "weather": "Clima",
                "mode": "Modo:", "single_panel": "Panel √önico", "mosaic": "Mosaico", "panels": "Paneles (X, Y):", "overlap": "Solapamiento:", "time_per_panel": "Tiempo por Panel", "fov_warning": "‚ö†Ô∏è ¬°El objeto es m√°s grande que tu campo visual! Considera un mosaico.", "nina_mosaic_msg": "üìå Modo Mosaico activo. Utiliza el Framing Assistant de N.I.N.A. para crear las coordenadas de los paneles.",
                "gen_report_btn": "üìù Generar Informe Estrat√©gico", "report_title": "Dosier Mosaico", "copy_report": "Copiar al Portapapeles", "copied": "¬°Copiado!", "report_general": "Info General", "report_strategy": "Estrategia por Panel", "report_plan": "Plan de Captura",

                "info_pos": "El mapa muestra un radio de 50km para encontrar claros en las nubes si te desplazas.",
                "info_env": "Datos meteorol√≥gicos satelitales en tiempo real.",
                "info_planetarium": "Muestra objetivos visibles. Desliza la barra temporal para simular el cielo.",
                "info_search": "Busca cualquier objeto. La IA conectar√° con SIMBAD para descargar las coordenadas.",
                "info_setup": "Si el objeto es m√°s grande que tu sensor, usa Mosaico. La IA dividir√° el tiempo nocturno.",
                "info_smart": "La IA asigna tiempos ideales basados en tus horas de oscuridad y tu tipo de c√°mara.",
                "info_dither": "El Dithering reduce el ruido. La IA restar√° los segundos perdidos de tu tiempo total.",
                "info_nina": "Genera un archivo JSON. Arr√°stralo a N.I.N.A. Advanced Sequencer para automatizar toda tu noche."
            },
            zh: {
                "manual_btn": "üìñ ÊâìÂºÄÊâãÂÜå", "pos_title": "üìç ‰ΩçÁΩÆ", "find_place": "Êü•ÊâæÂú∞ÁÇπ:", "search_place": "‰æãÂ¶Ç: ‰∏ΩÊ±ü...",
                "lat": "Á∫¨Â∫¶:", "lon": "ÁªèÂ∫¶:", "env_data": "üéõÔ∏è ÁéØÂ¢ÉÊï∞ÊçÆ",
                "low_clouds": "‰Ωé‰∫ë", "mid_clouds": "‰∏≠‰∫ë", "high_clouds": "È´ò‰∫ë", "moon_poll": "ÊúàÂÖâÂΩ±Âìç",
                "humidity": "ÊπøÂ∫¶", "seeing_est": "ËßÜÂÆÅÂ∫¶È¢Ñ‰º∞", "now": "Áé∞Âú®",
                "hybrid_planetarium": "üî≠ Ê∑∑ÂêàÈ¢ÑÊµãÊòüÂõæ", "solar_system": "ü™ê Â§™Èò≥Á≥ª",
                "rec_targets": "üåå Êé®ËçêÊ∑±Á©∫ÁõÆÊ†á", "free_search": "üîç Ëá™Áî±ÊêúÁ¥¢ÁõÆÊ†á", "search_target": "Â¶Ç: M31...",
                "plan_target_btn": "ËÆ°ÂàíÊãçÊëÑ üöÄ", "back_dash": "ËøîÂõû‰ª™Ë°®Êùø", "change_target": "Êõ¥Êîπ",
                "dossier": "üìñ Â§©ÊñáÁõÆÊ†áÊ°£Ê°à", "type": "Á±ªÂûã", "app_mag": "ËßÜÊòüÁ≠â", "distance": "Ë∑ùÁ¶ª", "wiki_link": "üîó Áª¥Âü∫ÁôæÁßë",
                "tactical_tip": "üí° ÊãçÊëÑÂª∫ËÆÆ:", "optical_setup": "üì∏ ÂÖâÂ≠¶ËÆæÁΩÆ", "telescope": "ÊúõËøúÈïú:", "focal_len": "ÁÑ¶Ë∑ù (mm):",
                "sensor": "‰º†ÊÑüÂô®:", "width": "ÂÆΩÂ∫¶ (mm):", "height": "È´òÂ∫¶ (mm):", "fov_calc": "ËßÜÂú∫ (FOV) ËÆ°ÁÆó",
                "fov_sim": "üìê ÁúüÂÆûËßÜÂú∫Ê®°ÊãüÂô® (DSS2)", "smart_calc": "‚è±Ô∏è AI Êô∫ËÉΩÂ∫èÂàóËÆ°ÁÆó",
                "sunset": "Êó•ËêΩ", "night_start": "Â§©ÊñáÈªëÂ§úÂºÄÂßã", "night_end": "Â§©ÊñáÈªëÂ§úÁªìÊùü", "sunrise": "Êó•Âá∫",
                "session_start": "ÊãçÊëÑÂºÄÂßã:", "session_end": "ÊãçÊëÑÁªìÊùü:", "sensor_type": "Áõ∏Êú∫Á±ªÂûã:",
                "seq_setup": "Â∫èÂàóËÆæÁΩÆ", "gen_seq_btn": "‚ú® ÁîüÊàêÊúÄ‰Ω≥ÊõùÂÖâÂ∫èÂàó", "use_frame": "‰ΩøÁî® | Â∏ßÁ±ªÂûã", "poses_sec": "ÊõùÂÖâÊï∞ x Áßí",
                "total": "ÊÄªËÆ°", "every": "ÊØèÈöî", "avail_window": "ÂèØÁî®ÊãçÊëÑÁ™óÂè£", "acq_time": "ÊÄªÊõùÂÖâÊó∂Èó¥", "res_time": "Ââ©‰ΩôÊó∂Èó¥", "time_overflow": "‚ö†Ô∏è Êó∂Èó¥Ê∫¢Âá∫ÔºÅ",
                "nina_export_title": "üöÄ N.I.N.A. È´òÁ∫ßÂ∫èÂàóÂØºÂá∫", "seq_start": "Â∫èÂàóÂºÄÂßãÂâç", "cool_cam": "Áõ∏Êú∫ÈôçÊ∏©Ëá≥",
                "slew_center": "ÊåáÂêëÂπ∂Â±Ö‰∏≠ (ÊòüÊùøËß£Êûê)", "start_guide": "ÂºÄÂßãÂØºÊòü", "end_sec": "ÁªìÊùü / ÂÆâÂÖ®", "warm_cam": "Áõ∏Êú∫ÂõûÊ∏©",
                "park_mount": "Ëµ§ÈÅì‰ª™ÂΩí‰Ωç", "meridian_flip": "ÂêØÁî®Ëá™Âä®‰∏≠Â§©ÁøªËΩ¨", "filter_map": "Êª§ÈïúÂêçÁß∞Êò†Â∞Ñ", "gen_nina_btn": "üíæ ÁîüÊàê N.I.N.A. Êñá‰ª∂",
                "clear": "Êô¥Êúó", "partly_cloudy": "Â∞ë‰∫ë", "mostly_cloudy": "Â§ö‰∫ë", "overcast": "Èò¥Â§©", "daytime": "ÁôΩÂ§©",
                "new_moon": "Êñ∞Êúà", "waxing_crescent": "ËõæÁúâÊúà", "first_quarter": "‰∏äÂº¶Êúà", "waxing_gibbous": "ÁõàÂá∏Êúà", "full_moon": "Êª°Êúà", "waning_gibbous": "‰∫èÂá∏Êúà", "last_quarter": "‰∏ãÂº¶Êúà", "waning_crescent": "ÊÆãÊúà",
                "galaxy": "ÊòüÁ≥ª", "nebula": "Êòü‰∫ë", "cluster": "ÊòüÂõ¢", "star": "ÊÅíÊòü", "unknown": "Êú™Áü•",
                "alert_planetarium": "ËØ∑ÂÖà‰ªéÊòüÂõæ‰∏≠ÈÄâÊã©‰∏Ä‰∏™ÁõÆÊ†á üî≠ÔºÅ", "alert_noseq": "Ê≤°ÊúâËÆ°ÁÆóÂá∫‰ªª‰ΩïÊõùÂÖâÔºÅËØ∑ÂÖàÁÇπÂáª 'ÁîüÊàêÊúÄ‰Ω≥ÊõùÂÖâÂ∫èÂàó'„ÄÇ",
                "alert_calib": "Ê†°ÂáÜÂ∏ßÂç†ÊçÆ‰∫ÜÊâÄÊúâÂèØÁî®Êó∂Èó¥ÔºÅ", "alert_nolight": "ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™‰∫ÆÂú∫ (Light) Êª§Èïú„ÄÇ", "alert_times": "ËØ∑ÂÖàËÆæÁΩÆÂºÄÂßãÂíåÁªìÊùüÊó∂Èó¥„ÄÇ", "no_target": "ÂΩìÂâçÊ≤°ÊúâÂèØËßÅÁõÆÊ†á„ÄÇ", "too_bright": "‚òÄÔ∏è Â§©Á©∫Â§™‰∫Æ‰∫Ü„ÄÇ", "dso_too_bright": "‚òÄÔ∏è Â§©Á©∫ÂØπÊ∑±Á©∫ÁõÆÊ†áÊù•ËØ¥Â§™‰∫Æ‰∫Ü„ÄÇ", "select_opt": "-- ËØ∑ÈÄâÊã© --",
                "jupiter": "Êú®Êòü", "mars": "ÁÅ´Êòü", "venus": "ÈáëÊòü", "moon": "ÊúàÁêÉ", "sun": "Â§™Èò≥", "weather": "Â§©Ê∞î",
                "mode": "Ê®°Âºè:", "single_panel": "ÂçïÈù¢Êùø", "mosaic": "ÊãºÊé•", "panels": "Èù¢Êùø (X, Y):", "overlap": "ÈáçÂè†Â∫¶:", "time_per_panel": "ÊØèÂùóÈù¢ÊùøÊó∂Èó¥", "fov_warning": "‚ö†Ô∏è ÁõÆÊ†áÊØî‰Ω†ÁöÑËßÜÂú∫ËøòË¶ÅÂ§ßÔºÅËÄÉËôë‰ΩøÁî®ÊãºÊé•ÊãçÊëÑ„ÄÇ", "nina_mosaic_msg": "üìå ÊãºÊé•Ê®°ÂºèÂ∑≤ÊøÄÊ¥ª„ÄÇËØ∑‰ΩøÁî® N.I.N.A. ÁöÑÊûÑÂõæÂä©ÊâãÁîüÊàêÈù¢ÊùøÂùêÊ†á„ÄÇ",
                "gen_report_btn": "üìù ÁîüÊàêÁ≠ñÁï•Êä•Âëä", "report_title": "ÊãºÊé•ÊãçÊëÑÊ°£Ê°à", "copy_report": "Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø", "copied": "Â∑≤Â§çÂà∂!", "report_general": "Âü∫Êú¨‰ø°ÊÅØ", "report_strategy": "ÂçïÈù¢ÊùøÁ≠ñÁï•", "report_plan": "ÊõùÂÖâËÆ°Âàí",

                "info_pos": "ÊêúÁ¥¢‰ΩçÁΩÆ„ÄÇÂú∞ÂõæÊòæÁ§∫ 50 ÂÖ¨ÈáåÂçäÂæÑÔºåÂ∏ÆÂä©ÊÇ®Âú®‰∫ëÂ±Ç‰∏ãÂØªÊâæÊô¥Á©∫Âå∫„ÄÇ",
                "info_env": "‰∏ì‰∏öÁöÑÂÆûÊó∂Âç´ÊòüÊ∞îË±°Êï∞ÊçÆ„ÄÇ",
                "info_planetarium": "ÊòæÁ§∫ÂèØËßÅÁõÆÊ†á„ÄÇÊªëÂä®Êó∂Èó¥ËΩ¥‰ª•Ê®°Êãü‰ªäÊôöÁöÑÊòüÁ©∫„ÄÇ",
                "info_search": "Â¶ÇÊûúÊú¨Âú∞Êï∞ÊçÆÂ∫ìÊ≤°ÊúâÔºåAI Â∞ÜËøûÊé•ÊñØÁâπÊãâÊñØÂ†° (SIMBAD) Ëé∑ÂèñÂùêÊ†á„ÄÇ",
                "info_setup": "ËÆ°ÁÆóËßÜÂú∫„ÄÇÂ¶ÇÊûúÁõÆÊ†áÂ§™Â§ßÔºåËØ∑ÈÄâÊã©'ÊãºÊé•'ÔºåAI ‰ºöÂ∞ÜÈªëÂ§úÊó∂Èó¥ÂàÜÈÖçÁªôÂêÑÈù¢Êùø„ÄÇ",
                "info_smart": "AI Ê†πÊçÆÂèØÁî®ÈªëÂ§úÊó∂Èó¥Ëá™Âä®ÂàÜÈÖçÊúÄ‰Ω≥ÊõùÂÖâÂèÇÊï∞„ÄÇ",
                "info_dither": "ÂæÆË∞ÉËµ§ÈÅì‰ª™‰ΩçÁΩÆ‰ª•ÂáèÂ∞ëÂô™ÁÇπ„ÄÇAI ‰ºöÂú®ËÆ°ÁÆóÊó∂Èó¥Êó∂Êâ£Èô§ÊäñÂä®‰∏¢Â§±ÁöÑÁßíÊï∞„ÄÇ",
                "info_nina": "ÂØºÂá∫ JSON Êñá‰ª∂„ÄÇÂ∞ÜÂÖ∂ÊãñÂÖ• N.I.N.A. È´òÁ∫ßÂ∫èÂàóÂô®Âç≥ÂèØÂÆûÁé∞ÂÖ®Ëá™Âä®ÊãçÊëÑ„ÄÇ"
            }
        };

        let lang = localStorage.getItem('ad_lang') || 'it';
        i18n.it.mosaic_active_msg = "‚úÖ Modalit√† Mosaico attiva.";
        i18n.en.mosaic_active_msg = "‚úÖ Mosaic Mode active.";
        i18n.es.mosaic_active_msg = "‚úÖ Modo Mosaico activo.";
        i18n.zh.mosaic_active_msg = "‚úÖ ÊãºÊé•Ê®°ÂºèÂ∑≤ÊøÄÊ¥ª„ÄÇ";
	i18n.it.info_map = "Mappa Empirica di Visibilit√†. Visualizza un raggio simbolico di 50 km per mostrarti a colpo d'occhio le reali condizioni del cielo. La sovrapposizione dei vari strati ti far√† capire subito se la serata sar√† limpida o compromessa. Usa i bottoni superiori per attivare i filtri meteo (Nuvole, Jet Stream, Umidit√†) e scorri la linea temporale per prevedere la loro evoluzione nelle prossime ore.";
        i18n.en.info_map = "Empirical Visibility Map. Shows a symbolic 50 km radius to give you at-a-glance real sky conditions. The overlay of different layers will let you know immediately if the night will be clear or compromised. Use the top buttons to toggle weather filters (Clouds, Jet Stream, Humidity) and slide the timeline to forecast their evolution.";
        i18n.es.info_map = "Mapa Emp√≠rico de Visibilidad. Muestra un radio simb√≥lico de 50 km para indicarte de un vistazo las condiciones reales del cielo. La superposici√≥n de capas te har√° entender de inmediato si la noche ser√° despejada o comprometida. Usa los botones superiores para activar filtros (Nubes, Jet Stream, Humedad) y desliza la l√≠nea temporal para prever su evoluci√≥n.";
        i18n.zh.info_map = "ÁªèÈ™åËÉΩËßÅÂ∫¶Âú∞Âõæ„ÄÇÊòæÁ§∫Ë±°ÂæÅÊÄßÁöÑ 50 ÂÖ¨ÈáåÂçäÂæÑÔºåËÆ©ÊÇ®‰∏ÄÁõÆ‰∫ÜÁÑ∂Âú∞‰∫ÜËß£ÁúüÂÆûÁöÑÂ§©Á©∫Áä∂ÂÜµ„ÄÇ‰∏çÂêåÂõæÂ±ÇÁöÑÂè†Âä†Â∞ÜÁ´ãÂç≥ËÆ©ÊÇ®Áü•ÈÅì‰ªäÊôöÊòØÊô¥ÊúóËøòÊòØÊÅ∂Âä£„ÄÇ‰ΩøÁî®È°∂ÈÉ®ÊåâÈíÆÊøÄÊ¥ªÂ§©Ê∞îÊª§ÈïúÔºà‰∫ëÂ±Ç„ÄÅÊÄ•ÊµÅ„ÄÅÊπøÂ∫¶ÔºâÔºåÂπ∂ÊªëÂä®Êó∂Èó¥ËΩ¥‰ª•È¢ÑÊµãÂÆÉ‰ª¨Âú®Êú™Êù•Âá†Â∞èÊó∂ÂÜÖÁöÑÊºîÂèò„ÄÇ";
        
        function t(key) { return i18n[lang][key] || key; }

        function changeLanguage(l) {
            lang = l; localStorage.setItem('ad_lang', l);
            
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            let actBtn = document.getElementById('btn-lang-' + l);
            if(actBtn) actBtn.classList.add('active');

            document.querySelectorAll('[data-i18n]').forEach(el => {
                let k = el.getAttribute('data-i18n');
                if (el.tagName === 'INPUT') el.placeholder = t(k); else el.innerHTML = t(k);
            });

            ['it','en','es','zh'].forEach(lg => {
                let guide = document.getElementById('guide-'+lg);
                if(guide) guide.style.display = (lang===lg ? 'block' : 'none');
            });
            
            aggiornaEffemeridi(new Date()); 
            if(datiMeteo){cambiaOraMeteo(); cambiaOraAstro();}
	// Aggiorna in tempo reale i dati dinamici del Dossier se √® aperto
            if (targetSelezionato && document.getElementById('planning-view').style.display === 'block') {
                document.getElementById('plan-target-name').innerText = getLocalizedName(targetSelezionato);
                document.getElementById('stat-type').innerText = mapTypeTrans(targetSelezionato.type) || "--";
                document.getElementById('target-description').innerText = getLocalizedText(targetSelezionato, 'desc');
                document.getElementById('target-tips').innerText = getLocalizedText(targetSelezionato, 'tips');
            }
        // Aggiorna in tempo reale i dati dinamici del Dossier se √® aperto
            if (targetSelezionato && document.getElementById('planning-view').style.display === 'block') {
                document.getElementById('plan-target-name').innerText = getLocalizedName(targetSelezionato);
                document.getElementById('stat-type').innerText = mapTypeTrans(targetSelezionato.type) || "--";
            }
}

        const dbTelescopi = [{ nome: "Askar FRA 400 (400mm)", focale: 400 }, { nome: "Explore Scienific Comethunter (731mm)", focale: 731 }, { nome: "SW Explorer 130 PDS (650mm)", focale: 650 }, { nome: "SW Explorer 150P (750mm)", focale: 750 }, { nome: "SW Explorer 200P (1000mm)", focale: 1000 }, { nome: "SW Quattro 150P (600mm)", focale: 600 }, { nome: "SW Quattro 200P (800mm)", focale: 800 }, { nome: "SW Quattro 250P (1000mm)", focale: 1000 }, { nome: "SW 72ED Evostar (420mm)", focale: 420 }, { nome: "SW 80ED Evostar (600mm)", focale: 600 }, { nome: "SW Esprit 80ED (400mm)", focale: 400 }, { nome: "SW Esprit 100ED (550mm)", focale: 550 }, { nome: "Celestron C8 SCT (2032mm)", focale: 2032 }, { nome: "Celestron C8 @ f/6.3 (1280mm)", focale: 1280 }, { nome: "ZWO Seestar S50 (250mm)", focale: 250 }, { nome: "Samyang 135mm f/2", focale: 135 }];
        const dbCamere = [{ nome: "ASI 533MC/MM (Square)", w: 11.31, h: 11.31 }, { nome: "ASI 294MC/MM (4/3\")", w: 19.1, h: 13.0 }, { nome: "SONY IMX571 ", w: 23.5, h: 15.7 }, { nome: "ASI 6200MC/MM (Full Frame)", w: 36.0, h: 24.0 }, { nome: "ASI 183MC/MM (1\")", w: 13.2, h: 8.8 }, { nome: "SONY IMX585", w: 11.14, h: 6.26 }, { nome: "ASI 1600MM (4/3\")", w: 17.7, h: 13.4 }, { nome: "Reflex APS-C (Canon/Nikon)", w: 22.3, h: 14.9 }];

        function popolaMenuAttrezzatura() {
            const selTel = document.getElementById('preset-telescope'); dbTelescopi.forEach(t => { let opt = document.createElement('option'); opt.value = t.focale; opt.textContent = t.nome; selTel.appendChild(opt); });
            const selCam = document.getElementById('preset-sensor'); dbCamere.forEach(c => { let opt = document.createElement('option'); opt.value = `${c.w},${c.h}`; opt.textContent = c.nome; selCam.appendChild(opt); });
        }
let latCorrente = 46.062, lonCorrente = 13.235, datiMeteo = null, indicePartenza = 0, chartAltezza = null, targetSelezionato = null, aladinSkyMap = null, vistaPrecedente = 'dashboard-view';
        let mappaScura = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: 'Meteo Data &copy; <a href="https://open-meteo.com/" target="_blank" style="color:#bb86fc;">Open-Meteo</a> | Map &copy; <a href="https://carto.com/" target="_blank">CartoDB</a>' });
        let map = L.map('map', { center: [latCorrente, lonCorrente], zoom: 8, layers: [mappaScura], zoomControl: false });
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        let layers = { basse: L.layerGroup().addTo(map), medie: L.layerGroup(), alte: L.layerGroup(), jet: L.layerGroup(), luna: L.layerGroup(), umidita: L.layerGroup() };
        let marker = L.marker([latCorrente, lonCorrente]).addTo(map).bindPopup("<b>Udine</b>").openPopup();
        let timerRicerca;

        const planetsDatabase = [ { id: "jupiter", name: "jupiter", icon: "ü™ê", ra: 7.15, dec: 22.8 }, { id: "mars", name: "mars", icon: "üî¥", ra: 18.50, dec: -23.5 }, { id: "venus", name: "venus", icon: "‚ú®", ra: 23.50, dec: -3.5 } ];

        function getJulianDate(date) { return (date.getTime() / 86400000) + 2440587.5; }
        function calcolaAltAz(ra, dec, lat, lon, date) {
            let jd = getJulianDate(date), d = jd - 2451545.0, lst = (280.46061837 + 360.98564736629 * d + lon) % 360; if (lst < 0) lst += 360;
            let ra_deg = ra * 15, ha_deg = lst - ra_deg, rad = Math.PI / 180;
            let sin_alt = Math.sin(lat*rad)*Math.sin(dec*rad) + Math.cos(lat*rad)*Math.cos(dec*rad)*Math.cos(ha_deg*rad);
            let alt_deg = Math.asin(sin_alt) / rad;
            let cos_az = (Math.sin(dec*rad) - Math.sin(lat*rad)*sin_alt) / (Math.cos(lat*rad) * Math.cos(Math.asin(sin_alt)));
            cos_az = Math.max(-1, Math.min(1, cos_az)); 
            let az_deg = Math.acos(cos_az) / rad; if (Math.sin(ha_deg*rad) > 0) az_deg = 360 - az_deg;
            return { alt: alt_deg, az: az_deg };
        }
        function getPuntoCardinale(az) { return ["N", "NE", "E", "SE", "S", "SW", "W", "NW", "N"][Math.round(az / 45) % 8]; }

        function cercaIndirizzo() {
            let query = document.getElementById('ricerca').value, dropdown = document.getElementById('dropdown-risultati');
            if (query.length < 3) { dropdown.style.display = 'none'; return; }
            clearTimeout(timerRicerca);
            timerRicerca = setTimeout(() => {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                    .then(r => r.json()).then(data => {
                        dropdown.innerHTML = ''; 
                        if (data.length > 0) {
                            dropdown.style.display = 'block'; data.forEach(l => { let li = document.createElement('li'); li.textContent = l.display_name; li.onclick = () => selezionaLuogo(l.lat, l.lon, l.display_name); dropdown.appendChild(li); });
                        } else dropdown.style.display = 'none';
                    });
            }, 500); 
        }

        function selezionaLuogo(lat, lon, nome) {
            latCorrente = parseFloat(lat); lonCorrente = parseFloat(lon);
            document.getElementById('ricerca').value = nome.split(',')[0];
            document.getElementById('lat').value = latCorrente.toFixed(5); document.getElementById('lon').value = lonCorrente.toFixed(5);
            document.getElementById('dropdown-risultati').style.display = 'none';
            map.flyTo([latCorrente, lonCorrente], 9);
            if (marker) map.removeLayer(marker);
            marker = L.marker([latCorrente, lonCorrente]).addTo(map).bindPopup(`<b>${nome.split(',')[0]}</b>`).openPopup();
            aggiornaEffemeridi(new Date()); scaricaDatiPrevisionali();
        }

        function aggiornaEffemeridi(data) {
            let orariSole = SunCalc.getTimes(data, latCorrente, lonCorrente), orariLuna = SunCalc.getMoonTimes(data, latCorrente, lonCorrente), faseLuna = SunCalc.getMoonIllumination(data);
            let formattaOra = (d) => d && !isNaN(d) ? d.toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}) : '--:--';
            document.getElementById('alba-sole').innerText = formattaOra(orariSole.sunrise); document.getElementById('tramonto-sole').innerText = formattaOra(orariSole.sunset);
            document.getElementById('alba-luna').innerText = orariLuna.rise ? formattaOra(orariLuna.rise) : '--:--'; document.getElementById('tramonto-luna').innerText = orariLuna.set ? formattaOra(orariLuna.set) : '--:--';
            let f = faseLuna.phase, i = 'üåë', n = 'new_moon';
            if(f>0.03&&f<=0.22){i='üåí';n='waxing_crescent';}else if(f>0.22&&f<=0.28){i='üåì';n='first_quarter';}else if(f>0.28&&f<=0.47){i='üåî';n='waxing_gibbous';}else if(f>0.47&&f<=0.53){i='üåï';n='full_moon';}else if(f>0.53&&f<=0.72){i='üåñ';n='waning_gibbous';}else if(f>0.72&&f<=0.78){i='üåó';n='last_quarter';}else if(f>0.78&&f<=0.97){i='üåò';n='waning_crescent';}
            document.getElementById('moon-emoji').innerText = i; document.getElementById('moon-phase-name').innerText = t(n);
        }

        function scaricaDatiPrevisionali() {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latCorrente}&longitude=${lonCorrente}&hourly=cloud_cover_low,cloud_cover_mid,cloud_cover_high,wind_speed_250hPa,wind_speed_10m,temperature_2m,relative_humidity_2m&forecast_days=3&timezone=auto`)
            .then(r => r.json()).then(data => {
                datiMeteo = data.hourly; let adesso = new Date();
                indicePartenza = Math.max(0, datiMeteo.time.findIndex(x => new Date(x).getTime() >= adesso.getTime() - 3600000));
                document.getElementById('timeSlider').disabled = false; document.getElementById('timeSlider').value = 0; 
                document.getElementById('astroSlider').disabled = false; document.getElementById('astroSlider').value = 0; 
                cambiaOraMeteo(); cambiaOraAstro();
            });
        }

        function syncSliders(val) { 
            document.getElementById('timeSlider').value = val; 
            document.getElementById('astroSlider').value = val; 
            cambiaOraMeteo(); 
            cambiaOraAstro(); 
        }

        function cambiaOraMeteo() {
            if (!datiMeteo) return;
            let step = parseInt(document.getElementById('timeSlider').value), i = indicePartenza + step, dOra = new Date(datiMeteo.time[i]);
            let tOra = step === 0 ? t("now") + " (" + new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'}) + ")" : dOra.toLocaleDateString(lang==='it'?'it-IT':'en-US', { weekday: 'short', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            if (step > 0 && dOra.getHours() === 0) aggiornaEffemeridi(dOra);

            let b = datiMeteo.cloud_cover_low[i], m = datiMeteo.cloud_cover_mid[i], a = datiMeteo.cloud_cover_high[i], jet = Math.round(datiMeteo.wind_speed_250hPa[i]), vs = datiMeteo.wind_speed_10m[i], temp = datiMeteo.temperature_2m[i], um = datiMeteo.relative_humidity_2m[i];
            let altS = SunCalc.getPosition(dOra, latCorrente, lonCorrente).altitude * (180/Math.PI), mP = SunCalc.getMoonPosition(dOra, latCorrente, lonCorrente);
            
            let maxC = Math.max(b, m, a), icM = "‚òÅÔ∏è", dsM = "overcast";
            if (maxC < 15) { icM = "‚òÄÔ∏è"; dsM = "clear"; } else if (maxC < 40) { icM = "üå§Ô∏è"; dsM = "partly_cloudy"; } else if (maxC < 75) { icM = "‚õÖ"; dsM = "mostly_cloudy"; }
            if (altS < -6) { if (maxC < 15) icM = "‚ú®"; else if (maxC < 40) icM = "üåô"; }

            document.getElementById('time-display').innerHTML = `<span style="font-size: 1.5em; vertical-align: middle; margin-right: 5px;">${icM}</span> ${tOra} <br><span style="font-size: 0.75em; color: #aaa; text-transform: uppercase;">${t("weather")}: <b style="color: #fff;">${t(dsM)}</b></span>`;
            document.getElementById('meteo-temp').innerText = Math.round(temp) + "¬∞C";
            document.getElementById('meteo-umidita').innerText = t("humidity")+": " + um + "%"; document.getElementById('meteo-umidita').style.color = um > 85 ? "#ff4444" : "#44ff44";
            document.getElementById('val-umidita-layer').innerText = um + "%";
            
            let inqL = (altS < -6 && mP.altitude > 0) ? Math.max(0, Math.round((SunCalc.getMoonIllumination(dOra).fraction * Math.sin(mP.altitude)) * 100)) : 0;
            let scS = 5; if(jet>120)scS-=3;else if(jet>80)scS-=2;else if(jet>50)scS-=1; if(vs>15)scS-=1; if(vs>30)scS-=1;
            
            document.getElementById('val-seeing').innerText = altS > -6 ? t("daytime") : Math.max(1, scS) + "/5";
            document.getElementById('val-seeing').style.color = altS > -6 ? "#ffaa00" : "#bb86fc";
            document.getElementById('val-basse').innerText = b+"%"; document.getElementById('val-medie').innerText = m+"%"; document.getElementById('val-alte').innerText = a+"%"; document.getElementById('val-jet').innerHTML = jet+' <span class="jet-unit">km/h</span>'; document.getElementById('val-luna').innerText = inqL+"%";

            Object.values(layers).forEach(l => l.clearLayers());
            L.circle([latCorrente, lonCorrente], { radius: 50000, color: '#ff4444', fillColor: '#ff4444', fillOpacity: (b/100)*0.7, weight: 1 }).addTo(layers.basse);
            L.circle([latCorrente, lonCorrente], { radius: 50000, color: '#44ff44', fillColor: '#44ff44', fillOpacity: (m/100)*0.7, weight: 1 }).addTo(layers.medie);
            L.circle([latCorrente, lonCorrente], { radius: 50000, color: '#4444ff', fillColor: '#4444ff', fillOpacity: (a/100)*0.7, weight: 1 }).addTo(layers.alte);
            if(jet>50) L.circle([latCorrente, lonCorrente], { radius: 60000, color: '#ff00ff', fillColor: '#ff00ff', fillOpacity: (jet/200)*0.5, weight: 2, dashArray: '10, 10' }).addTo(layers.jet);
            if(inqL>0) L.circle([latCorrente, lonCorrente], { radius: 100000, color: '#ffffaa', fillColor: '#ffffaa', fillOpacity: (inqL/100)*0.4, weight: 0 }).addTo(layers.luna);
            if(um>60) L.circle([latCorrente, lonCorrente], { radius: 75000, color: '#00ffff', fillColor: '#00ffff', fillOpacity: ((um-60)/100)*0.5, weight: 1, dashArray: '5, 5' }).addTo(layers.umidita);
        }

        function toggleLayer(n) { let b = document.getElementById('btn-'+n), l = layers[n]; if (map.hasLayer(l)) { map.removeLayer(l); b.classList.replace('active','disabled'); } else { map.addLayer(l); b.classList.replace('disabled','active'); } }

        function cambiaOraAstro() {
            if (!datiMeteo) return;
            let step = parseInt(document.getElementById('astroSlider').value), dOra = new Date(datiMeteo.time[indicePartenza + step]);
            document.getElementById('astro-time-display').innerText = "üî≠ " + (step === 0 ? t("now") + " (" + new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'}) + ")" : dOra.toLocaleDateString(lang==='it'?'it-IT':'en-US', { weekday: 'short', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }));
            
            let pL = document.getElementById('planets-list'), dL = document.getElementById('dso-list'); pL.innerHTML = ''; dL.innerHTML = '';
            if (SunCalc.getPosition(dOra, latCorrente, lonCorrente).altitude * (180/Math.PI) > -6) { pL.innerHTML = dL.innerHTML = `<p style="color:#aaa; padding:10px;">${t("too_bright")}</p>`; return; }

            let vP = [], mP = SunCalc.getMoonPosition(dOra, latCorrente, lonCorrente), mA = mP.altitude * (180/Math.PI);
            if (mA > 5) vP.push({ html: creaCardHTML({id: "moon", name: "moon", icon: "üåï"}, mA, (mP.azimuth * 180/Math.PI + 180) % 360, false), alt: mA });
            planetsDatabase.forEach(p => { let pos = calcolaAltAz(p.ra, p.dec, latCorrente, lonCorrente, dOra); if (pos.alt > 10) vP.push({ html: creaCardHTML(p, pos.alt, pos.az, false), alt: pos.alt }); });
            vP.sort((a, b) => b.alt - a.alt).forEach(i => pL.appendChild(i.html));

            let vD = [];
            if (typeof dsoDatabase !== 'undefined') dsoDatabase.forEach(d => { let pos = calcolaAltAz(d.ra, d.dec, latCorrente, lonCorrente, dOra); if (pos.alt > 15) vD.push({ html: creaCardHTML(d, pos.alt, pos.az, true), alt: pos.alt }); });
            vD.sort((a, b) => b.alt - a.alt); if (vD.length > 0) vD[0].html.classList.add('top-target');
            vD.forEach(i => dL.appendChild(i.html));
            if (dL.innerHTML === '') dL.innerHTML = `<p style="color:#777; padding:10px;">${t("no_target")}</p>`;
        }

        function mapTypeTrans(type) { 
            if (!type) return t("unknown");
            let l = type.toLowerCase();
            
            let dict = {
                it: { "spi": "Galassia a Spirale", "ell": "Galassia Ellittica", "len": "Galassia Lenticolare", "irr": "Galassia Irregolare", "starb": "Galassia Starburst", "ammg": "Ammasso di Galassie", "grup": "Gruppo di Galassie", "emi": "Nebulosa a Emissione", "rif": "Nebulosa a Riflessione", "osc": "Nebulosa Oscura", "pla": "Nebulosa Planetaria", "sup": "Resto di Supernova", "hii": "Regione H II", "mis": "Nebulosa Mista", "glo": "Ammasso Globulare", "ape": "Ammasso Aperto" },
                en: { "spi": "Spiral Galaxy", "ell": "Elliptical Galaxy", "len": "Lenticular Galaxy", "irr": "Irregular Galaxy", "starb": "Starburst Galaxy", "ammg": "Galaxy Cluster", "grup": "Galaxy Group", "emi": "Emission Nebula", "rif": "Reflection Nebula", "osc": "Dark Nebula", "pla": "Planetary Nebula", "sup": "Supernova Remnant", "hii": "H II Region", "mis": "Mixed Nebula", "glo": "Globular Cluster", "ape": "Open Cluster" },
                es: { "spi": "Galaxia Espiral", "ell": "Galaxia El√≠ptica", "len": "Galaxia Lenticular", "irr": "Galaxia Irregular", "starb": "Galaxia Starburst", "ammg": "C√∫mulo de Galaxias", "grup": "Grupo de Galaxias", "emi": "Nebulosa de Emisi√≥n", "rif": "Nebulosa de Reflexi√≥n", "osc": "Nebulosa Oscura", "pla": "Nebulosa Planetaria", "sup": "Remanente de Supernova", "hii": "Regi√≥n H II", "mis": "Nebulosa Mixta", "glo": "C√∫mulo Globular", "ape": "C√∫mulo Abierto" },
                zh: { "spi": "Ëû∫ÊóãÊòüÁ≥ª", "ell": "Ê§≠ÂúÜÊòüÁ≥ª", "len": "ÈÄèÈïúÁä∂ÊòüÁ≥ª", "irr": "‰∏çËßÑÂàôÊòüÁ≥ª", "starb": "ÊòüÊö¥ÊòüÁ≥ª", "ammg": "ÊòüÁ≥ªÂõ¢", "grup": "ÊòüÁ≥ªÁæ§", "emi": "ÂèëÂ∞ÑÊòü‰∫ë", "rif": "ÂèçÂ∞ÑÊòü‰∫ë", "osc": "ÊöóÊòü‰∫ë", "pla": "Ë°åÊòüÁä∂Êòü‰∫ë", "sup": "Ë∂ÖÊñ∞ÊòüÈÅóËøπ", "hii": "H II Âå∫", "mis": "Ê∑∑ÂêàÊòü‰∫ë", "glo": "ÁêÉÁä∂ÊòüÂõ¢", "ape": "ÁñèÊï£ÊòüÂõ¢" }
            };

            let m = dict[lang] || dict['en'];
            if(l.includes("spirale")) return m["spi"];
            if(l.includes("ellittica")) return m["ell"];
            if(l.includes("lenticolare")) return m["len"];
            if(l.includes("irregolare")) return m["irr"];
            if(l.includes("starburst")) return m["starb"];
            if(l.includes("ammasso di galassie")) return m["ammg"];
            if(l.includes("gruppo")) return m["grup"];
            if(l.includes("emissione")) return m["emi"];
            if(l.includes("riflessione")) return m["rif"];
            if(l.includes("oscura")) return m["osc"];
            if(l.includes("planetaria")) return m["pla"];
            if(l.includes("supernova")) return m["sup"];
            if(l.includes("h ii")) return m["hii"];
            if(l.includes("mista")) return m["mis"];
            if(l.includes("globulare")) return m["glo"];
            if(l.includes("aperto")) return m["ape"];
            
            if(l.includes("galassi") || l.includes("galaxy")) return t("galaxy");
            if(l.includes("nebulos") || l.includes("nebula")) return t("nebula");
            if(l.includes("ammasso") || l.includes("cluster")) return t("cluster");
            if(l.includes("stella") || l.includes("star")) return t("star");
            return type; 
        }

        function getLocalizedName(obj) {
            if (!obj) return "";
            let checkName = obj.id || obj.name;
            if (checkName === "jupiter" || checkName === "mars" || checkName === "venus" || checkName === "moon") {
                return t(checkName);
            }
            if (obj[lang]) return `${obj.name} - ${obj[lang]}`;
            if (obj['en']) return `${obj.name} - ${obj['en']}`;
            return obj.name; 
        }

        // Funzione per pescare il testo giusto (Descrizione o Tips)
        function getLocalizedText(obj, key) {
            if (!obj) return "--";
            if (obj[key + '_' + lang]) return obj[key + '_' + lang];
            return obj[key] || "--"; // Fallback di sicurezza per la Ricerca Libera
        }

        function creaCardHTML(tObj, alt, az, c) {
            let div = document.createElement('div'); div.className = c ? 'dso-card card-clickable' : 'dso-card card-static';
            let finalName = getLocalizedName(tObj);
            div.innerHTML = `<div class="dso-icon">${tObj.icon}</div><div class="dso-info"><h4>${finalName}</h4><p>Alt: <b>${Math.round(alt)}¬∞</b></p><span class="dso-direction">${getPuntoCardinale(az)}</span></div>`;
            if(c) div.onclick = () => apriPianificazione(tObj); return div;
        }

        function setupSearch(iId, sId) {
            let inp = document.getElementById(iId), box = document.getElementById(sId); if(!inp || !box) return;
            inp.addEventListener('input', () => {
                if (typeof dsoDatabase === 'undefined') return;
                let v = inp.value.trim().toLowerCase().replace(/\s+/g, ''); box.innerHTML = '';
                if (!v) { box.style.display = 'none'; return; }
                let m = dsoDatabase.filter(d => d.id.toLowerCase().includes(v) || d.name.toLowerCase().replace(/\s+/g, '').includes(v) || (d[lang] && d[lang].toLowerCase().replace(/\s+/g, '').includes(v)));
                if (m.length > 0) { box.style.display = 'block'; m.forEach(x => { let li = document.createElement('li'); li.innerHTML = `${x.icon} ${getLocalizedName(x)}`; li.onclick = () => { inp.value = getLocalizedName(x); box.style.display = 'none'; apriPianificazione(x); }; box.appendChild(li); }); } else box.style.display = 'none';
            });
            inp.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); box.style.display = 'none'; eseguiRicerca(iId); } });
            document.addEventListener('click', e => { if (e.target !== inp) box.style.display = 'none'; });
        }
        setupSearch('search-dash-input', 'sugg-dash'); setupSearch('search-plan-input', 'sugg-plan');

        function eseguiRicerca(iId) {
            if (typeof dsoDatabase === 'undefined') return;
            let inp = document.getElementById(iId), q = inp.value.trim(); if (!q) return;
            let qn = q.toLowerCase().replace(/\s+/g, ''), st = document.getElementById('status-' + iId);
            if(st) st.style.display = 'none';

            let ex = dsoDatabase.find(d => d.id.toLowerCase() === qn || (d[lang] && d[lang].toLowerCase().replace(/\s+/g, '') === qn));
            let pt = dsoDatabase.find(d => d.name.toLowerCase().replace(/\s+/g, '').includes(qn) || (d[lang] && d[lang].toLowerCase().replace(/\s+/g, '').includes(qn)));
            
            if (ex) { inp.value = getLocalizedName(ex); apriPianificazione(ex); return; } if (pt) { inp.value = getLocalizedName(pt); apriPianificazione(pt); return; }

            if(st) { st.style.display = 'block'; st.style.color = '#ffaa00'; st.innerText = "SIMBAD Search... üõ∞Ô∏è"; }
            fetch(`https://cds.unistra.fr/cgi-bin/nph-sesame/-oI/A?${encodeURIComponent(q)}`).then(r => r.text()).then(d => {
                let lines = d.split('\n'), fc = false, ra, dec, ty = "Sconosciuta", mg = "N/D";
                for(let i=0; i<lines.length; i++) {
                    let line = lines[i].trim();
                    if(line.startsWith('%J') && !fc) { let p = line.split(/\s+/); if(p.length >= 3) { ra = parseFloat(p[1]); dec = parseFloat(p[2]); fc = true; } }
                    
                    if(line.startsWith('%T')) { 
                        let rt = line.substring(2).trim();
                        if (/Gal|Seyfert|LINER|IG|SB|SA|S0|Ellip|Irreg/i.test(rt)) ty = "Galassia a Spirale";
                        else if (/GlCl|Globular/i.test(rt)) ty = "Ammasso Globulare";
                        else if (/OpCl|Cl|Cluster/i.test(rt)) ty = "Ammasso Aperto";
                        else if (/PN|Planetary/i.test(rt)) ty = "Nebulosa Planetaria";
                        else if (/SNR|Supernova/i.test(rt)) ty = "Resto di Supernova";
                        else if (/HII|H2/i.test(rt)) ty = "Regione H II";
                        else if (/Neb|Mol|Cloud|Dark|RefNe/i.test(rt)) ty = "Nebulosa a Emissione";
                        else if (/\*|Star|V\*/i.test(rt)) ty = "Stella";
                    }
                    
                    if(line.startsWith('%M')) { 
                        let m = line.match(/([VBR])\s*=\s*([+\-]?\d+\.?\d*)/i);
                        if (m) { mg = `${m[2]} (${m[1].toUpperCase()})`; }
                        else { 
                            let num = line.substring(2).match(/[+\-]?\d+\.\d+/); 
                            if (num) mg = `~ ${num[0]}`; 
                        }
                    }
                }
                if (!fc) { if(st) { st.style.color = '#ff4444'; st.innerText = "Not Found."; } } 
                else {
                    if(st) st.innerText = "Wikipedia... üìö";
                    
                    // Lingua corrente
                    let wLang = (lang === 'it' || lang === 'es' || lang === 'zh') ? lang : 'en';
                    // Aggiungiamo un suffisso astronomico "forzato" per evitare fucili o giocatori di hockey!
                    let suffix = wLang === 'it' ? " astronomia" : wLang === 'es' ? " astronom√≠a" : wLang === 'zh' ? " Â§©ÊñáÂ≠¶" : " astronomy";
                    let wikiQ = q.trim() + suffix;
                    
                    let wikiApi = `https://${wLang}.wikipedia.org/w/api.php?action=query&format=json&origin=*&generator=search&gsrsearch=${encodeURIComponent(wikiQ)}&prop=extracts&exintro=1&explaintext=1&exchars=600&gsrlimit=1`;

                    fetch(wikiApi).then(w => w.json()).then(wd => {
                        if(st) st.style.display = 'none'; 
                        let sn = `Dati scaricati da server SIMBAD.\nTipologia: ${ty}.\nMagnitudine: ${mg}.`; 
                        // Link di fallback pulito (senza la parola "astronomia")
                        let wl = `https://${wLang}.wikipedia.org/w/index.php?search=${encodeURIComponent(q.trim())}`;
                        
                        if (wd.query && wd.query.pages) { 
                            let pid = Object.keys(wd.query.pages)[0]; 
                            if (wd.query.pages[pid].extract) { 
                                sn = wd.query.pages[pid].extract; 
                                wl = `https://${wLang}.wikipedia.org/?curid=${pid}`; 
                            } 
                        }
                        inp.value = ''; apriPianificazione({ name: q.toUpperCase(), ra: ra/15, dec: dec, type: ty, mag: mg, dist: "N/D", link: wl, desc: sn, tips: "Dati estratti dal server. Algoritmo Multi-Nottata in fase di sviluppo..." });
                    }).catch(e => { 
                        if(st) st.style.display = 'none'; inp.value = ''; 
                        apriPianificazione({ name: q.toUpperCase(), ra: ra/15, dec: dec, type: ty, mag: mg, dist: "N/D", link: `https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(q.trim())}`, desc: `Dati SIMBAD: ${ty}, Mag: ${mg}. Errore Wikipedia.`, tips: "Algoritmo Multi-Nottata in fase di sviluppo..." }); 
                    });
                }
            }).catch(e => { if(st) { st.style.color = '#ff4444'; st.innerText = "Network Error."; } });
        }

        // --- GESTIONE TOOLTIP FLUTTUANTE ---
        function mostraTooltip(el, key) {
            let tooltip = document.getElementById('floating-tooltip');
            tooltip.innerHTML = t(key);
            tooltip.style.display = 'block';
            
            let rect = el.getBoundingClientRect();
            let top = rect.top + window.scrollY - tooltip.offsetHeight - 15;
            let left = rect.left + window.scrollX - (tooltip.offsetWidth / 2) + (rect.width / 2);
            
            if (left < 10) left = 10;
            if ((left + tooltip.offsetWidth) > window.innerWidth) left = window.innerWidth - tooltip.offsetWidth - 10;
            if (top < window.scrollY) top = rect.bottom + window.scrollY + 15; 

            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
            
            setTimeout(() => { tooltip.style.opacity = '1'; }, 10);
        }

        function nascondiTooltip() {
            let tooltip = document.getElementById('floating-tooltip');
            tooltip.style.opacity = '0';
            setTimeout(() => { tooltip.style.display = 'none'; }, 200);
        }

        function apriGuida() { vistaPrecedente = document.getElementById('planning-view').style.display === 'block' ? 'planning-view' : 'dashboard-view'; document.getElementById('dashboard-view').style.display = 'none'; document.getElementById('planning-view').style.display = 'none'; document.getElementById('guide-view').style.display = 'block'; window.scrollTo(0,0); }
        function chiudiGuida() { document.getElementById('guide-view').style.display = 'none'; document.getElementById(vistaPrecedente).style.display = 'block'; if(vistaPrecedente==='planning-view') aggiornaFOV(); window.scrollTo(0,0); }

        window.onclick = function(event) {
            if (event.target == document.getElementById('report-modal')) { chiudiReport(); }
        }

        function apriPianificazione(tObj) {
            targetSelezionato = tObj; document.getElementById('dashboard-view').style.display = 'none'; document.getElementById('planning-view').style.display = 'block';
            document.getElementById('plan-target-name').innerText = getLocalizedName(targetSelezionato);
            document.getElementById('stat-type').innerText = mapTypeTrans(targetSelezionato.type) || "--";
            document.getElementById('stat-mag').innerText = targetSelezionato.mag || "--";
            document.getElementById('stat-dist').innerText = targetSelezionato.dist || "--";
            document.getElementById('target-description').innerText = getLocalizedText(targetSelezionato, 'desc');
            document.getElementById('target-tips').innerText = getLocalizedText(targetSelezionato, 'tips');
            let wl = document.getElementById('target-wiki'); if(targetSelezionato.link) { wl.href = targetSelezionato.link; wl.style.display = 'inline-block'; } else wl.style.display = 'none';
            
            let d = new Date(), at = SunCalc.getTimes(d, latCorrente, lonCorrente), ft = (x) => x && !isNaN(x) ? x.toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}) : '--:--';
            document.getElementById('info-sunset').innerText = ft(at.sunset); document.getElementById('info-nightstart').innerText = ft(at.night); document.getElementById('info-nightend').innerText = ft(at.nightEnd); document.getElementById('info-sunrise').innerText = ft(at.sunrise);
            if (ft(at.night) !== '--:--') document.getElementById('time-start').value = ft(at.night); if (ft(at.nightEnd) !== '--:--') document.getElementById('time-end').value = ft(at.nightEnd);

            if (!aladinSkyMap) { 
                aladinSkyMap = A.aladin('#aladin-lite-div', { survey: "P/DSS2/color", fov: 2, target: (targetSelezionato.ra * 15) + " " + targetSelezionato.dec, showReticle: false, showZoomControl: false, showFullscreenControl: false, showLayersControl: false, showGotoControl: false }); 
                setTimeout(() => { toggleMosaic(); }, 300); 
            } else { 
                setTimeout(() => { aladinSkyMap.gotoRaDec(targetSelezionato.ra * 15, targetSelezionato.dec); toggleMosaic(); }, 100); 
            }
            disegnaGraficoAltezza(); toggleSensorMode(); calcolaTempi(); window.scrollTo(0,0);
        }

        function tornaDashboard() { document.getElementById('planning-view').style.display = 'none'; document.getElementById('dashboard-view').style.display = 'block'; document.getElementById('search-dash-input').value = ''; document.getElementById('search-plan-input').value = ''; }
        function applicaPresetTelescopio() { let v = document.getElementById('preset-telescope').value; if(v){document.getElementById('focal-length').value=v; aggiornaFOV();} }
        function applicaPresetSensore() { let v = document.getElementById('preset-sensor').value; if(v){let p=v.split(',');document.getElementById('sensor-width').value=p[0];document.getElementById('sensor-height').value=p[1];aggiornaFOV();} }

        // --- MOTORE MOSAICO ---
        function toggleMosaic() {
            let isMosaic = document.getElementById('capture-mode').value === 'mosaic';
            document.getElementById('mosaic-settings').style.display = isMosaic ? 'flex' : 'none';
            document.getElementById('mosaic-fov-result').style.display = isMosaic ? 'block' : 'none';
            document.getElementById('btn-export-nina').style.display = isMosaic ? 'none' : 'inline-block';
            document.getElementById('btn-report-mosaic').style.display = isMosaic ? 'inline-block' : 'none';
            document.getElementById('nina-mosaic-msg').style.display = isMosaic ? 'block' : 'none';
            document.getElementById('mosaic-total-badge').style.display = isMosaic ? 'inline-block' : 'none';
            aggiornaFOV(); 
            calcolaTempi(); 
        }

        function aggiornaFOV() {
            let fl = parseFloat(document.getElementById('focal-length').value) || 1000;
            let sw = parseFloat(document.getElementById('sensor-width').value) || 23.5;
            let sh = parseFloat(document.getElementById('sensor-height').value) || 15.6;
            
            let fW = (2 * Math.atan(sw / (2 * fl)) * (180 / Math.PI));
            let fH = (2 * Math.atan(sh / (2 * fl)) * (180 / Math.PI));
            document.getElementById('fov-result').innerText = `${fW.toFixed(2)}¬∞ x ${fH.toFixed(2)}¬∞`;

            let isMosaic = document.getElementById('capture-mode').value === 'mosaic';
            let mx = 1, my = 1, overlap = 0;
            let totFovW = fW, totFovH = fH;

            if (isMosaic) {
                mx = parseInt(document.getElementById('mosaic-x').value) || 1;
                my = parseInt(document.getElementById('mosaic-y').value) || 1;
                overlap = (parseFloat(document.getElementById('mosaic-overlap').value) || 20) / 100;
                
                totFovW = fW * mx - fW * (mx - 1) * overlap;
                totFovH = fH * my - fH * (my - 1) * overlap;
                document.getElementById('mosaic-fov-result').innerText = `Totale: ${totFovW.toFixed(2)}¬∞ x ${totFovH.toFixed(2)}¬∞`;
            }

            let maxFov = Math.max(totFovW, totFovH);
            let cw = document.getElementById('fov-simulator-container').clientWidth;
            let cm = 2.5 / (parseFloat(document.getElementById('fov-zoom').value) / 100); 
            if (aladinSkyMap) { aladinSkyMap.setFoV(Math.max(0.01, maxFov * cm)); }

            let fovContainer = document.getElementById('fov-rectangle');
            fovContainer.innerHTML = ''; 
            fovContainer.style.border = "none";
            
            let aladinCurrentFov = Math.max(0.01, maxFov * cm);
            let pxPerDegree = cw / aladinCurrentFov;
            
            let rw = fW * pxPerDegree;
            let rh = fH * pxPerDegree;
            let stepPxX = rw * (1 - overlap);
            let stepPxY = rh * (1 - overlap);
            let totalW_px = rw + (mx - 1) * stepPxX;
            let totalH_px = rh + (my - 1) * stepPxY;

            fovContainer.style.width = totalW_px + "px";
            fovContainer.style.height = totalH_px + "px";
            fovContainer.style.left = `calc(50% - ${totalW_px/2}px)`;
            fovContainer.style.top = `calc(50% - ${totalH_px/2}px)`;

            for (let i = 0; i < mx; i++) {
                for (let j = 0; j < my; j++) {
                    let panel = document.createElement('div');
                    panel.style.position = "absolute";
                    panel.style.width = rw + "px";
                    panel.style.height = rh + "px";
                    panel.style.left = (i * stepPxX) + "px";
                    panel.style.top = (j * stepPxY) + "px";
                    panel.style.border = "2px solid #ff4444";
                    panel.style.boxSizing = "border-box";
                    panel.style.boxShadow = "inset 0 0 10px rgba(255, 68, 68, 0.3)";
                    
                    let pNum = document.createElement('span');
                    pNum.innerText = (j * mx + i + 1);
                    pNum.style.position = "absolute";
                    pNum.style.top = "2px";
                    pNum.style.left = "4px";
                    pNum.style.color = "#ff4444";
                    pNum.style.fontWeight = "bold";
                    pNum.style.fontSize = "12px";
                    
                    panel.appendChild(pNum);
                    fovContainer.appendChild(panel);
                }
            }

            let fovWarning = document.getElementById('fov-warning-msg');
            if (targetSelezionato && targetSelezionato.size) {
                let currentTotalArcmin = Math.min(totFovW, totFovH) * 60; 
                if (targetSelezionato.size > (currentTotalArcmin * 0.9)) { 
                    fovWarning.setAttribute('data-i18n', 'fov_warning');
                    fovWarning.style.display = 'block'; 
                    fovWarning.style.color = '#ffaa00';
                    fovWarning.innerHTML = t('fov_warning');
                } else { 
                    if (isMosaic) {
                        fovWarning.setAttribute('data-i18n', 'mosaic_active_msg');
                        fovWarning.style.display = 'block';
                        fovWarning.style.color = '#bb86fc';
                        fovWarning.innerHTML = t('mosaic_active_msg');
                    } else {
                        fovWarning.style.display = 'none'; 
                    }
                }
            } else { 
                if (isMosaic) {
                    fovWarning.setAttribute('data-i18n', 'mosaic_active_msg');
                    fovWarning.style.display = 'block';
                    fovWarning.style.color = '#bb86fc';
                    fovWarning.innerHTML = t('mosaic_active_msg');
                } else {
                    fovWarning.style.display = 'none'; 
                }
            }
        }

        function disegnaGraficoAltezza() {
            if (!targetSelezionato) return; if (chartAltezza) chartAltezza.destroy();
            let lbl = [], dat = [], d = new Date(), sd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 18, 0, 0);
            for (let i = 0; i <= 12; i++) { let fd = new Date(sd.getTime() + i*3600000); lbl.push(fd.getHours() + "h"); dat.push(Math.max(0, calcolaAltAz(targetSelezionato.ra, targetSelezionato.dec, latCorrente, lonCorrente, fd).alt)); }
            chartAltezza = new Chart(document.getElementById('altitudeChart').getContext('2d'), { type: 'line', data: { labels: lbl, datasets: [{ label: 'Alt (¬∞)', data: dat, borderColor: '#bb86fc', backgroundColor: 'rgba(187, 134, 252, 0.3)', tension: 0.4, fill: true, pointRadius: 2, borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 90, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#aaa', font: { size: 10 }, stepSize: 30 } }, x: { grid: { display: false }, ticks: { color: '#aaa', font: { size: 10 }, maxRotation: 0 } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, layout: { padding: 0 } } });
        }

        const framesColor = [{ id: "c-light", name: "Light", class: "f-l", dC: 0, dE: 180 }, { id: "c-dark", name: "Dark", class: "f-dark", dC: 0, dE: 180 }, { id: "c-bias", name: "Bias/Flat", class: "f-bias", dC: 0, dE: 0 }];
        const framesMono = [{ id: "m-l", name: "Lum (L)", class: "f-l", dC: 0, dE: 30 }, { id: "m-r", name: "Red (R)", class: "f-r", dC: 0, dE: 120 }, { id: "m-g", name: "Green (G)", class: "f-g", dC: 0, dE: 120 }, { id: "m-b", name: "Blue (B)", class: "f-b", dC: 0, dE: 120 }, { id: "m-ha", name: "H-Alpha", class: "f-ha", dC: 0, dE: 300 }, { id: "m-oiii", name: "O-III", class: "f-oiii", dC: 0, dE: 300 }, { id: "m-sii", name: "S-II", class: "f-sii", dC: 0, dE: 300 }, { id: "m-dark", name: "Dark", class: "f-dark", dC: 0, dE: 300 }, { id: "m-bias", name: "Bias/Flat", class: "f-bias", dC: 0, dE: 0 }];

        function toggleSensorMode() {
            let isM = document.getElementById('sensor-type').value === 'mono', c = document.getElementById('frames-container'); c.innerHTML = '';
            (isM ? framesMono : framesColor).forEach(f => {
                let isL = !f.id.includes('dark') && !f.id.includes('bias'), r = document.createElement('div'); r.className = `calc-row ${f.class}`;
                r.innerHTML = `<div style="display:flex; align-items:center; width: 140px;">${isL ? `<input type="checkbox" id="${f.id}-check" checked style="margin-right:10px; transform: scale(1.2); cursor: pointer;" onchange="calcolaTempi()">` : `<span style="display:inline-block; width: 23px; margin-right:10px;"></span>`}<label style="width:auto; cursor: ${isL?'pointer':'default'};" ${isL?`onclick="document.getElementById('${f.id}-check').click()"`:''}>${f.name}</label></div><div class="calc-inputs"><input type="number" id="${f.id}-count" value="${f.dC}" min="0" oninput="calcolaTempi()"> <span>x</span> <input type="number" id="${f.id}-exp" value="${f.dE}" min="0" oninput="calcolaTempi()"> <span>s</span></div><div class="calc-total" id="${f.id}-tot">0h 0m</div>`;
                c.appendChild(r);
            });
            aggiornaFiltriNina();
        }

        function calcolaTempi() {
            let tS = document.getElementById('time-start').value, tE = document.getElementById('time-end').value; if(!tS || !tE) return;
            let dS = new Date(`1970-01-01T${tS}:00`), dE = new Date(`1970-01-01T${tE}:00`); if (dE <= dS) dE.setDate(dE.getDate() + 1);
            let aS = (dE - dS) / 1000; 
            
            let isMosaic = document.getElementById('capture-mode').value === 'mosaic';
            let panels = 1;
            if (isMosaic) {
                let mx = parseInt(document.getElementById('mosaic-x').value) || 1;
                let my = parseInt(document.getElementById('mosaic-y').value) || 1;
                panels = mx * my;
                document.getElementById('mosaic-total-badge').innerText = `Target: ${panels} Pannelli`;
                aS = aS / panels;
            }
            document.getElementById('calc-available').innerHTML = isMosaic ? `<span style="font-size:0.6em; color:#ffaa00;">${t("time_per_panel")}<br></span>${Math.floor(aS/3600)}h ${Math.floor((aS%3600)/60)}m` : `${Math.floor(aS/3600)}h ${Math.floor((aS%3600)/60)}m`;

            let fL = document.getElementById('sensor-type').value === 'mono' ? framesMono : framesColor, tSec = 0, tLF = 0;
            
            fL.forEach(f => {
                let c = parseInt(document.getElementById(`${f.id}-count`).value)||0, e = parseInt(document.getElementById(`${f.id}-exp`).value)||0, rs = c * e;
                tSec += rs; if (!f.id.includes('dark') && !f.id.includes('bias')) tLF += c;
                document.getElementById(`${f.id}-tot`).innerText = Math.floor(rs/3600)>0 ? `${Math.floor(rs/3600)}h ${Math.floor((rs%3600)/60)}m` : `${Math.floor((rs%3600)/60)}m`;
            });

            let dC = document.getElementById('dither-check'), dSec = 0;
            if (dC && dC.checked) {
                let dF = parseInt(document.getElementById('dither-freq').value)||1, dD = parseInt(document.getElementById('dither-duration').value)||0;
                dSec = Math.floor(tLF / dF) * dD; tSec += dSec;
                document.getElementById('dither-tot').innerText = Math.floor(dSec/3600)>0 ? `${Math.floor(dSec/3600)}h ${Math.floor((dSec%3600)/60)}m` : `${Math.floor((dSec%3600)/60)}m`;
            } else document.getElementById('dither-tot').innerText = `0m`;

            document.getElementById('calc-total').innerText = `${Math.floor(tSec/3600)}h ${Math.floor((tSec%3600)/60)}m`;
            let rS = aS - tSec, rD = document.getElementById('calc-residual'), wD = document.getElementById('calc-warning');
            if (rS >= 0) { rD.innerText = `${Math.floor(rS/3600)}h ${Math.floor((rS%3600)/60)}m`; rD.className = "text-green"; wD.style.display = "none"; } 
            else { let oS = Math.abs(rS); rD.innerText = `- ${Math.floor(oS/3600)}h ${Math.floor((oS%3600)/60)}m`; rD.className = "text-red"; wD.style.display = "block"; }
        }

        function generaSequenzaOttimale() {
            if (!targetSelezionato) { alert(t("alert_planetarium")); return; }
            let tS = document.getElementById('time-start').value, tE = document.getElementById('time-end').value; if(!tS || !tE) { alert(t("alert_times")); return; }
            let dS = new Date(`1970-01-01T${tS}:00`), dE = new Date(`1970-01-01T${tE}:00`); if (dE <= dS) dE.setDate(dE.getDate() + 1);
            let aS = (dE - dS) / 1000;
            
            let isMosaic = document.getElementById('capture-mode').value === 'mosaic';
            if (isMosaic) {
                let mx = parseInt(document.getElementById('mosaic-x').value) || 1;
                let my = parseInt(document.getElementById('mosaic-y').value) || 1;
                aS = aS / (mx * my);
            }

            let isM = document.getElementById('sensor-type').value === 'mono', fL = isM ? framesMono : framesColor, cS = 0;
            
            fL.forEach(f => { if (f.id.includes('dark') || f.id.includes('bias')) cS += (parseInt(document.getElementById(`${f.id}-count`).value)||0) * (parseInt(document.getElementById(`${f.id}-exp`).value)||0); });
            let rS = aS - cS; if (rS <= 0) { alert(t("alert_calib")); return; }
            
            let aL = []; fL.forEach(f => { if (!f.id.includes('dark') && !f.id.includes('bias')) { let c = document.getElementById(`${f.id}-check`); if (c && c.checked) aL.push(f); } });
            if (aL.length === 0) { alert(t("alert_nolight")); return; }

            let w = {};
            if (!isM) w[aL[0].id] = 1.0;
            else {
                let hL = aL.some(f=>f.id==='m-l'), hRGB = aL.some(f=>f.id==='m-r')&&aL.some(f=>f.id==='m-g')&&aL.some(f=>f.id==='m-b');
                if (hL && hRGB && aL.length === 4) { w['m-l']=0.5; w['m-r']=0.1666; w['m-g']=0.1666; w['m-b']=0.1666; } 
                else { let eq = 1.0 / aL.length; aL.forEach(f => w[f.id] = eq); }
            }

            let ty = targetSelezionato.type ? targetSelezionato.type.toLowerCase() : "", isA = ty.includes('ammasso')||ty.includes('cluster'), isG = ty.includes('galassia')||ty.includes('galaxy')||ty.includes('riflessione')||ty.includes('stella')||ty.includes('star');
            let dC = document.getElementById('dither-check'), uD = dC && dC.checked, dF = parseInt(document.getElementById('dither-freq').value)||1, dD = parseInt(document.getElementById('dither-duration').value)||0;

            aL.forEach(f => {
                let eS = 180;
                if (f.id === 'm-l') eS = 30; else if (f.id.includes('ha')||f.id.includes('oiii')||f.id.includes('sii')) eS = 300; else if (isA) eS = 60; else if (isG) eS = 120;
                let eeS = eS + (uD && dF > 0 ? dD / dF : 0);
                document.getElementById(`${f.id}-exp`).value = eS; document.getElementById(`${f.id}-count`).value = Math.floor((rS * w[f.id]) / eeS);
            });

            fL.forEach(f => { if (!f.id.includes('dark') && !f.id.includes('bias')) { let c = document.getElementById(`${f.id}-check`); if (c && !c.checked) { document.getElementById(`${f.id}-count`).value = 0; document.getElementById(`${f.id}-exp`).value = f.dE; } } });
            calcolaTempi();
        }

        function aggiornaFiltriNina() {
            let isM = document.getElementById('sensor-type').value === 'mono', c = document.getElementById('nina-filters-container'); if (!c) return;
            c.innerHTML = '';
            if (!isM) { c.innerHTML = `<span style="color:#aaa; font-size:0.9em;">OSC Camera.</span>`; return; }
            framesMono.forEach(f => {
                if (!f.id.includes('dark') && !f.id.includes('bias')) {
                    let savedName = localStorage.getItem('nina_filter_' + f.id) || f.name;
                    let d = document.createElement('div'); d.style = "display: flex; align-items: center; justify-content: space-between; font-size: 0.85em; background: #1a1a1a; padding: 5px 10px; border-radius: 4px; border: 1px solid #444;";
                    d.innerHTML = `<label style="color:#aaa; width:auto; margin:0; font-weight:bold;">${f.name}</label><input type="text" id="nina-name-${f.id}" value="${savedName}" onchange="salvaFiltroNina('${f.id}')" style="width: 80px!important; padding: 4px!important; font-size: 0.9em; background: #222; border-color: #555;">`;
                    c.appendChild(d);
                }
            });
        }
        function salvaFiltroNina(id) { localStorage.setItem('nina_filter_' + id, document.getElementById(`nina-name-${id}`).value.trim()); }

        function esportaNINA() {
            if (!targetSelezionato) { alert(t("alert_planetarium")); return; }
            let doCool = document.getElementById('nina-cool').checked, tempTarget = parseFloat(document.getElementById('nina-temp').value) || -10;
            let doSlew = document.getElementById('nina-slew').checked, doGuide = document.getElementById('nina-guide').checked, doWarm = document.getElementById('nina-warm').checked, doPark = document.getElementById('nina-park').checked, doFlip = document.getElementById('nina-flip').checked, doDither = document.getElementById('dither-check') && document.getElementById('dither-check').checked, ditherFreq = parseInt(document.getElementById('dither-freq').value) || 1;
            let isMono = document.getElementById('sensor-type').value === 'mono', frameList = isMono ? framesMono : framesColor, esposizioni = [];

            frameList.forEach(f => {
                let count = parseInt(document.getElementById(`${f.id}-count`).value) || 0, exp = parseInt(document.getElementById(`${f.id}-exp`).value) || 0;
                if (count > 0 && exp > 0) { let isLight = !f.id.includes('dark') && !f.id.includes('bias'); esposizioni.push({ count: count, exp: exp, filter: (isMono && isLight) ? document.getElementById(`nina-name-${f.id}`).value.trim() : null, type: f.id.includes('dark') ? "DARK" : f.id.includes('bias') ? "FLAT" : "LIGHT" }); }
            });
            if (esposizioni.length === 0) { alert(t("alert_noseq")); return; }

            let idCounter = 1; function nextId() { return (idCounter++).toString(); }
            function makeObs(type, values) { return { "$id": nextId(), "$type": `System.Collections.ObjectModel.ObservableCollection\`1[[${type}, NINA.Sequencer]], System.ObjectModel`, "$values": values }; }
            let ra = targetSelezionato.ra, rh = Math.floor(ra), rm = Math.floor((ra - rh) * 60), rs = ((ra - rh) * 60 - rm) * 60;
            let dec = targetSelezionato.dec, negD = dec < 0, aD = Math.abs(dec), dd = Math.floor(aD), dm = Math.floor((aD - dd) * 60), ds = ((aD - dd) * 60 - dm) * 60;
            let rootId = nextId(), startAreaId = nextId(), targetAreaId = nextId(), endAreaId = nextId(), startItems = [];
            if (doCool) startItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Camera.CoolCamera, NINA.Sequencer", "Temperature": tempTarget, "Duration": 0.0, "Parent": {"$ref": startAreaId}, "ErrorBehavior": 0, "Attempts": 1 });
            let dsoContainerId = nextId(), imagingContainerId = nextId(), dsoItems = [];
            if (doSlew) dsoItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Platesolving.Center, NINA.Sequencer", "Inherited": true, "Coordinates": { "$id": nextId(), "$type": "NINA.Astrometry.InputCoordinates, NINA.Astrometry", "RAHours": rh, "RAMinutes": rm, "RASeconds": rs, "NegativeDec": negD, "DecDegrees": dd, "DecMinutes": dm, "DecSeconds": ds }, "Parent": {"$ref": dsoContainerId}, "ErrorBehavior": 0, "Attempts": 1 });
            if (doGuide) dsoItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Guider.StartGuiding, NINA.Sequencer", "ForceCalibration": false, "Parent": {"$ref": dsoContainerId}, "ErrorBehavior": 0, "Attempts": 1 });

            let imagingItems = [];
            esposizioni.forEach(expo => {
                let blockId = nextId(), blockItems = [];
                if (expo.filter) blockItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.FilterWheel.SwitchFilter, NINA.Sequencer", "Filter": { "$id": nextId(), "$type": "NINA.Core.Model.Equipment.FilterInfo, NINA.Core", "_name": expo.filter, "_focusOffset": 0, "_position": 0, "_autoFocusExposureTime": -1.0, "_autoFocusFilter": false }, "Parent": {"$ref": blockId}, "ErrorBehavior": 0, "Attempts": 1 });
                blockItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Imaging.TakeExposure, NINA.Sequencer", "ExposureTime": expo.exp, "Gain": -1, "Offset": -1, "Binning": { "$id": nextId(), "$type": "NINA.Core.Model.Equipment.BinningMode, NINA.Core", "X": 1, "Y": 1 }, "ImageType": expo.type, "ExposureCount": expo.count, "Parent": {"$ref": blockId}, "ErrorBehavior": 0, "Attempts": 1 });
                let blockTriggers = [];
                if (doDither && expo.type === "LIGHT" && ditherFreq > 0) {
                    let trigRunnerId = nextId(); blockTriggers.push({ "$id": nextId(), "$type": "NINA.Sequencer.Trigger.Guider.DitherAfterExposures, NINA.Sequencer", "AfterExposures": ditherFreq, "Parent": {"$ref": blockId}, "TriggerRunner": { "$id": trigRunnerId, "$type": "NINA.Sequencer.Container.SequentialContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", [{ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Guider.Dither, NINA.Sequencer", "Parent": {"$ref": trigRunnerId}, "ErrorBehavior": 0, "Attempts": 1 }]), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": null, "ErrorBehavior": 0, "Attempts": 1 } });
                }
                imagingItems.push({ "$id": blockId, "$type": "NINA.Sequencer.Container.SequentialContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": expo.filter ? `Ripresa ${expo.filter}` : `Ripresa ${expo.type}`, "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", blockItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", blockTriggers), "Parent": {"$ref": imagingContainerId}, "ErrorBehavior": 0, "Attempts": 1 });
            });

            let imagingTriggers = [];
            if (doFlip) { let trigRunnerId = nextId(); imagingTriggers.push({ "$id": nextId(), "$type": "NINA.Sequencer.Trigger.MeridianFlip.MeridianFlipTrigger, NINA.Sequencer", "Parent": {"$ref": imagingContainerId}, "TriggerRunner": { "$id": trigRunnerId, "$type": "NINA.Sequencer.Container.SequentialContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", []), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": null, "ErrorBehavior": 0, "Attempts": 1 } }); }
            dsoItems.push({ "$id": imagingContainerId, "$type": "NINA.Sequencer.Container.SequentialContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": "Target Imaging", "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", imagingItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", imagingTriggers), "Parent": {"$ref": dsoContainerId}, "ErrorBehavior": 0, "Attempts": 1 });

            let targetItems = [{ "$id": dsoContainerId, "$type": "NINA.Sequencer.Container.DeepSkyObjectContainer, NINA.Sequencer", "Target": { "$id": nextId(), "$type": "NINA.Astrometry.InputTarget, NINA.Astrometry", "Expanded": true, "TargetName": targetSelezionato.name, "PositionAngle": 0.0, "InputCoordinates": { "$id": nextId(), "$type": "NINA.Astrometry.InputCoordinates, NINA.Astrometry", "RAHours": rh, "RAMinutes": rm, "RASeconds": rs, "NegativeDec": negD, "DecDegrees": dd, "DecMinutes": dm, "DecSeconds": ds } }, "ExposureInfoListExpanded": false, "ExposureInfoList": null, "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": targetSelezionato.name, "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", dsoItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": {"$ref": targetAreaId}, "ErrorBehavior": 0, "Attempts": 1 }];

            let endItems = [];
            if (doWarm) endItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Camera.WarmCamera, NINA.Sequencer", "Duration": 0.0, "Parent": {"$ref": endAreaId}, "ErrorBehavior": 0, "Attempts": 1 });
            if (doPark) endItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Telescope.ParkScope, NINA.Sequencer", "Parent": {"$ref": endAreaId}, "ErrorBehavior": 0, "Attempts": 1 });

            let ninaJSON = { "$id": rootId, "$type": "NINA.Sequencer.Container.SequenceRootContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": `AstroDashboard - ${targetSelezionato.name}`, "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", [ { "$id": startAreaId, "$type": "NINA.Sequencer.Container.StartAreaContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": "Start", "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", startItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": {"$ref": rootId}, "ErrorBehavior": 0, "Attempts": 1 }, { "$id": targetAreaId, "$type": "NINA.Sequencer.Container.TargetAreaContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": "Target", "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", targetItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": {"$ref": rootId}, "ErrorBehavior": 0, "Attempts": 1 }, { "$id": endAreaId, "$type": "NINA.Sequencer.Container.EndAreaContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": "End", "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", endItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": {"$ref": rootId}, "ErrorBehavior": 0, "Attempts": 1 } ]), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": null, "ErrorBehavior": 0, "Attempts": 1 };

            let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(ninaJSON, null, 2));
            let dlAnchorElem = document.createElement('a'); dlAnchorElem.setAttribute("href", dataStr); dlAnchorElem.setAttribute("download", `AD_Seq_${targetSelezionato.name.replace(/\s+/g, '_')}.json`); document.body.appendChild(dlAnchorElem); dlAnchorElem.click(); dlAnchorElem.remove();
        }

        function apriReport() {
            if (!targetSelezionato) { alert(t("alert_planetarium")); return; }
            let isM = document.getElementById('sensor-type').value === 'mono';
            let frameList = isM ? framesMono : framesColor;
            
            let mx = parseInt(document.getElementById('mosaic-x').value) || 1;
            let my = parseInt(document.getElementById('mosaic-y').value) || 1;
            let overlap = parseInt(document.getElementById('mosaic-overlap').value) || 20;
            let panels = mx * my;

            let tS = document.getElementById('time-start').value;
            let tE = document.getElementById('time-end').value;
            if(!tS || !tE) { alert(t("alert_times")); return; }
            let dS = new Date(`1970-01-01T${tS}:00`); let dE = new Date(`1970-01-01T${tE}:00`); 
            if (dE <= dS) dE.setDate(dE.getDate() + 1);
            let aS = (dE - dS) / 1000;
            
            let formatTime = (secs) => `${Math.floor(secs/3600)}h ${Math.floor((secs%3600)/60)}m`;
            let totalTimeStr = formatTime(aS);
            let panelTimeStr = formatTime(aS / panels);
            
            let dC = document.getElementById('dither-check').checked;
            let dFreq = document.getElementById('dither-freq').value;

            let planHtml = '';
            let rawText = `=== DOSSIER MOSAICO ===\nTARGET: ${getLocalizedName(targetSelezionato)}\n`;
            rawText += `PANNELLI: ${mx}x${my} (${panels} totali)\nSOVRAPPOSIZIONE: ${overlap}%\nTEMPO TOTALE: ${totalTimeStr}\n\n`;
            rawText += `--- STRATEGIA SINGOLO PANNELLO ---\nTempo max a pannello: ${panelTimeStr}\nDithering: ${dC ? 'Ogni '+dFreq+' scatti' : 'Disattivato'}\n\n--- PIANO DI SCATTO ---\n`;

            let hasPoses = false;
            frameList.forEach(f => {
                let count = parseInt(document.getElementById(`${f.id}-count`).value) || 0;
                let exp = parseInt(document.getElementById(`${f.id}-exp`).value) || 0;
                if(count > 0 && exp > 0) {
                    hasPoses = true;
                    let filterName = (isM && (!f.id.includes('dark') && !f.id.includes('bias'))) ? document.getElementById(`nina-name-${f.id}`).value : f.name;
                    planHtml += `<div class="report-line"><span>${filterName}</span><b>${count}x ${exp}s</b></div>`;
                    rawText += `${filterName}: ${count}x ${exp}s\n`;
                }
            });

            if (!hasPoses) { alert(t("alert_noseq")); return; }

            let html = `
                <div class="report-section">
                    <h4>${t("report_general")}</h4>
                    <div class="report-line"><span>Target:</span><b>${getLocalizedName(targetSelezionato)}</b></div>
                    <div class="report-line"><span>Griglia:</span><b>${mx}x${my} (${panels})</b></div>
                    <div class="report-line"><span>${t("overlap").replace(':','')} :</span><b>${overlap}%</b></div>
                    <div class="report-line"><span>Tempo Totale:</span><b>${totalTimeStr}</b></div>
                </div>
                <div class="report-section">
                    <h4>${t("report_strategy")}</h4>
                    <div class="report-line"><span style="color:#44ff44;">Tempo a Pannello:</span><b style="color:#44ff44;">${panelTimeStr}</b></div>
                    <div class="report-line"><span>Dithering:</span><b>${dC ? dFreq+' frames' : 'Off'}</b></div>
                </div>
                <div class="report-section">
                    <h4>${t("report_plan")}</h4>
                    ${planHtml}
                </div>
            `;
            
            document.getElementById('report-content').innerHTML = html;
            document.getElementById('btn-copy-report').setAttribute('data-raw', rawText);
            document.getElementById('btn-copy-report').innerHTML = `üìã ${t("copy_report")}`;
            document.getElementById('report-modal').style.display = 'block';
        }

        function chiudiReport() {
            document.getElementById('report-modal').style.display = 'none';
        }

        function copiaReport() {
            let txt = document.getElementById('btn-copy-report').getAttribute('data-raw');
            navigator.clipboard.writeText(txt).then(() => {
                document.getElementById('btn-copy-report').innerHTML = `‚úÖ ${t("copied")}`;
                setTimeout(() => { document.getElementById('btn-copy-report').innerHTML = `üìã ${t("copy_report")}`; }, 2000);
            });
        }

        window.addEventListener('resize', () => { if(document.getElementById('planning-view').style.display === 'block') aggiornaFOV(); });
        
        document.addEventListener('DOMContentLoaded', () => {
            changeLanguage(lang);
            popolaMenuAttrezzatura();
            aggiornaEffemeridi(new Date()); 
            scaricaDatiPrevisionali();

            // "Rubiamo" la rotellina del mouse nel simulatore FOV
            let fovContainer = document.getElementById('fov-simulator-container');
            if (fovContainer) {
                fovContainer.addEventListener('wheel', function(e) {
                    e.preventDefault(); // Blocca lo scroll della pagina
                    e.stopPropagation(); // Blocca lo zoom nativo sfasato di Aladin
                    
                    let zoomSlider = document.getElementById('fov-zoom');
                    let currentVal = parseInt(zoomSlider.value);
                    
                    // Rotellina su (zoom in) = +15, gi√π (zoom out) = -15
                    if (e.deltaY < 0) { currentVal += 15; } else { currentVal -= 15; }
                    
                    // Rispettiamo i limiti minimi e massimi dello slider
                    if (currentVal < 20) currentVal = 20;
                    if (currentVal > 500) currentVal = 500;
                    
                    zoomSlider.value = currentVal;
                    aggiornaFOV(); // Sincronizza lo sfondo e il rettangolo contemporaneamente!
                }, { passive: false, capture: true });
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(reg => {
                    console.log('App in background attivata!', reg.scope);
                }).catch(err => console.error('Errore App:', err));
            });
        }
    </script>
</body>
</html>