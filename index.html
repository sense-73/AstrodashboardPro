<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroDashboard v3.5 - Pianificatore Celeste</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://aladin.cds.unistra.fr/AladinLite/api/v2/latest/aladin.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://aladin.cds.unistra.fr/AladinLite/api/v2/latest/aladin.min.js"></script>

    <script src="database.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #121212; color: #e0e0e0; text-align: center; margin: 0; padding: 20px; }
        h2 { color: #bb86fc; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; display: flex; align-items: center; justify-content: center; gap: 10px;}
        h3 { margin-top: 0; color: #fff; display: flex; align-items: center; gap: 8px;}
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 20px; max-width: 1200px; margin: 0 auto; }
        .panel { background-color: #1e1e1e; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); text-align: left; flex: 1; min-width: 320px; }
        .info-icon { font-size: 0.85em; cursor: pointer; opacity: 0.6; transition: 0.2s; filter: grayscale(100%); }
        .info-icon:hover { opacity: 1; filter: grayscale(0) drop-shadow(0 0 5px rgba(187, 134, 252, 0.8)); transform: scale(1.1);}
        
        .main-header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; max-width: 1200px; margin: 0 auto 20px auto; background: #1a1a1a; padding: 15px 25px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .center-logo { height: 120px; object-fit: contain; justify-self: center; filter: drop-shadow(0 0 8px rgba(187, 134, 252, 0.2));}
        .author-section { display: flex; align-items: center; gap: 15px; background: #222; padding: 10px 15px; border-radius: 8px; border: 1px solid #444; justify-self: end; text-align: right;}
        .btn-guide { background: transparent; border: 1px solid #bb86fc; color: #bb86fc; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: 0.2s; font-weight: bold; margin-top: 5px;}
        .btn-guide:hover { background: #bb86fc; color: #121212;}

        .ephemeris-box { display: flex; justify-content: space-around; align-items: center; background-color: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; width: 100%; flex-wrap: wrap;}
        .moon-container { display: flex; flex-direction: column; align-items: center; margin-right: 20px; min-width: 120px;}
        .moon-icon { font-size: 3.5em; text-shadow: 0 0 15px rgba(255, 255, 170, 0.4); margin-bottom: 5px;}
        .moon-phase-name { font-size: 0.9em; font-weight: bold; color: #bb86fc; text-transform: uppercase; text-align: center;}
        .weather-container { display: flex; flex-direction: column; align-items: center; justify-content: center; border-left: 1px solid #444; border-right: 1px solid #444; padding: 0 20px; min-width: 100px; margin: 10px 0;}
        .times-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; width: 100%; flex: 1; min-width: 300px; padding-left: 20px;}
        .time-item { text-align: center; font-size: 0.9em; color: #aaa;}
        .icon-normal { font-style: normal; font-size: 1.8em; display: block; margin-bottom: 5px; }
        .time-item span { font-size: 1.3em; font-weight: bold; color: #fff; display: block; margin-top: 3px;}

        .input-group { margin-bottom: 12px; position: relative; }
        label { display: inline-block; width: 100px; color: #aaa; font-size: 0.9em;}
        input[type="text"]:not(.search-local-input), input[type="number"], select { width: calc(100% - 125px); cursor: pointer; }
        input[type="text"], input[type="number"], select, input[type="time"] { padding: 8px; border-radius: 4px; border: 1px solid #333; background-color: #2c2c2c; color: #fff; font-family: inherit; box-sizing: border-box;}
        input[type="time"] { width: 130px !important; text-align: center; } 
        #dropdown-risultati { list-style: none; padding: 0; margin: 0; position: absolute; width: calc(100% - 125px); background-color: #2c2c2c; border: 1px solid #444; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; left: 105px; display: none; text-align: left;}
        #dropdown-risultati li { padding: 10px; cursor: pointer; border-bottom: 1px solid #444; font-size: 0.9em; }
        #dropdown-risultati li:hover { background-color: #bb86fc; color: #121212; font-weight: bold; }
        #map { height: 500px; width: 100%; border: 2px solid #333; border-radius: 8px; z-index: 1; }
        
        .timeline-container { margin-top: 20px; padding: 15px; background-color: #2a2a2a; border-radius: 8px; text-align: center; width: 100%; box-sizing: border-box;}
        input[type="range"] { width: 100%; cursor: pointer; margin-top: 10px;}
        .time-display { font-size: 1.3em; color: #bb86fc; font-weight: bold; margin-bottom: 5px; text-transform: capitalize;}
        
        .meteo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-top: 15px; }
        .meteo-item { background-color: #2a2a2a; padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; transition: 0.3s; user-select: none; border: 2px solid transparent;}
        .meteo-item:hover { filter: brightness(1.2); }
        .meteo-item h4 { margin: 0 0 5px 0; font-size: 0.85em; color: #aaa; }
        .meteo-item span { font-size: 1.4em; font-weight: bold; }
        .jet-unit { font-size: 0.6em; font-weight: normal; color: #ccc; }
        .disabled { opacity: 0.4; filter: grayscale(100%); background-color: #1a1a1a; }
        .m-bassa.active { border-color: #ff4444; } .m-media.active { border-color: #44ff44; } .m-alta.active { border-color: #4444ff; } .m-jet.active { border-color: #ff00ff; } .m-luna.active { border-color: #ffffaa; } .m-umidita.active { border-color: #00ffff;} .m-seeing { border-color: #bb86fc; cursor: default;}

        .dso-container { margin-top: 20px; text-align: left; padding: 20px; background-color: #1a1a1a; border-radius: 8px;}
        .astro-section { width: 100%; display: block; }
        .horizontal-scroll { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 15px; margin-top: 10px; scrollbar-width: thin; scrollbar-color: #bb86fc #2a2a2a; flex-wrap: nowrap;}
        .horizontal-scroll::-webkit-scrollbar { height: 8px; }
        .horizontal-scroll::-webkit-scrollbar-track { background-color: #1e1e1e; border-radius: 4px; }
        .horizontal-scroll::-webkit-scrollbar-thumb { background-color: #444; border-radius: 4px; }
        .horizontal-scroll::-webkit-scrollbar-thumb:hover { background-color: #bb86fc; }

        .dso-card { flex: 0 0 auto; width: 220px; background-color: #2a2a2a; border: 1px solid #333; padding: 15px; border-radius: 8px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.5); position: relative;}
        .card-clickable { cursor: pointer; transition: transform 0.2s; }
        .card-clickable:hover { transform: translateY(-5px); background-color: #333;}
        .card-static { cursor: default; opacity: 0.7; filter: grayscale(50%);}
        .dso-icon { font-size: 2.5em; margin-right: 15px; filter: drop-shadow(0px 0px 5px rgba(187, 134, 252, 0.4));}
        .dso-info h4 { margin: 0 0 5px 0; font-size: 0.9em; color: #fff;}
        .dso-info p { margin: 0; font-size: 0.85em; color: #aaa;}
        .dso-direction { display: inline-block; padding: 2px 6px; background-color: #bb86fc; color: #121212; border-radius: 4px; font-weight: bold; font-size: 0.8em; margin-top: 5px;}
        .top-target { border: 2px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .top-target::after { content: '‚≠ê Consigliato'; position: absolute; top: -10px; right: 10px; background-color: #ffd700; color: #000; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; font-weight: bold;}

        /* RICERCA IBRIDA */
        .search-local-box { background-color: #2a2a2a; padding: 15px; border-radius: 8px; margin-top: 25px; text-align: center; border: 1px solid #444; }
        .search-local-box h4 { margin: 0 0 10px 0; color: #fff; font-size: 1.1em;}
        .search-wrapper { position: relative; display: inline-block; text-align: left; }
        .search-local-input { width: 350px !important; max-width: 100%; padding: 12px 15px !important; border-radius: 5px; border: 1px solid #555 !important; background-color: #1e1e1e !important; color: #fff !important; font-size: 1.1em !important; cursor: text !important; letter-spacing: 0.5px;}
        .search-local-input:focus { outline: none; border-color: #bb86fc !important; box-shadow: 0 0 8px rgba(187,134,252,0.3); }
        .btn-search { padding: 12px 25px; background-color: #bb86fc; color: #121212; border: none; border-radius: 5px; font-weight: bold; font-size: 1.1em; cursor: pointer; transition: 0.2s; margin-left: 10px;}
        .btn-search:hover { background-color: #a361f9; }
        .search-suggestions { position: absolute; top: 100%; left: 0; width: 350px; background-color: #2c2c2c; border: 1px solid #555; border-top: none; border-radius: 0 0 5px 5px; max-height: 250px; overflow-y: auto; z-index: 2000; list-style: none; padding: 0; margin: 0; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.8);}
        .search-suggestions li { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #333; color: #ddd; font-size: 1em; display: flex; align-items: center; gap: 10px;}
        .search-suggestions li:hover { background-color: #bb86fc; color: #121212; font-weight: bold; }
        .search-status { margin: 10px 0 0 0; font-size: 0.9em; display: none; text-align: center; width: 100%; font-weight: bold;}

        /* PLANNING VIEW */
        #planning-view { display: none; text-align: left; max-width: 1200px; margin: 0 auto;}
        .btn-back { background: linear-gradient(135deg, #7c4dff 0%, #bb86fc 100%); color: #ffffff; border: none; padding: 12px 28px; border-radius: 50px; cursor: pointer; font-size: 1.1em; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(124, 77, 255, 0.3); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); letter-spacing: 0.5px; text-transform: uppercase;}
        .btn-back:hover { background: linear-gradient(135deg, #9e75ff 0%, #d2aaff 100%); box-shadow: 0 8px 25px rgba(187, 134, 252, 0.5), 0 0 10px rgba(255,255,255,0.2) inset; transform: translateY(-3px) scale(1.02); color: #fff; }
        .btn-back:active { transform: translateY(-1px) scale(0.98); box-shadow: 0 4px 10px rgba(124, 77, 255, 0.3); }
        .planning-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}

        /* DOSSIER */
        .stat-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;}
        .stat-box { background: #2a2a2a; padding: 10px; border-radius: 5px; flex: 1; min-width: 120px; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .stat-box.t-type { border-left: 3px solid #bb86fc; }
        .stat-box.t-mag { border-left: 3px solid #44ff44; }
        .stat-box.t-dist { border-left: 3px solid #ffaa00; }
        .stat-box span { font-size: 0.8em; color: #aaa; text-transform: uppercase;}
        .stat-box b { display: block; font-size: 1.1em; color: #fff; margin-top: 3px;}
        .info-box { background-color: #222; border-left: 4px solid #bb86fc; padding: 15px; margin-bottom: 10px; border-radius: 4px; font-size: 0.95em; line-height: 1.5; color: #ddd;}
        .tip-box { background-color: rgba(255, 215, 0, 0.1); border-left: 4px solid #ffd700; padding: 15px; border-radius: 4px; font-size: 0.95em; color: #fff;}
        .wiki-link { display: inline-block; margin-top: 10px; color: #bb86fc; text-decoration: none; font-weight: bold;}
        .wiki-link:hover { color: #fff; text-decoration: underline;}

        .planning-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        @media (max-width: 768px) { .planning-grid { grid-template-columns: 1fr; } }
        .fov-simulator-container { background-color: #000; height: 400px; border-radius: 8px; border: 2px solid #444; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center;}
        #aladin-lite-div { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;}
        #fov-rectangle { position: absolute; border: 2px solid #ff4444; box-shadow: inset 0 0 10px rgba(255, 68, 68, 0.3), 0 0 10px rgba(255, 68, 68, 0.5); pointer-events: none; transition: width 0.1s, height 0.1s; z-index: 1000;}
        .center-cross { position: absolute; color: rgba(68, 255, 68, 0.7); font-size: 1.5em; pointer-events: none; z-index: 1000;}
        .chart-container { background-color: #1e1e1e; padding: 15px; border-radius: 8px; height: 160px; margin-top: 15px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);}
        .zoom-control { display: flex; align-items: center; justify-content: center; padding: 10px; background: #2a2a2a; border-radius: 0 0 8px 8px;}

        /* SESSION CALCULATOR & SMART BUTTON */
        .session-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 768px) { .session-grid { grid-template-columns: 1fr; } }
        
        .calc-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: #222; border-radius: 5px; border-left: 3px solid #555;}
        .calc-row label { color: #fff; font-weight: bold; margin: 0; font-size: 0.9em; cursor: pointer;}
        .calc-inputs { display: flex; gap: 10px; align-items: center;}
        .calc-inputs input { width: 70px !important; padding: 5px !important; text-align: center;}
        .calc-total { width: 80px; text-align: right; color: #aaa; font-size: 0.9em;}
        .f-l { border-color: #fff !important; } .f-r { border-color: #ff4444 !important; } .f-g { border-color: #44ff44 !important; } .f-b { border-color: #4444ff !important; }
        .f-ha { border-color: #ff0055 !important; } .f-oiii { border-color: #00ffff !important; } .f-sii { border-color: #ffaa00 !important; }
        .f-dark { border-color: #555 !important; } .f-bias { border-color: #888 !important; }
        
        .time-summary { background-color: #2a2a2a; padding: 20px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center;}
        .summary-box { padding: 15px; margin-bottom: 10px; border-radius: 5px; background: #1a1a1a; border: 1px solid #333;}
        .summary-box h4 { margin: 0 0 5px 0; color: #aaa;}
        .summary-box span { font-size: 1.5em; font-weight: bold; color: #fff;}
        .text-red { color: #ff4444 !important; }
        .text-green { color: #44ff44 !important; }
        .twilight-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background-color: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;}
        .twilight-item span.icon { font-size: 1.8em; display: block; margin-bottom: 5px; }
        .twilight-item span.label { color: #aaa; font-size: 0.8em; text-transform: uppercase; }
        .twilight-item b { display: block; font-size: 1.2em; margin-top: 5px; color: #fff;}
        .twilight-night { color: #bb86fc !important; }
        
        .smart-button-container { text-align: center; margin: 15px 0 25px 0; padding: 15px; background: rgba(187, 134, 252, 0.1); border-radius: 8px; border: 1px dashed #bb86fc; }
        .btn-smart { background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); color: white; padding: 12px 30px; font-size: 1.1em; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);}
        .btn-smart:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 20px rgba(0, 114, 255, 0.5);}

        /* GUIDE VIEW */
        #guide-view { display: none; text-align: left; max-width: 1000px; margin: 0 auto; background-color: #1e1e1e; padding: 40px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.8); line-height: 1.7; color: #ddd; }
        .guide-section { margin-bottom: 35px; padding-bottom: 25px; border-bottom: 1px solid #333;}
        .guide-section h3 { color: #bb86fc; margin-top: 0; font-size: 1.5em; border-bottom: none;}
        .guide-section ul { margin-left: 20px; color: #bbb; }
        .guide-section li { margin-bottom: 12px; }
        .guide-section strong { color: #fff; }
        .filosofia-box { background: rgba(187,134,252,0.1); padding: 20px; border-left: 4px solid #bb86fc; border-radius: 4px; margin-bottom: 30px;}
/* ========================================== */
        /* OTTIMIZZAZIONE MOBILE (SMARTPHONE)         */
        /* ========================================== */
        @media (max-width: 768px) {
            /* Riorganizza l'intestazione in colonna */
            .main-header { grid-template-columns: 1fr; gap: 15px; text-align: center; }
            .center-logo { height: 90px; }
            .author-section { justify-self: center; flex-direction: column; text-align: center; }
            
            /* Adatta le barre di ricerca e l'effemeride */
            .search-local-input { width: 100% !important; box-sizing: border-box; }
            .search-suggestions { width: 100%; }
            .ephemeris-box { flex-direction: column; gap: 15px; text-align: center; }
            .weather-container { border: none; border-top: 1px solid #444; border-bottom: 1px solid #444; padding: 10px 0; width: 100%; }
            .times-grid { grid-template-columns: 1fr 1fr; padding-left: 0; }
            
            /* Adatta i moduli di inserimento */
            .input-group { display: flex; flex-direction: column; align-items: flex-start; }
            .input-group label { width: 100%; margin-bottom: 5px; text-align: left; }
            input[type="text"]:not(.search-local-input), input[type="number"], select, input[type="time"] { width: 100% !important; max-width: 100%; }
            
            /* Riorganizza la tabella del Calcolatore Smart */
            .calc-row { flex-direction: column; align-items: flex-start; gap: 10px; padding-bottom: 15px; }
            .calc-total { text-align: left; width: 100%; padding-left: 10px; font-weight: bold; border-top: 1px dashed #444; padding-top: 5px; }
            .twilight-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div class="main-header">
        <div></div>
        <img src="astro_logo.png" alt="AstroDashboard Pro" class="center-logo">
        <div class="author-section">
            <div style="text-align: right;">
                <p style="margin: 0; font-size: 0.9em; color: #fff;">v3.5.0-Perfect</p>
                <p style="margin: 3px 0 0 0; font-size: 0.8em; color: #aaa;">Creato da <b style="color:#bb86fc;">Enrico Salis</b></p>
                <button class="btn-guide" onclick="apriGuida()">üìñ Apri Manuale</button>
            </div>
            <img src="logo astro enrico sfondo.png" alt="Enrico Salis Logo" style="height: 60px; object-fit: contain; border-radius: 5px;">
        </div>
    </div>

    <div id="dashboard-view">
        <div class="container" style="margin-bottom: 0;">
            <div class="ephemeris-box">
                <div class="moon-container">
                    <div id="moon-emoji" class="moon-icon">üåï</div>
                    <div id="moon-phase-name" class="moon-phase-name">Caricamento...</div>
                </div>
                <div class="weather-container">
                    <span style="font-size: 2em; margin-bottom: 5px;">üå°Ô∏è</span>
                    <span id="meteo-temp" style="font-size: 1.4em; font-weight: bold; color: #fff;">--¬∞C</span>
                    <span id="meteo-umidita" style="font-size: 0.9em; color: #44ff44;">Umidit√†: --%</span>
                </div>
                <div class="times-grid">
                    <div class="time-item"><span class="icon-normal">üåÖ</span> Alba Sole<br><span id="alba-sole">--:--</span></div>
                    <div class="time-item"><span class="icon-normal">üåá</span> Tramonto Sole<br><span id="tramonto-sole">--:--</span></div>
                    <div class="time-item"><span class="icon-normal">üåí</span> Alba Luna<br><span id="alba-luna">--:--</span></div>
                    <div class="time-item"><span class="icon-normal">üåò</span> Tramonto Luna<br><span id="tramonto-luna">--:--</span></div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="panel">
                <h3>üìç Posizione <span class="info-icon" onclick="apriGuida('guida-meteo')" title="Scopri come funziona la mappa">‚ÑπÔ∏è</span></h3>
                <div class="input-group">
                    <label for="ricerca">Trova Luogo:</label>
                    <input type="text" id="ricerca" placeholder="es. Monte Lussari..." oninput="cercaIndirizzo()">
                    <ul id="dropdown-risultati"></ul>
                </div>
                <div class="input-group">
                    <label for="lat">Latitudine:</label>
                    <input type="text" id="lat" readonly value="46.06200">
                </div>
                <div class="input-group">
                    <label for="lon">Longitudine:</label>
                    <input type="text" id="lon" readonly value="13.23500">
                </div>
            </div>

            <div class="panel">
                <h3>üéõÔ∏è Dati Ambientali Astrofotografici <span class="info-icon" onclick="apriGuida('guida-meteo')" title="Come leggere questi dati">‚ÑπÔ∏è</span></h3>
                <div class="meteo-grid">
                    <div class="meteo-item m-bassa active" id="btn-basse" onclick="toggleLayer('basse')"><h4>Nuvole Basse</h4><span id="val-basse">--%</span></div>
                    <div class="meteo-item m-media active" id="btn-medie" onclick="toggleLayer('medie')"><h4>Nuvole Medie</h4><span id="val-medie">--%</span></div>
                    <div class="meteo-item m-alta active" id="btn-alte" onclick="toggleLayer('alte')"><h4>Nuvole Alte</h4><span id="val-alte">--%</span></div>
                    <div class="meteo-item m-jet active" id="btn-jet" onclick="toggleLayer('jet')"><h4>Jet Stream</h4><span id="val-jet">--<span class="jet-unit">km/h</span></span></div>
                    <div class="meteo-item m-luna active" id="btn-luna" onclick="toggleLayer('luna')"><h4>Inq. Lunare</h4><span id="val-luna">--%</span></div>
                    <div class="meteo-item m-umidita active" id="btn-umidita" onclick="toggleLayer('umidita')"><h4>Umidit√†</h4><span id="val-umidita-layer" style="color:#00ffff;">--%</span></div>
                    <div class="meteo-item m-seeing active" id="btn-seeing"><h4>Stima Seeing</h4><span id="val-seeing" style="color:#bb86fc;">--/5</span></div>
                </div>
            </div>
        </div>

        <div class="container" style="flex-direction: column;">
            <div class="timeline-container">
                <div id="time-display" class="time-display">Caricamento Timeline Meteo...</div>
                <input type="range" id="timeSlider" min="0" max="23" value="0" oninput="syncSliders(this.value)" disabled>
                <div style="display:flex; justify-content: space-between; font-size:0.8em; color:#aaa; padding-top: 5px;">
                    <span>Adesso</span><span>+12h</span><span>+24h</span>
                </div>
            </div>
            <div id="map"></div>
        </div>

        <div class="container dso-container" style="flex-direction: column;">
            <h3>üî≠ Planetario Predittivo Ibrido <span class="info-icon" onclick="apriGuida('guida-ricerca')" title="Cos'√® il motore Ibrido?">‚ÑπÔ∏è</span></h3>
            <p style="color:#aaa; font-size: 0.9em; margin-top:0;">Le linee temporali sono sincronizzate. Scorri il tempo per vedere come cambia l'altezza degli oggetti in cielo.</p>
            
            <div class="timeline-container" style="margin-top: 10px; margin-bottom: 20px; padding: 10px; background-color: #222;">
                <div id="astro-time-display" class="time-display" style="color: #44ff44;">Caricamento Timeline Astro...</div>
                <input type="range" id="astroSlider" min="0" max="23" value="0" oninput="syncSliders(this.value)" disabled>
            </div>

            <div class="astro-section">
                <h4 style="color: #ffaa00; margin-bottom: 0; margin-top: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">ü™ê Sistema Solare (Solo visivo)</h4>
                <div class="horizontal-scroll" id="planets-list"></div>
            </div>

            <div class="astro-section" style="margin-top: 15px; margin-bottom: 25px;">
                <h4 style="color: #bb86fc; margin-bottom: 0; margin-top: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">üåå Oggetti Consigliati Visibili</h4>
                <div class="horizontal-scroll" id="dso-list"></div>
            </div>

            <div class="search-local-box">
                <h4>üîç Ricerca Libera Oggetto <span class="info-icon" onclick="apriGuida('guida-ricerca')" title="Come cercare bersagli">‚ÑπÔ∏è</span></h4>
                <p style="color:#aaa; font-size: 0.85em; margin-top:0;">Cerca nel DB Locale. Se non lo trovi, interrogheremo il server mondiale SIMBAD.</p>
                <div style="display: flex; justify-content: center; align-items: flex-start; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                    <div class="search-wrapper">
                        <input type="text" id="search-dash-input" class="search-local-input" placeholder="Es. M31, Pleiadi, NGC 1234..." autocomplete="off">
                        <ul id="sugg-dash" class="search-suggestions"></ul>
                    </div>
                    <button class="btn-search" onclick="eseguiRicerca('search-dash-input')">Pianifica Oggetto üöÄ</button>
                </div>
                <p id="status-search-dash-input" class="search-status"></p>
            </div>
        </div>
    </div> 


    <div id="planning-view">
        <div class="planning-header-row">
            <button class="btn-back" onclick="tornaDashboard()">Torna alla Dashboard</button>
            <div class="search-wrapper" style="margin-bottom: 30px;">
                <div style="display: flex; align-items: center;">
                    <input type="text" id="search-plan-input" class="search-local-input" placeholder="Cerca un altro oggetto..." autocomplete="off">
                    <button class="btn-search" onclick="eseguiRicerca('search-plan-input')">Cambia</button>
                </div>
                <ul id="sugg-plan" class="search-suggestions"></ul>
                <p id="status-search-plan-input" class="search-status" style="position:absolute; top:100%; left:0; text-align: left;"></p>
            </div>
        </div>
        
        <h2 id="plan-target-name">Nome Oggetto</h2>
        
        <div class="panel" style="margin-bottom: 20px;">
            <h3 style="margin-top:0;">üìñ Dossier Astrofotografico</h3>
            <div class="stat-grid">
                <div class="stat-box t-type"><span>Tipologia</span><b id="stat-type">--</b></div>
                <div class="stat-box t-mag"><span>Magnitudine App.</span><b id="stat-mag">--</b></div>
                <div class="stat-box t-dist"><span>Distanza</span><b id="stat-dist">--</b></div>
            </div>
            <div class="info-box"><span id="target-description">Caricamento...</span><br><a href="#" id="target-wiki" class="wiki-link" target="_blank">üîó Approfondisci su Wikipedia</a></div>
            <div class="tip-box"><b>üí° Consiglio Tattico:</b> <span id="target-tips">--</span></div>
        </div>

        <div class="planning-grid">
            <div class="panel">
                <h3>üì∏ Setup Ottico <span class="info-icon" onclick="apriGuida('guida-fov')" title="Come usare il simulatore FOV">‚ÑπÔ∏è</span></h3>
                <div class="input-group">
                    <label>Telescopio:</label>
                    <select id="preset-telescope" onchange="applicaPresetTelescopio()">
        <option value="">-- Seleziona Telescopio --</option>
    </select>
                </div>
                <div class="input-group">
                    <label>Focale (mm):</label>
                    <input type="number" id="focal-length" value="400" oninput="aggiornaFOV()">
                </div>
                <hr style="border: 1px solid #333; margin: 15px 0;">
                <div class="input-group">
                    <label>Sensore:</label>
                    <select id="preset-sensor" onchange="applicaPresetSensore()">
        <option value="">-- Seleziona Camera --</option>
    </select>
                </div>
                <div class="input-group"><label>Larg. W (mm):</label><input type="number" id="sensor-width" value="23.5" step="0.1" oninput="aggiornaFOV()"></div>
                <div class="input-group"><label>Alet. H (mm):</label><input type="number" id="sensor-height" value="15.7" step="0.1" oninput="aggiornaFOV()"></div>
                <div style="margin-top: 25px; padding: 15px; background-color: #2a2a2a; border-radius: 8px; text-align: center;">
                    <h4 style="margin:0 0 5px 0; color:#aaa;">Campo Inquadrato Calcolato</h4>
                    <p id="fov-result" style="font-weight: bold; color: #44ff44; font-size: 1.4em; margin: 0;">--¬∞ x --¬∞</p>
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column;">
                <div class="panel" style="padding:0; overflow:hidden;">
                    <h3 style="padding: 15px 20px 0 20px;">üìê Simulatore FOV Realistico (DSS2)</h3>
                    <p style="padding: 0 20px 5px 20px; margin:0; font-size: 0.8em; color:#aaa;">Trascina il cielo per pre-posizionare l'inquadratura.</p>
                    <div class="fov-simulator-container" id="fov-simulator-container">
                        <div id="aladin-lite-div"></div>
                        <div class="center-cross">+</div>
                        <div id="fov-rectangle"></div>
                    </div>
                    <div class="zoom-control">
                        <span style="font-size: 1.2em; margin-right: 10px;">‚ûñ</span>
                        <input type="range" id="fov-zoom" min="20" max="500" value="100" style="width: 60%; margin: 0;" oninput="aggiornaFOV()">
                        <span style="font-size: 1.2em; margin-left: 10px;">‚ûï</span>
                    </div>
                </div>
                <div class="chart-container"><canvas id="altitudeChart"></canvas></div>
            </div>
        </div>

        <h2 id="calc-title" style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">‚è±Ô∏è Calcolatore Sessione Smart AI <span class="info-icon" onclick="apriGuida('guida-smart')" title="Scopri come l'AI calcola le pose">‚ÑπÔ∏è</span></h2>
        
        <div class="twilight-grid">
            <div class="twilight-item"><span class="icon">üåá</span><span class="label">Tramonto</span><b id="info-sunset">--:--</b></div>
            <div class="twilight-item"><span class="icon">‚ú®</span><span class="label">Inizio Notte Astr.</span><b id="info-nightstart" class="twilight-night">--:--</b></div>
            <div class="twilight-item"><span class="icon">üî≠</span><span class="label">Fine Notte Astr.</span><b id="info-nightend" class="twilight-night">--:--</b></div>
            <div class="twilight-item"><span class="icon">üåÖ</span><span class="label">Alba</span><b id="info-sunrise">--:--</b></div>
        </div>
        
        <div class="panel" style="margin-bottom: 20px; text-align: center; display: flex; justify-content: space-around; flex-wrap: wrap;">
            <div class="input-group" style="margin: 0;"><label style="width: auto; margin-right: 10px; color:#fff;">Inizio Sessione:</label><input type="time" id="time-start" onchange="calcolaTempi()"></div>
            <div class="input-group" style="margin: 0;"><label style="width: auto; margin-right: 10px; color:#fff;">Fine Sessione:</label><input type="time" id="time-end" onchange="calcolaTempi()"></div>
            <div class="input-group" style="margin: 0;">
                <label style="width: auto; margin-right: 10px; color:#bb86fc;">Tipo Sensore:</label>
                <select id="sensor-type" onchange="toggleSensorMode(); calcolaTempi();" style="border-color: #bb86fc; width: auto !important;">
                    <option value="color">OSC (Colori)</option>
                    <option value="mono">Monocromatico</option>
                </select>
            </div>
        </div>

        <div class="session-grid">
            <div class="panel">
                <h3>Impostazione Sequenza</h3>
                <p style="font-size: 0.85em; color: #aaa; margin-top: 0;">Spunta i filtri Light da usare. Lascia Dark e Flat in fondo come tempi fissi.</p>
                
                <div class="smart-button-container">
                    <button class="btn-smart" onclick="generaSequenzaOttimale()">‚ú® Genera Sequenza Ottimale</button>
                    <p style="margin: 5px 0 0 0; font-size: 0.8em; color: #aaa;">L'algoritmo distribuisce il buio rimanente calcolando i pesi ottimali.</p>
                </div>

                <div style="display:flex; justify-content: space-between; margin-bottom: 10px; padding:0 10px; font-size:0.8em; color:#aaa;">
                    <span style="width:140px;">Usa | Frame</span>
                    <span>Pose x Sec.</span>
                    <span style="width:80px; text-align:right;">Totale</span>
                </div>
                
                <div id="frames-container"></div>

                <div class="calc-row" style="border-left-color: #ffaa00; margin-top: 10px; background: #2a2a2a;">
                    <div style="display:flex; align-items:center; width: 140px;">
                        <input type="checkbox" id="dither-check" checked style="margin-right:10px; transform: scale(1.2); cursor: pointer;" onchange="calcolaTempi()">
                        <label style="cursor: pointer; color: #ffaa00;" onclick="document.getElementById('dither-check').click()">Dither</label>
                        <span class="info-icon" style="margin-left: 8px; color: #ffaa00; font-size: 1.1em;" title="Spiega all'IA quanto tempo perdi nel dithering:&#10;‚Ä¢ 1¬∞ valore: ogni quanti scatti fai la manovra.&#10;‚Ä¢ 't': i secondi che la montatura impiega per riassestarsi.">‚ÑπÔ∏è</span>
                    </div>
                    <div class="calc-inputs" style="font-size: 0.85em; color: #aaa; display: flex; align-items: center; gap: 6px;">
                        Ogni <input type="number" id="dither-freq" value="3" min="1" oninput="calcolaTempi()" style="width: 45px !important; padding: 5px !important; text-align: center;">
                        t <input type="number" id="dither-duration" value="15" min="0" oninput="calcolaTempi()" style="width: 45px !important; padding: 5px !important; text-align: center;"> s
                    </div>
                    <div class="calc-total" id="dither-tot" style="color: #ffaa00;">0m</div>
                </div>

            </div>

            <div class="time-summary">
                <div class="summary-box"><h4>Finestra Disponibile</h4><span id="calc-available">--h --m</span></div>
                <div class="summary-box"><h4>Tempo Acquisizione</h4><span id="calc-total" style="color: #bb86fc;">--h --m</span></div>
                <div class="summary-box" style="border-color: #444; background-color: #222;">
                    <h4>Tempo Residuo</h4><span id="calc-residual" class="text-green">--h --m</span>
                    <p id="calc-warning" style="margin: 5px 0 0 0; font-size: 0.85em; display: none;" class="text-red">‚ö†Ô∏è Sforamento tempo!</p>
                </div>
            </div>
        </div>
    </div>

    <div id="guide-view">
        <button class="btn-back" style="margin-bottom: 40px;" onclick="chiudiGuida()">Torna Indietro</button>
        <h2 style="font-size: 2.2em; border-bottom: 2px solid #bb86fc; padding-bottom: 15px; margin-bottom: 30px;">üìñ Manuale AstroDashboard</h2>
        <div class="filosofia-box">
            <h3 style="color: #fff; margin-top:0;">La Filosofia</h3>
            <p>Fondere la potenza di 4 software diversi in un'unica piattaforma intelligente. Niente distrazioni, solo dati puri per ottimizzare la tua notte sotto le stelle.</p>
        </div>
        <div id="guida-meteo" class="guide-section">
            <h3>üåç 1. Dati Ambientali e Meteo</h3>
            <ul>
                <li><strong>La Mappa:</strong> Il raggio visibile (50 Km) √® indicativo. Serve per capire se le perturbazioni nuvolose ti permettono di trovare "buchi di sereno" spostandoti.</li>
                <li><strong>Jet Stream:</strong> Il killer del Seeing. < 50 km/h: cieli fermi. > 100 km/h: forte turbolenza, evita alte focali.</li>
                <li><strong>Umidit√†:</strong> Se supera l'85% scatta l'allerta rossa: accendi le fasce anticondensa!</li>
            </ul>
        </div>
        <div id="guida-ricerca" class="guide-section">
            <h3>üî≠ 2. Planetario Ibrido (Locale + SIMBAD)</h3>
            <ul>
                <li><strong>Motore Locale:</strong> Usa il menu a tendina. Gli oggetti in memoria hanno consigli tattici scritti da astrofotografi.</li>
                <li><strong>Motore SIMBAD:</strong> Se cerchi un oggetto esotico (es. NGC 2841), la IA si collega a Strasburgo per scaricare le coordinate, e a Wikipedia per i testi.</li>
            </ul>
        </div>
        <div id="guida-fov" class="guide-section">
            <h3>üì∏ 3. Simulatore Field of View (FOV)</h3>
            <ul>
                <li><strong>Calcolo:</strong> Usa i preset per vedere l'esatto angolo di campo della tua inquadratura.</li>
                <li><strong>Plate Solving Visivo:</strong> Trascina la reale immagine DSS2 per simulare il decentramento.</li>
            </ul>
        </div>
        <div id="guida-smart" class="guide-section">
            <h3>‚ú® 4. Smart AI & Dithering</h3>
            <ul>
                <li><strong>Dithering:</strong> Inserisci il numero di scatti e i secondi persi (t) per il riassestamento. L'IA calcoler√† il tempo invisibile perso.</li>
                <li><strong>Come ragiona l'AI?</strong> Riconosce l'oggetto. Assegna pose brevi agli ammassi, lunghe alle nebulose. Per le galassie in Mono, impone scatti brevi (30s) alla Luminanza ma le dedica il 50% delle ore notturne, splittando il resto sull'RGB.</li>
            </ul>
        </div>
    </div>

    <script>
// --- DATABASE ATTREZZATURA ---
const dbTelescopi = [
    { nome: "Askar FRA 400 (400mm)", focale: 400 },
    { nome: "Explore Scientific Comethunter (731mm)", focale: 731 },
    { nome: "SW Explorer 150P (750mm)", focale: 750 },
    { nome: "SW Explorer 200P (1000mm)", focale: 1000 },
    { nome: "SW Quattro 150P (600mm)", focale: 600 },
    { nome: "SW Quattro 200P (800mm)", focale: 800 },
    { nome: "SW Quattro 250P (1000mm)", focale: 1000 },
    { nome: "SW 72ED Evostar (420mm)", focale: 420 },
    { nome: "SW 80ED Evostar (600mm)", focale: 600 },
    { nome: "SW Esprit 80ED (400mm)", focale: 400 },
    { nome: "SW Esprit 100ED (550mm)", focale: 550 },
    { nome: "Celestron C8 SCT (2032mm)", focale: 2032 },
    { nome: "Celestron C8 @ f/6.3 (1280mm)", focale: 1280 },
    { nome: "ZWO Seestar S50 (250mm)", focale: 250 },
    { nome: "Samyang 135mm f/2", focale: 135 }
];

const dbCamere = [
    { nome: "ASI 533MC/MM (Square)", w: 11.31, h: 11.31 },
    { nome: "ASI 294MC/MM (4/3\")", w: 19.1, h: 13.0 },
    { nome: "ASI 2600MC/MM (APS-C)", w: 23.5, h: 15.7 },
    { nome: "ASI 6200MC/MM (Full Frame)", w: 36.0, h: 24.0 },
    { nome: "ASI 183MC/MM (1\")", w: 13.2, h: 8.8 },
    { nome: "ASI 585MC (Compact)", w: 11.14, h: 6.26 },
    { nome: "ASI 1600MM (4/3\")", w: 17.7, h: 13.4 },
    { nome: "Reflex APS-C (Canon/Nikon)", w: 22.3, h: 14.9 }
];

// Funzione per popolare i menu a tendina all'avvio
function popolaMenuAttrezzatura() {
    const selTel = document.getElementById('preset-telescope');
    dbTelescopi.forEach(t => {
        let opt = document.createElement('option');
        opt.value = t.focale;
        opt.textContent = t.nome;
        selTel.appendChild(opt);
    });

    const selCam = document.getElementById('preset-sensor');
    dbCamere.forEach(c => {
        let opt = document.createElement('option');
        opt.value = `${c.w},${c.h}`;
        opt.textContent = c.nome;
        selCam.appendChild(opt);
    });
}

// Chiama la funzione all'avvio (aggiungila in fondo al file vicino a scaricaDatiPrevisionali)
popolaMenuAttrezzatura();
        // CORE LOGIC
        let latCorrente = 46.062, lonCorrente = 13.235, datiMeteo = null, indicePartenza = 0, chartAltezza = null, targetSelezionato = null, aladinSkyMap = null, vistaPrecedente = 'dashboard-view';
        let mappaScura = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 });
        let map = L.map('map', { center: [latCorrente, lonCorrente], zoom: 8, layers: [mappaScura], zoomControl: false });
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        let layers = { basse: L.layerGroup().addTo(map), medie: L.layerGroup().addTo(map), alte: L.layerGroup().addTo(map), jet: L.layerGroup().addTo(map), luna: L.layerGroup().addTo(map), umidita: L.layerGroup().addTo(map) };
        let marker = L.marker([latCorrente, lonCorrente]).addTo(map).bindPopup("<b>Udine</b>").openPopup();
        let timerRicerca;

        const planetsDatabase = [
            { id: "jupiter", name: "Giove", icon: "ü™ê", ra: 7.15, dec: 22.8 },
            { id: "mars", name: "Marte", icon: "üî¥", ra: 18.50, dec: -23.5 },
            { id: "venus", name: "Venere", icon: "‚ú®", ra: 23.50, dec: -3.5 }
        ];

        function getJulianDate(date) { return (date.getTime() / 86400000) + 2440587.5; }
        function calcolaAltAz(ra, dec, lat, lon, date) {
            let jd = getJulianDate(date), d = jd - 2451545.0, lst = (280.46061837 + 360.98564736629 * d + lon) % 360;
            if (lst < 0) lst += 360;
            let ra_deg = ra * 15, ha_deg = lst - ra_deg, rad = Math.PI / 180;
            let sin_alt = Math.sin(lat*rad)*Math.sin(dec*rad) + Math.cos(lat*rad)*Math.cos(dec*rad)*Math.cos(ha_deg*rad);
            let alt_deg = Math.asin(sin_alt) / rad;
            let cos_az = (Math.sin(dec*rad) - Math.sin(lat*rad)*sin_alt) / (Math.cos(lat*rad) * Math.cos(Math.asin(sin_alt)));
            cos_az = Math.max(-1, Math.min(1, cos_az)); 
            let az_deg = Math.acos(cos_az) / rad;
            if (Math.sin(ha_deg*rad) > 0) az_deg = 360 - az_deg;
            return { alt: alt_deg, az: az_deg };
        }
        function getPuntoCardinale(az) { return ["N", "NE", "E", "SE", "S", "SW", "W", "NW", "N"][Math.round(az / 45) % 8]; }

        function cercaIndirizzo() {
            let query = document.getElementById('ricerca').value;
            let dropdown = document.getElementById('dropdown-risultati');
            if (query.length < 3) { dropdown.style.display = 'none'; return; }
            clearTimeout(timerRicerca);
            timerRicerca = setTimeout(() => {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                    .then(r => r.json()).then(data => {
                        dropdown.innerHTML = ''; 
                        if (data.length > 0) {
                            dropdown.style.display = 'block';
                            data.forEach(l => {
                                let li = document.createElement('li'); li.textContent = l.display_name;
                                li.onclick = () => selezionaLuogo(l.lat, l.lon, l.display_name);
                                dropdown.appendChild(li);
                            });
                        } else dropdown.style.display = 'none';
                    });
            }, 500); 
        }

        function selezionaLuogo(lat, lon, nome) {
            latCorrente = parseFloat(lat); lonCorrente = parseFloat(lon);
            document.getElementById('ricerca').value = nome.split(',')[0];
            document.getElementById('lat').value = latCorrente.toFixed(5);
            document.getElementById('lon').value = lonCorrente.toFixed(5);
            document.getElementById('dropdown-risultati').style.display = 'none';
            map.flyTo([latCorrente, lonCorrente], 9);
            if (marker) map.removeLayer(marker);
            marker = L.marker([latCorrente, lonCorrente]).addTo(map).bindPopup(`<b>${nome.split(',')[0]}</b>`).openPopup();
            aggiornaEffemeridi(new Date()); scaricaDatiPrevisionali();
        }

        function aggiornaEffemeridi(data) {
            let orariSole = SunCalc.getTimes(data, latCorrente, lonCorrente), orariLuna = SunCalc.getMoonTimes(data, latCorrente, lonCorrente), faseLuna = SunCalc.getMoonIllumination(data);
            let formattaOra = (d) => d && !isNaN(d) ? d.toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}) : '--:--';
            document.getElementById('alba-sole').innerText = formattaOra(orariSole.sunrise); document.getElementById('tramonto-sole').innerText = formattaOra(orariSole.sunset);
            document.getElementById('alba-luna').innerText = orariLuna.rise ? formattaOra(orariLuna.rise) : 'Non sorge'; document.getElementById('tramonto-luna').innerText = orariLuna.set ? formattaOra(orariLuna.set) : 'Non tramonta';
            let f = faseLuna.phase, i = 'üåë', n = 'Luna Nuova';
            if(f>0.03&&f<=0.22){i='üåí';n='Falce Crescente';}else if(f>0.22&&f<=0.28){i='üåì';n='Primo Quarto';}else if(f>0.28&&f<=0.47){i='üåî';n='Gibbosa Crescente';}else if(f>0.47&&f<=0.53){i='üåï';n='Luna Piena';}else if(f>0.53&&f<=0.72){i='üåñ';n='Gibbosa Calante';}else if(f>0.72&&f<=0.78){i='üåó';n='Ultimo Quarto';}else if(f>0.78&&f<=0.97){i='üåò';n='Falce Calante';}
            document.getElementById('moon-emoji').innerText = i; document.getElementById('moon-phase-name').innerText = n;
        }

        function syncSliders(val) { document.getElementById('timeSlider').value = val; document.getElementById('astroSlider').value = val; cambiaOraMeteo(); cambiaOraAstro(); }

        function scaricaDatiPrevisionali() {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latCorrente}&longitude=${lonCorrente}&hourly=cloud_cover_low,cloud_cover_mid,cloud_cover_high,wind_speed_250hPa,wind_speed_10m,temperature_2m,relative_humidity_2m&forecast_days=3&timezone=auto`)
            .then(r => r.json()).then(data => {
                datiMeteo = data.hourly; let adesso = new Date();
                indicePartenza = Math.max(0, datiMeteo.time.findIndex(t => new Date(t).getTime() >= adesso.getTime() - 3600000));
                document.getElementById('timeSlider').disabled = false; document.getElementById('timeSlider').value = 0; 
                document.getElementById('astroSlider').disabled = false; document.getElementById('astroSlider').value = 0; 
                cambiaOraMeteo(); cambiaOraAstro();
            }).catch(e => document.getElementById('time-display').innerText = "‚ö†Ô∏è Errore meteo");
        }

        function cambiaOraMeteo() {
            if (!datiMeteo) return;
            let step = parseInt(document.getElementById('timeSlider').value), i = indicePartenza + step, dOra = new Date(datiMeteo.time[i]);
            let tOra = step === 0 ? "Adesso (" + new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'}) + ")" : dOra.toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            if (step > 0 && dOra.getHours() === 0) aggiornaEffemeridi(dOra);

            let b = datiMeteo.cloud_cover_low[i], m = datiMeteo.cloud_cover_mid[i], a = datiMeteo.cloud_cover_high[i], jet = Math.round(datiMeteo.wind_speed_250hPa[i]), vs = datiMeteo.wind_speed_10m[i], temp = datiMeteo.temperature_2m[i], um = datiMeteo.relative_humidity_2m[i];
            let altS = SunCalc.getPosition(dOra, latCorrente, lonCorrente).altitude * (180/Math.PI), mP = SunCalc.getMoonPosition(dOra, latCorrente, lonCorrente);
            
            let maxC = Math.max(b, m, a), icM = "‚òÅÔ∏è", dsM = "Coperto";
            if (maxC < 15) { icM = "‚òÄÔ∏è"; dsM = "Sereno"; } else if (maxC < 40) { icM = "üå§Ô∏è"; dsM = "Poco Nuvoloso"; } else if (maxC < 75) { icM = "‚õÖ"; dsM = "Nubi Sparse"; }
            if (altS < -6) { if (maxC < 15) icM = "‚ú®"; else if (maxC < 40) icM = "üåô"; }

            document.getElementById('time-display').innerHTML = `<span style="font-size: 1.5em; vertical-align: middle; margin-right: 5px;">${icM}</span> ${tOra} <br><span style="font-size: 0.75em; color: #aaa; text-transform: uppercase;">Condizioni: <b style="color: #fff;">${dsM}</b></span>`;
            document.getElementById('meteo-temp').innerText = Math.round(temp) + "¬∞C";
            document.getElementById('meteo-umidita').innerText = "Umidit√†: " + um + "%"; document.getElementById('meteo-umidita').style.color = um > 85 ? "#ff4444" : "#44ff44";
            document.getElementById('val-umidita-layer').innerText = um + "%";
            
            let inqL = (altS < -6 && mP.altitude > 0) ? Math.max(0, Math.round((SunCalc.getMoonIllumination(dOra).fraction * Math.sin(mP.altitude)) * 100)) : 0;
            let scS = 5; if(jet>120)scS-=3;else if(jet>80)scS-=2;else if(jet>50)scS-=1; if(vs>15)scS-=1; if(vs>30)scS-=1;
            
            document.getElementById('val-seeing').innerText = altS > -6 ? "Giorno" : Math.max(1, scS) + "/5";
            document.getElementById('val-seeing').style.color = altS > -6 ? "#ffaa00" : "#bb86fc";
            document.getElementById('val-basse').innerText = b+"%"; document.getElementById('val-medie').innerText = m+"%"; document.getElementById('val-alte').innerText = a+"%"; document.getElementById('val-jet').innerHTML = jet+' <span class="jet-unit">km/h</span>'; document.getElementById('val-luna').innerText = inqL+"%";

            Object.values(layers).forEach(l => l.clearLayers());
            L.circle([latCorrente, lonCorrente], { radius: 50000, color: '#ff4444', fillColor: '#ff4444', fillOpacity: (b/100)*0.7, weight: 1 }).addTo(layers.basse);
            L.circle([latCorrente, lonCorrente], { radius: 50000, color: '#44ff44', fillColor: '#44ff44', fillOpacity: (m/100)*0.7, weight: 1 }).addTo(layers.medie);
            L.circle([latCorrente, lonCorrente], { radius: 50000, color: '#4444ff', fillColor: '#4444ff', fillOpacity: (a/100)*0.7, weight: 1 }).addTo(layers.alte);
            if(jet>50) L.circle([latCorrente, lonCorrente], { radius: 60000, color: '#ff00ff', fillColor: '#ff00ff', fillOpacity: (jet/200)*0.5, weight: 2, dashArray: '10, 10' }).addTo(layers.jet);
            if(inqL>0) L.circle([latCorrente, lonCorrente], { radius: 100000, color: '#ffffaa', fillColor: '#ffffaa', fillOpacity: (inqL/100)*0.4, weight: 0 }).addTo(layers.luna);
            if(um>60) L.circle([latCorrente, lonCorrente], { radius: 75000, color: '#00ffff', fillColor: '#00ffff', fillOpacity: ((um-60)/100)*0.5, weight: 1, dashArray: '5, 5' }).addTo(layers.umidita);
        }

        function toggleLayer(n) { let b = document.getElementById('btn-'+n), l = layers[n]; if (map.hasLayer(l)) { map.removeLayer(l); b.classList.replace('active','disabled'); } else { map.addLayer(l); b.classList.replace('disabled','active'); } }

        function cambiaOraAstro() {
            if (!datiMeteo) return;
            let step = parseInt(document.getElementById('astroSlider').value), dOra = new Date(datiMeteo.time[indicePartenza + step]);
            document.getElementById('astro-time-display').innerText = "üî≠ " + (step === 0 ? "Adesso (" + new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'}) + ")" : dOra.toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }));
            
            let pL = document.getElementById('planets-list'), dL = document.getElementById('dso-list'); pL.innerHTML = ''; dL.innerHTML = '';
            if (SunCalc.getPosition(dOra, latCorrente, lonCorrente).altitude * (180/Math.PI) > -6) { pL.innerHTML = dL.innerHTML = `<p style="color:#aaa; padding:10px;">‚òÄÔ∏è Cielo troppo luminoso.</p>`; return; }

            let vP = [], mP = SunCalc.getMoonPosition(dOra, latCorrente, lonCorrente), mA = mP.altitude * (180/Math.PI);
            if (mA > 5) vP.push({ html: creaCardHTML({name: "Luna", icon: "üåï", desc: "", tips: ""}, mA, (mP.azimuth * 180/Math.PI + 180) % 360, false), alt: mA });
            planetsDatabase.forEach(p => { let pos = calcolaAltAz(p.ra, p.dec, latCorrente, lonCorrente, dOra); if (pos.alt > 10) vP.push({ html: creaCardHTML(p, pos.alt, pos.az, false), alt: pos.alt }); });
            vP.sort((a, b) => b.alt - a.alt).forEach(i => pL.appendChild(i.html));

            let vD = [];
            if (typeof dsoDatabase !== 'undefined') dsoDatabase.forEach(d => { let pos = calcolaAltAz(d.ra, d.dec, latCorrente, lonCorrente, dOra); if (pos.alt > 15) vD.push({ html: creaCardHTML(d, pos.alt, pos.az, true), alt: pos.alt }); });
            vD.sort((a, b) => b.alt - a.alt); if (vD.length > 0) vD[0].html.classList.add('top-target');
            vD.forEach(i => dL.appendChild(i.html));
            if (dL.innerHTML === '') dL.innerHTML = `<p style="color:#777; padding:10px;">Nessun oggetto visibile.</p>`;
        }

        function creaCardHTML(t, alt, az, c) {
            let div = document.createElement('div'); div.className = c ? 'dso-card card-clickable' : 'dso-card card-static';
            div.innerHTML = `<div class="dso-icon">${t.icon}</div><div class="dso-info"><h4>${t.name}</h4><p>Altezza: <b>${Math.round(alt)}¬∞</b></p><span class="dso-direction">${getPuntoCardinale(az)}</span></div>`;
            if(c) div.onclick = () => apriPianificazione(t); return div;
        }

        function setupSearch(iId, sId) {
            let inp = document.getElementById(iId), box = document.getElementById(sId); if(!inp || !box) return;
            inp.addEventListener('input', () => {
                if (typeof dsoDatabase === 'undefined') return;
                let v = inp.value.trim().toLowerCase().replace(/\s+/g, ''); box.innerHTML = '';
                if (!v) { box.style.display = 'none'; return; }
                let m = dsoDatabase.filter(d => d.id.toLowerCase().includes(v) || d.name.toLowerCase().replace(/\s+/g, '').includes(v));
                if (m.length > 0) { box.style.display = 'block'; m.forEach(x => { let li = document.createElement('li'); li.innerHTML = `${x.icon} ${x.name}`; li.onclick = () => { inp.value = x.name; box.style.display = 'none'; apriPianificazione(x); }; box.appendChild(li); }); } else box.style.display = 'none';
            });
            inp.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); box.style.display = 'none'; eseguiRicerca(iId); } });
            document.addEventListener('click', e => { if (e.target !== inp) box.style.display = 'none'; });
        }
        setupSearch('search-dash-input', 'sugg-dash'); setupSearch('search-plan-input', 'sugg-plan');

        function eseguiRicerca(iId) {
            if (typeof dsoDatabase === 'undefined') { alert("Database locale assente."); return; }
            let inp = document.getElementById(iId), q = inp.value.trim(); if (!q) return;
            let qn = q.toLowerCase().replace(/\s+/g, ''), st = document.getElementById('status-' + iId);
            if(st) st.style.display = 'none';

            let ex = dsoDatabase.find(d => d.id.toLowerCase() === qn), pt = dsoDatabase.find(d => d.name.toLowerCase().replace(/\s+/g, '').includes(qn));
            if (ex) { inp.value = ex.name; apriPianificazione(ex); return; } if (pt) { inp.value = pt.name; apriPianificazione(pt); return; }

            if(st) { st.style.display = 'block'; st.style.color = '#ffaa00'; st.innerText = "Ricerca su SIMBAD in corso... üõ∞Ô∏è"; }
            fetch(`https://cds.unistra.fr/cgi-bin/nph-sesame/-oI/A?${encodeURIComponent(q)}`).then(r => r.text()).then(d => {
                let lines = d.split('\n'), fc = false, ra, dec, ty = "Sconosciuta", mg = "N/D";
                for(let i=0; i<lines.length; i++) {
                    if(lines[i].startsWith('%J') && !fc) { let p = lines[i].trim().split(/\s+/); if(p.length >= 3) { ra = parseFloat(p[1]); dec = parseFloat(p[2]); fc = true; } }
                    if(lines[i].startsWith('%T')) { let rt = lines[i].substring(2).trim().toLowerCase(); ty = rt.includes('galaxy') ? "Galassia" : rt.includes('nebula')||rt.includes('h ii') ? "Nebulosa" : rt.includes('cluster') ? "Ammasso" : rt.includes('star') ? "Stella" : lines[i].substring(2).trim(); }
                    if(lines[i].startsWith('%M')) { let rm = lines[i].substring(2).trim(), mv = rm.match(/V=([\d.]+)/), mb = rm.match(/B=([\d.]+)/), mn = rm.match(/[\d.]+/); mg = mv ? "+"+mv[1]+" (V)" : mb ? "+"+mb[1]+" (B)" : mn ? "~ "+mn[0] : mg; }
                }
                if (!fc) { if(st) { st.style.color = '#ff4444'; st.innerText = "Oggetto inesistente."; } else alert("Oggetto inesistente."); } 
                else {
                    if(st) st.innerText = "Scaricamento info da Wikipedia... üìö";
                    fetch(`https://it.wikipedia.org/w/api.php?action=query&format=json&origin=*&generator=search&gsrsearch=${encodeURIComponent(q)}&prop=extracts&exintro=1&explaintext=1&exchars=600&gsrlimit=1`).then(w => w.json()).then(wd => {
                        if(st) st.style.display = 'none'; let sn = `Dati SIMBAD.\nTipo: ${ty}.`, wl = `https://it.wikipedia.org/w/index.php?search=${encodeURIComponent(q)}`;
                        if (wd.query && wd.query.pages) { let pid = Object.keys(wd.query.pages)[0]; if (wd.query.pages[pid].extract) { sn = "Dati web.\n\n" + wd.query.pages[pid].extract; wl = `https://it.wikipedia.org/?curid=${pid}`; } }
                        inp.value = ''; apriPianificazione({ name: q.toUpperCase() + " (SIMBAD)", ra: ra/15, dec: dec, type: ty, mag: mg, dist: "N/D", link: wl, desc: sn, tips: ty==="Galassia"?"Filtri L-RGB.":"Pose test 120s." });
                    }).catch(e => { if(st) st.style.display = 'none'; inp.value = ''; apriPianificazione({ name: q.toUpperCase(), ra: ra/15, dec: dec, type: ty, mag: mg, dist: "N/D", link: `https://it.wikipedia.org/w/index.php?search=${encodeURIComponent(q)}`, desc: `Wikipedia non raggiungibile.`, tips: "Test suggerito." }); });
                }
            }).catch(e => { if(st) { st.style.color = '#ff4444'; st.innerText = "Errore di rete."; } });
        }

        function apriGuida(a=null) { vistaPrecedente = document.getElementById('planning-view').style.display === 'block' ? 'planning-view' : 'dashboard-view'; document.getElementById('dashboard-view').style.display = 'none'; document.getElementById('planning-view').style.display = 'none'; document.getElementById('guide-view').style.display = 'block'; if(a) setTimeout(() => document.getElementById(a).scrollIntoView({behavior: 'smooth'}), 100); else window.scrollTo(0,0); }
        function chiudiGuida() { document.getElementById('guide-view').style.display = 'none'; document.getElementById(vistaPrecedente).style.display = 'block'; if(vistaPrecedente==='planning-view') aggiornaFOV(); window.scrollTo(0,0); }

        function apriPianificazione(t) {
            targetSelezionato = t; document.getElementById('dashboard-view').style.display = 'none'; document.getElementById('planning-view').style.display = 'block';
            document.getElementById('plan-target-name').innerText = "Pianificazione: " + t.name;
            document.getElementById('calc-title').innerHTML = `‚è±Ô∏è Calcolatore Sessione Smart AI <span class="info-icon" onclick="apriGuida('guida-smart')" title="Scopri come l'AI calcola le pose">‚ÑπÔ∏è</span>`;
            document.getElementById('stat-type').innerText = t.type || "--"; document.getElementById('stat-mag').innerText = t.mag || "--"; document.getElementById('stat-dist').innerText = t.dist || "--";
            document.getElementById('target-description').innerText = t.desc || "Nessuna descrizione."; document.getElementById('target-tips').innerText = t.tips || "Nessun consiglio.";
            let wl = document.getElementById('target-wiki'); if(t.link) { wl.href = t.link; wl.style.display = 'inline-block'; } else wl.style.display = 'none';
            
            let d = new Date(), at = SunCalc.getTimes(d, latCorrente, lonCorrente), ft = (x) => x && !isNaN(x) ? x.toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}) : '--:--';
            document.getElementById('info-sunset').innerText = ft(at.sunset); document.getElementById('info-nightstart').innerText = ft(at.night); document.getElementById('info-nightend').innerText = ft(at.nightEnd); document.getElementById('info-sunrise').innerText = ft(at.sunrise);
            if (ft(at.night) !== '--:--') document.getElementById('time-start').value = ft(at.night); if (ft(at.nightEnd) !== '--:--') document.getElementById('time-end').value = ft(at.nightEnd);

            if (!aladinSkyMap) { aladinSkyMap = A.aladin('#aladin-lite-div', { survey: "P/DSS2/color", fov: 2, target: (t.ra * 15) + " " + t.dec, showReticle: false, showZoomControl: false, showFullscreenControl: false, showLayersControl: false, showGotoControl: false }); setTimeout(() => aggiornaFOV(), 300); } else { setTimeout(() => { aladinSkyMap.gotoRaDec(t.ra * 15, t.dec); aggiornaFOV(); }, 100); }
            disegnaGraficoAltezza(); toggleSensorMode(); calcolaTempi(); window.scrollTo(0,0);
        }

        function tornaDashboard() { document.getElementById('planning-view').style.display = 'none'; document.getElementById('dashboard-view').style.display = 'block'; document.getElementById('search-dash-input').value = ''; document.getElementById('search-plan-input').value = ''; }
        function applicaPresetTelescopio() { let v = document.getElementById('preset-telescope').value; if(v){document.getElementById('focal-length').value=v; aggiornaFOV();} }
        function applicaPresetSensore() { let v = document.getElementById('preset-sensor').value; if(v){let p=v.split(',');document.getElementById('sensor-width').value=p[0];document.getElementById('sensor-height').value=p[1];aggiornaFOV();} }

        function aggiornaFOV() {
            let fl = parseFloat(document.getElementById('focal-length').value) || 1000, sw = parseFloat(document.getElementById('sensor-width').value) || 23.5, sh = parseFloat(document.getElementById('sensor-height').value) || 15.6;
            let fW = (2 * Math.atan(sw / (2 * fl)) * (180 / Math.PI)), fH = (2 * Math.atan(sh / (2 * fl)) * (180 / Math.PI));
            document.getElementById('fov-result').innerText = `${fW.toFixed(2)}¬∞ x ${fH.toFixed(2)}¬∞`;
            let cw = document.getElementById('fov-simulator-container').clientWidth, cm = 2.5 / (parseFloat(document.getElementById('fov-zoom').value) / 100);
            if (aladinSkyMap) aladinSkyMap.setFoV(Math.max(0.01, fW * cm));
            let rw = cw / cm, rh = rw * (fH / fW), rect = document.getElementById('fov-rectangle'); rect.style.width = rw + "px"; rect.style.height = rh + "px";
        }

        function disegnaGraficoAltezza() {
            if (!targetSelezionato) return; if (chartAltezza) chartAltezza.destroy();
            let lbl = [], dat = [], d = new Date(), sd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 18, 0, 0);
            for (let i = 0; i <= 12; i++) { let fd = new Date(sd.getTime() + i*3600000); lbl.push(fd.getHours() + "h"); dat.push(Math.max(0, calcolaAltAz(targetSelezionato.ra, targetSelezionato.dec, latCorrente, lonCorrente, fd).alt)); }
            chartAltezza = new Chart(document.getElementById('altitudeChart').getContext('2d'), { type: 'line', data: { labels: lbl, datasets: [{ label: 'Altezza (¬∞)', data: dat, borderColor: '#bb86fc', backgroundColor: 'rgba(187, 134, 252, 0.3)', tension: 0.4, fill: true, pointRadius: 2, borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 90, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#aaa', font: { size: 10 }, stepSize: 30 } }, x: { grid: { display: false }, ticks: { color: '#aaa', font: { size: 10 }, maxRotation: 0 } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, layout: { padding: 0 } } });
        }

        const framesColor = [{ id: "c-light", name: "Light", class: "f-l", dC: 0, dE: 180 }, { id: "c-dark", name: "Dark", class: "f-dark", dC: 0, dE: 180 }, { id: "c-bias", name: "Bias/Flat", class: "f-bias", dC: 0, dE: 0 }];
        const framesMono = [{ id: "m-l", name: "Lum (L)", class: "f-l", dC: 0, dE: 30 }, { id: "m-r", name: "Red (R)", class: "f-r", dC: 0, dE: 120 }, { id: "m-g", name: "Green (G)", class: "f-g", dC: 0, dE: 120 }, { id: "m-b", name: "Blue (B)", class: "f-b", dC: 0, dE: 120 }, { id: "m-ha", name: "H-Alpha", class: "f-ha", dC: 0, dE: 300 }, { id: "m-oiii", name: "O-III", class: "f-oiii", dC: 0, dE: 300 }, { id: "m-sii", name: "S-II", class: "f-sii", dC: 0, dE: 300 }, { id: "m-dark", name: "Dark", class: "f-dark", dC: 0, dE: 300 }, { id: "m-bias", name: "Bias/Flat", class: "f-bias", dC: 0, dE: 0 }];

        function toggleSensorMode() {
            let isM = document.getElementById('sensor-type').value === 'mono', c = document.getElementById('frames-container'); c.innerHTML = '';
            (isM ? framesMono : framesColor).forEach(f => {
                let isL = !f.id.includes('dark') && !f.id.includes('bias'), r = document.createElement('div'); r.className = `calc-row ${f.class}`;
                r.innerHTML = `<div style="display:flex; align-items:center; width: 140px;">${isL ? `<input type="checkbox" id="${f.id}-check" checked style="margin-right:10px; transform: scale(1.2); cursor: pointer;" onchange="calcolaTempi()">` : `<span style="display:inline-block; width: 23px; margin-right:10px;"></span>`}<label style="width:auto; cursor: ${isL?'pointer':'default'};" ${isL?`onclick="document.getElementById('${f.id}-check').click()"`:''}>${f.name}</label></div><div class="calc-inputs"><input type="number" id="${f.id}-count" value="${f.dC}" min="0" oninput="calcolaTempi()"> <span>x</span> <input type="number" id="${f.id}-exp" value="${f.dE}" min="0" oninput="calcolaTempi()"> <span>s</span></div><div class="calc-total" id="${f.id}-tot">0h 0m</div>`;
                c.appendChild(r);
            });
        }

        function calcolaTempi() {
            let tS = document.getElementById('time-start').value, tE = document.getElementById('time-end').value; if(!tS || !tE) return;
            let dS = new Date(`1970-01-01T${tS}:00`), dE = new Date(`1970-01-01T${tE}:00`); if (dE <= dS) dE.setDate(dE.getDate() + 1);
            let aS = (dE - dS) / 1000; document.getElementById('calc-available').innerText = `${Math.floor(aS/3600)}h ${Math.floor((aS%3600)/60)}m`;
            let fL = document.getElementById('sensor-type').value === 'mono' ? framesMono : framesColor, tSec = 0, tLF = 0;
            
            fL.forEach(f => {
                let c = parseInt(document.getElementById(`${f.id}-count`).value)||0, e = parseInt(document.getElementById(`${f.id}-exp`).value)||0, rs = c * e;
                tSec += rs; if (!f.id.includes('dark') && !f.id.includes('bias')) tLF += c;
                document.getElementById(`${f.id}-tot`).innerText = Math.floor(rs/3600)>0 ? `${Math.floor(rs/3600)}h ${Math.floor((rs%3600)/60)}m` : `${Math.floor((rs%3600)/60)}m`;
            });

            let dC = document.getElementById('dither-check'), dSec = 0;
            if (dC && dC.checked) {
                let dF = parseInt(document.getElementById('dither-freq').value)||1, dD = parseInt(document.getElementById('dither-duration').value)||0;
                dSec = Math.floor(tLF / dF) * dD; tSec += dSec;
                document.getElementById('dither-tot').innerText = Math.floor(dSec/3600)>0 ? `${Math.floor(dSec/3600)}h ${Math.floor((dSec%3600)/60)}m` : `${Math.floor((dSec%3600)/60)}m`;
            } else document.getElementById('dither-tot').innerText = `0m`;

            document.getElementById('calc-total').innerText = `${Math.floor(tSec/3600)}h ${Math.floor((tSec%3600)/60)}m`;
            let rS = aS - tSec, rD = document.getElementById('calc-residual'), wD = document.getElementById('calc-warning');
            if (rS >= 0) { rD.innerText = `${Math.floor(rS/3600)}h ${Math.floor((rS%3600)/60)}m`; rD.className = "text-green"; wD.style.display = "none"; } 
            else { let oS = Math.abs(rS); rD.innerText = `- ${Math.floor(oS/3600)}h ${Math.floor((oS%3600)/60)}m`; rD.className = "text-red"; wD.style.display = "block"; }
        }

        function generaSequenzaOttimale() {
            if (!targetSelezionato) return;
            let tS = document.getElementById('time-start').value, tE = document.getElementById('time-end').value; if(!tS || !tE) { alert("Imposta orari."); return; }
            let dS = new Date(`1970-01-01T${tS}:00`), dE = new Date(`1970-01-01T${tE}:00`); if (dE <= dS) dE.setDate(dE.getDate() + 1);
            let aS = (dE - dS) / 1000, isM = document.getElementById('sensor-type').value === 'mono', fL = isM ? framesMono : framesColor, cS = 0;
            
            fL.forEach(f => { if (f.id.includes('dark') || f.id.includes('bias')) cS += (parseInt(document.getElementById(`${f.id}-count`).value)||0) * (parseInt(document.getElementById(`${f.id}-exp`).value)||0); });
            let rS = aS - cS; if (rS <= 0) { alert("I frame di calibrazione occupano tutto il tempo!"); return; }
            
            let aL = []; fL.forEach(f => { if (!f.id.includes('dark') && !f.id.includes('bias')) { let c = document.getElementById(`${f.id}-check`); if (c && c.checked) aL.push(f); } });
            if (aL.length === 0) { alert("Seleziona almeno un filtro Light."); return; }

            let w = {};
            if (!isM) w[aL[0].id] = 1.0;
            else {
                let hL = aL.some(f=>f.id==='m-l'), hRGB = aL.some(f=>f.id==='m-r')&&aL.some(f=>f.id==='m-g')&&aL.some(f=>f.id==='m-b');
                if (hL && hRGB && aL.length === 4) { w['m-l']=0.5; w['m-r']=0.1666; w['m-g']=0.1666; w['m-b']=0.1666; } 
                else { let eq = 1.0 / aL.length; aL.forEach(f => w[f.id] = eq); }
            }

            let ty = targetSelezionato.type ? targetSelezionato.type.toLowerCase() : "", isA = ty.includes('ammasso')||ty.includes('cluster'), isG = ty.includes('galassia')||ty.includes('galaxy')||ty.includes('riflessione')||ty.includes('stella');
            let dC = document.getElementById('dither-check'), uD = dC && dC.checked, dF = parseInt(document.getElementById('dither-freq').value)||1, dD = parseInt(document.getElementById('dither-duration').value)||0;

            aL.forEach(f => {
                let eS = 180;
                if (f.id === 'm-l') eS = 30; else if (f.id.includes('ha')||f.id.includes('oiii')||f.id.includes('sii')) eS = 300; else if (isA) eS = 60; else if (isG) eS = 120;
                let eeS = eS + (uD && dF > 0 ? dD / dF : 0);
                document.getElementById(`${f.id}-exp`).value = eS; document.getElementById(`${f.id}-count`).value = Math.floor((rS * w[f.id]) / eeS);
            });

            fL.forEach(f => { if (!f.id.includes('dark') && !f.id.includes('bias')) { let c = document.getElementById(`${f.id}-check`); if (c && !c.checked) { document.getElementById(`${f.id}-count`).value = 0; document.getElementById(`${f.id}-exp`).value = f.dE; } } });
            calcolaTempi();
        }

        window.addEventListener('resize', () => { if(document.getElementById('planning-view').style.display === 'block') aggiornaFOV(); });
        aggiornaEffemeridi(new Date()); scaricaDatiPrevisionali();
    </script>
</body>
</html>