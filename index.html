<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroDashboard v5.5 - Global Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AstroDash">
    <link rel="apple-touch-icon" href="astro_logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://aladin.cds.unistra.fr/AladinLite/api/v2/latest/aladin.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://aladin.cds.unistra.fr/AladinLite/api/v2/latest/aladin.min.js"></script>

    <script src="database.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #121212; color: #e0e0e0; text-align: center; margin: 0; padding: 20px; }
        h2 { color: #bb86fc; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; display: flex; align-items: center; justify-content: center; gap: 10px;}
        h3 { margin-top: 0; color: #fff; display: flex; align-items: center; gap: 8px;}
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 20px; max-width: 1200px; margin: 0 auto; }
        .panel { background-color: #1e1e1e; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); text-align: left; flex: 1; min-width: 320px; }
        
        .info-icon { font-size: 0.9em; cursor: pointer; opacity: 0.6; transition: 0.2s; filter: grayscale(100%); margin-left: 5px; }
        .info-icon:hover { opacity: 1; filter: grayscale(0) drop-shadow(0 0 5px rgba(187, 134, 252, 0.8)); transform: scale(1.1);}
        
        .main-header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; max-width: 1200px; margin: 0 auto 20px auto; background: #1a1a1a; padding: 15px 25px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5); width: 100%;}
        .logo-container { justify-self: center; }
        .center-logo { height: 100px; object-fit: contain; filter: drop-shadow(0 0 8px rgba(187, 134, 252, 0.2));}
        .author-section { display: flex; align-items: center; gap: 15px; justify-self: end; text-align: right;}
        .btn-guide { background: transparent; border: 1px solid #bb86fc; color: #bb86fc; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: 0.2s; font-weight: bold; margin-top: 5px;}
        .btn-guide:hover { background: #bb86fc; color: #121212;}
        
        .lang-container { justify-self: start; text-align: left; display: flex; flex-direction: column; gap: 5px; }
        .lang-toggle { display: inline-flex; background: #1a1a1a; border-radius: 20px; border: 1px solid #444; overflow: hidden; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .lang-btn { background: transparent; border: none; color: #777; padding: 6px 14px; font-size: 0.95em; cursor: pointer; transition: 0.3s; font-weight: bold; display: flex; align-items: center; }
        .lang-btn.active { background: #bb86fc; color: #121212; }
        .lang-btn:hover:not(.active) { color: #fff; background: #333; }

        .ephemeris-box { display: flex; justify-content: space-around; align-items: center; background-color: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; width: 100%; flex-wrap: wrap;}
        .moon-container { display: flex; flex-direction: column; align-items: center; margin-right: 20px; min-width: 120px;}
        .moon-icon { font-size: 3.5em; text-shadow: 0 0 15px rgba(255, 255, 170, 0.4); margin-bottom: 5px;}
        .moon-phase-name { font-size: 0.9em; font-weight: bold; color: #bb86fc; text-transform: uppercase; text-align: center;}
        .weather-container { display: flex; flex-direction: column; align-items: center; justify-content: center; border-left: 1px solid #444; border-right: 1px solid #444; padding: 0 20px; min-width: 100px; margin: 10px 0;}
        .times-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; width: 100%; flex: 1; min-width: 300px; padding-left: 20px;}
        .time-item { text-align: center; font-size: 0.9em; color: #aaa;}
        .icon-normal { font-style: normal; font-size: 1.8em; display: block; margin-bottom: 5px; }
        .time-item span { font-size: 1.3em; font-weight: bold; color: #fff; display: block; margin-top: 3px;}

        .input-group { margin-bottom: 12px; position: relative; }
        label { display: inline-block; width: 100px; color: #aaa; font-size: 0.9em;}
        input[type="text"]:not(.search-local-input), input[type="number"], select { width: calc(100% - 125px); cursor: pointer; }
        input[type="text"], input[type="number"], select, input[type="time"] { padding: 8px; border-radius: 4px; border: 1px solid #333; background-color: #2c2c2c; color: #fff; font-family: inherit;}
        input[type="time"] { width: 130px !important; text-align: center; } 
        #dropdown-risultati { list-style: none; padding: 0; margin: 0; position: absolute; width: calc(100% - 125px); background-color: #2c2c2c; border: 1px solid #444; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; left: 105px; display: none; text-align: left;}
        #dropdown-risultati li { padding: 10px; cursor: pointer; border-bottom: 1px solid #444; font-size: 0.9em; }
        #dropdown-risultati li:hover { background-color: #bb86fc; color: #121212; font-weight: bold; }
        #map { height: 500px; width: 100%; border: 2px solid #333; border-radius: 8px; z-index: 1; }
        
        .timeline-container { margin-top: 20px; padding: 15px; background-color: #2a2a2a; border-radius: 8px; text-align: center; width: 100%;}
        input[type="range"] { width: 100%; cursor: pointer; margin-top: 10px;}
        .time-display { font-size: 1.3em; color: #bb86fc; font-weight: bold; margin-bottom: 5px; text-transform: capitalize;}
        
        .meteo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-top: 15px; }
        .meteo-item { background-color: #2a2a2a; padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; transition: 0.3s; user-select: none; border: 2px solid transparent;}
        .meteo-item:hover { filter: brightness(1.2); }
        .meteo-item h4 { margin: 0 0 5px 0; font-size: 0.85em; color: #aaa; }
        .meteo-item span { font-size: 1.4em; font-weight: bold; }
        .jet-unit { font-size: 0.6em; font-weight: normal; color: #ccc; }
        .disabled { opacity: 0.4; filter: grayscale(100%); background-color: #1a1a1a; }
        .m-bassa.active { border-color: #ff4444; } .m-media.active { border-color: #44ff44; } .m-alta.active { border-color: #4444ff; } .m-jet.active { border-color: #ff00ff; } .m-luna.active { border-color: #ffffaa; } .m-umidita.active { border-color: #00ffff;} .m-seeing { border-color: #bb86fc; cursor: default;}

        .dso-container { margin-top: 20px; text-align: left; padding: 20px; background-color: #1a1a1a; border-radius: 8px;}
        .astro-section { width: 100%; display: block; }
        .horizontal-scroll { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 15px; margin-top: 10px; scrollbar-width: thin; scrollbar-color: #bb86fc #2a2a2a; flex-wrap: nowrap;}
        .horizontal-scroll::-webkit-scrollbar { height: 8px; }
        .horizontal-scroll::-webkit-scrollbar-track { background-color: #1e1e1e; border-radius: 4px; }
        .horizontal-scroll::-webkit-scrollbar-thumb { background-color: #444; border-radius: 4px; }
        .horizontal-scroll::-webkit-scrollbar-thumb:hover { background-color: #bb86fc; }

        .dso-card { flex: 0 0 auto; width: 220px; background-color: #2a2a2a; border: 1px solid #333; padding: 15px; border-radius: 8px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.5); position: relative;}
        .card-clickable { cursor: pointer; transition: transform 0.2s; }
        .card-clickable:hover { transform: translateY(-5px); background-color: #333;}
        .card-static { cursor: default; opacity: 0.7; filter: grayscale(50%);}
        .dso-icon { font-size: 2.5em; margin-right: 15px; filter: drop-shadow(0px 0px 5px rgba(187, 134, 252, 0.4));}
        .dso-info h4 { margin: 0 0 5px 0; font-size: 0.9em; color: #fff;}
        .dso-info p { margin: 0; font-size: 0.85em; color: #aaa;}
        .dso-direction { display: inline-block; padding: 2px 6px; background-color: #bb86fc; color: #121212; border-radius: 4px; font-weight: bold; font-size: 0.8em; margin-top: 5px;}
        .top-target { border: 2px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .top-target::after { content: '‚≠ê'; position: absolute; top: -10px; right: 10px; background-color: #ffd700; color: #000; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: bold;}

        .search-local-box { background-color: #2a2a2a; padding: 15px; border-radius: 8px; margin-top: 25px; text-align: center; border: 1px solid #444; }
        .search-local-box h4 { margin: 0 0 10px 0; color: #fff; font-size: 1.1em;}
        .search-wrapper { position: relative; display: inline-block; text-align: left; }
        .search-local-input { width: 350px !important; max-width: 100%; padding: 12px 15px !important; border-radius: 5px; border: 1px solid #555 !important; background-color: #1e1e1e !important; color: #fff !important; font-size: 1.1em !important; cursor: text !important; letter-spacing: 0.5px;}
        .search-local-input:focus { outline: none; border-color: #bb86fc !important; box-shadow: 0 0 8px rgba(187,134,252,0.3); }
        .btn-search { padding: 12px 25px; background-color: #bb86fc; color: #121212; border: none; border-radius: 5px; font-weight: bold; font-size: 1.1em; cursor: pointer; transition: 0.2s; margin-left: 10px;}
        .btn-search:hover { background-color: #a361f9; }
        .search-suggestions { position: absolute; top: 100%; left: 0; width: 350px; background-color: #2c2c2c; border: 1px solid #555; border-top: none; border-radius: 0 0 5px 5px; max-height: 250px; overflow-y: auto; z-index: 2000; list-style: none; padding: 0; margin: 0; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.8);}
        .search-suggestions li { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #333; color: #ddd; font-size: 1em; display: flex; align-items: center; gap: 10px;}
        .search-suggestions li:hover { background-color: #bb86fc; color: #121212; font-weight: bold; }
        .search-status { margin: 10px 0 0 0; font-size: 0.9em; display: none; text-align: center; width: 100%; font-weight: bold;}

        #planning-view { display: none; text-align: left; max-width: 1200px; margin: 0 auto;}
        .btn-back { background: linear-gradient(135deg, #7c4dff 0%, #bb86fc 100%); color: #ffffff; border: none; padding: 12px 28px; border-radius: 50px; cursor: pointer; font-size: 1.1em; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(124, 77, 255, 0.3); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); letter-spacing: 0.5px; text-transform: uppercase;}
        .btn-back:hover { background: linear-gradient(135deg, #9e75ff 0%, #d2aaff 100%); box-shadow: 0 8px 25px rgba(187, 134, 252, 0.5), 0 0 10px rgba(255,255,255,0.2) inset; transform: translateY(-3px) scale(1.02); color: #fff; }
        .planning-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}

        .stat-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;}
        .stat-box { background: #2a2a2a; padding: 10px; border-radius: 5px; flex: 1; min-width: 120px; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .stat-box.t-type { border-left: 3px solid #bb86fc; }
        .stat-box.t-mag { border-left: 3px solid #44ff44; }
        .stat-box.t-dist { border-left: 3px solid #ffaa00; }
        .stat-box span { font-size: 0.8em; color: #aaa; text-transform: uppercase;}
        .stat-box b { display: block; font-size: 1.1em; color: #fff; margin-top: 3px;}
        .info-box { background-color: #222; border-left: 4px solid #bb86fc; padding: 15px; margin-bottom: 10px; border-radius: 4px; font-size: 0.95em; line-height: 1.5; color: #ddd;}
        .tip-box { background-color: rgba(255, 215, 0, 0.1); border-left: 4px solid #ffd700; padding: 15px; border-radius: 4px; font-size: 0.95em; color: #fff;}
        .wiki-link { display: inline-block; margin-top: 10px; color: #bb86fc; text-decoration: none; font-weight: bold;}

        .planning-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        @media (max-width: 768px) { .planning-grid { grid-template-columns: 1fr; } }
        .fov-simulator-container { background-color: #000; height: 400px; border-radius: 8px; border: 2px solid #444; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center;}
        #aladin-lite-div { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;}
        #fov-rectangle { position: absolute; pointer-events: none; transition: width 0.1s, height 0.1s; z-index: 1000;}
        .center-cross { position: absolute; color: rgba(68, 255, 68, 0.7); font-size: 1.5em; pointer-events: none; z-index: 1000;}
        .chart-container { background-color: #1e1e1e; padding: 15px; border-radius: 8px; height: 160px; margin-top: 15px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);}
        .zoom-control { display: flex; align-items: center; justify-content: center; padding: 10px; background: #2a2a2a; border-radius: 0 0 8px 8px;}

        .session-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 768px) { .session-grid { grid-template-columns: 1fr; } }
        
        .calc-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: #222; border-radius: 5px; border-left: 3px solid #555;}
        .calc-row label { color: #fff; font-weight: bold; margin: 0; font-size: 0.9em; cursor: pointer;}
        .calc-inputs { display: flex; gap: 10px; align-items: center;}
        .calc-inputs input { width: 70px !important; padding: 5px !important; text-align: center;}
        .calc-total { width: 80px; text-align: right; color: #aaa; font-size: 0.9em;}
        .f-l { border-color: #fff !important; } .f-r { border-color: #ff4444 !important; } .f-g { border-color: #44ff44 !important; } .f-b { border-color: #4444ff !important; }
        .f-ha { border-color: #ff0055 !important; } .f-oiii { border-color: #00ffff !important; } .f-sii { border-color: #ffaa00 !important; }
        .f-dark { border-color: #555 !important; } .f-bias { border-color: #888 !important; }
        
        .time-summary { background-color: #2a2a2a; padding: 20px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center;}
        .summary-box { padding: 15px; margin-bottom: 10px; border-radius: 5px; background: #1a1a1a; border: 1px solid #333;}
        .summary-box h4 { margin: 0 0 5px 0; color: #aaa;}
        .summary-box span { font-size: 1.5em; font-weight: bold; color: #fff;}
        .text-red { color: #ff4444 !important; }
        .text-green { color: #44ff44 !important; }
        .twilight-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background-color: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;}
        .twilight-item span.icon { font-size: 1.8em; display: block; margin-bottom: 5px; }
        .twilight-item span.label { color: #aaa; font-size: 0.8em; text-transform: uppercase; }
        .twilight-item b { display: block; font-size: 1.2em; margin-top: 5px; color: #fff;}
        .twilight-night { color: #bb86fc !important; }
        
        .smart-button-container { text-align: center; margin: 15px 0 25px 0; padding: 15px; background: rgba(187, 134, 252, 0.1); border-radius: 8px; border: 1px dashed #bb86fc; }
        .btn-smart { background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); color: white; padding: 12px 30px; font-size: 1.1em; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);}
        .btn-smart:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 20px rgba(0, 114, 255, 0.5);}

        /* MODAL REPORT & TOOLTIP STYLES */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: #1e1e1e; margin: 5% auto; padding: 25px; border: 1px solid #bb86fc; border-radius: 12px; width: 90%; max-width: 600px; position: relative; color: #fff; box-shadow: 0 0 20px rgba(187,134,252,0.3); max-height: 85vh; overflow-y: auto; text-align: left;}
        .close-btn { position: absolute; right: 20px; top: 15px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #ff4444; }
        .report-section { background: #2a2a2a; border-left: 4px solid #bb86fc; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .report-section h4 { margin: 0 0 10px 0; color: #bb86fc; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px; }
        .report-line { display: flex; justify-content: space-between; border-bottom: 1px dashed #444; padding: 5px 0; font-size: 0.95em; }
        .report-line:last-child { border-bottom: none; }
        .btn-copy { background: #333; color: #fff; border: 1px solid #bb86fc; padding: 12px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; transition: 0.3s; font-size: 1em; }
        .btn-copy:hover { background: #bb86fc; color: #121212; }

        .floating-tooltip { position: absolute; background: rgba(20, 20, 20, 0.95); border: 1px solid #bb86fc; border-left: 4px solid #bb86fc; color: #ddd; padding: 12px 15px; border-radius: 6px; font-size: 0.95em; max-width: 280px; box-shadow: 0 5px 20px rgba(0,0,0,0.9); pointer-events: none; opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 10000; display: none; text-align: left; line-height: 1.5; }

        @media (max-width: 768px) {
            .main-header { display: flex !important; flex-direction: column; gap: 15px; align-items: center; justify-content: center; text-align: center; padding: 20px 15px; width: 100%; }
            .lang-container { align-items: center; text-align: center; }
            .author-section { flex-direction: column; align-items: center; justify-content: center; text-align: center; }
            .center-logo { height: 80px; }
            .search-local-input { width: 100% !important; }
            .ephemeris-box { flex-direction: column; gap: 15px; text-align: center; }
            .weather-container { border: none; border-top: 1px solid #444; border-bottom: 1px solid #444; padding: 10px 0; width: 100%; }
            .times-grid { grid-template-columns: 1fr 1fr; padding-left: 0; }
            .input-group { display: flex; flex-direction: column; align-items: flex-start; }
            .input-group label { width: 100%; margin-bottom: 5px; text-align: left; }
            input[type="text"]:not(.search-local-input), input[type="number"], select, input[type="time"] { width: 100% !important; max-width: 100%; }
            .calc-row { flex-direction: column; align-items: flex-start; gap: 10px; padding-bottom: 15px; }
            .calc-total { text-align: left; width: 100%; padding-left: 10px; font-weight: bold; border-top: 1px dashed #444; padding-top: 5px; }
        }
    </style>
</head>
<body>

    <div class="main-header">
        <div class="lang-container">
            <span style="font-size: 0.75em; color: #aaa; font-weight: bold; letter-spacing: 1px; padding-left: 5px;">LANGUAGE</span>
            <div class="lang-toggle">
                <button class="lang-btn active" id="btn-lang-it" onclick="changeLanguage('it')">ITA</button>
                <button class="lang-btn" id="btn-lang-en" onclick="changeLanguage('en')">ENG</button>
                <button class="lang-btn" id="btn-lang-es" onclick="changeLanguage('es')">ESP</button>
                <button class="lang-btn" id="btn-lang-zh" onclick="changeLanguage('zh')">CHN</button>
            </div>
        </div>
        <div class="logo-container">
            <img src="astro_logo.png" alt="AstroDashboard Pro" class="center-logo">
        </div>
        <div class="author-section">
            <div>
                <p style="margin: 0 0 6px 0; font-size: 0.9em; color: #fff; font-weight: bold;">v5.5.0-Global</p>
                <button class="btn-guide" onclick="apriGuida()" style="margin: 0;"><span data-i18n="manual_btn">üìñ Apri Manuale</span></button>
            </div>
            <img src="logo astro enrico sfondo.png" alt="Enrico Salis Logo" style="height: 60px; object-fit: contain; border-radius: 5px;">
        </div>
    </div>

    <div id="dashboard-view">
        <div class="container" style="margin-bottom: 0;">
            <div class="ephemeris-box">
                <div class="moon-container">
                    <div id="moon-emoji" class="moon-icon">üåï</div>
                    <div id="moon-phase-name" class="moon-phase-name">Caricamento...</div>
                </div>
                <div class="weather-container">
                    <span style="font-size: 2em; margin-bottom: 5px;">üå°Ô∏è</span>
                    <span id="meteo-temp" style="font-size: 1.4em; font-weight: bold; color: #fff;">--¬∞C</span>
                    <span id="meteo-umidita" style="font-size: 0.9em; color: #44ff44;"><span data-i18n="humidity">Umidit√†</span>: --%</span>
                </div>
                <div class="times-grid">
                    <div class="time-item"><span class="icon-normal">üåÖ</span> <span data-i18n="sunrise">Alba</span> <span data-i18n="sun">Sole</span><br><span id="alba-sole">--:--</span></div>
                    <div class="time-item"><span class="icon-normal">üåá</span> <span data-i18n="sunset">Tramonto</span> <span data-i18n="sun">Sole</span><br><span id="tramonto-sole">--:--</span></div>
                    <div class="time-item"><span class="icon-normal">üåí</span> <span data-i18n="sunrise">Alba</span> <span data-i18n="moon">Luna</span><br><span id="alba-luna">--:--</span></div>
                    <div class="time-item"><span class="icon-normal">üåò</span> <span data-i18n="sunset">Tramonto</span> <span data-i18n="moon">Luna</span><br><span id="tramonto-luna">--:--</span></div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="panel">
                <h3><span data-i18n="pos_title">üìç Posizione</span></h3>
                <div class="input-group">
                    <label for="ricerca" data-i18n="find_place">Trova Luogo:</label>
                    <input type="text" id="ricerca" placeholder="..." data-i18n="search_place" oninput="cercaIndirizzo()">
                    <ul id="dropdown-risultati"></ul>
                </div>
                <div class="input-group"><label for="lat" data-i18n="lat">Latitudine:</label><input type="text" id="lat" readonly value="46.06200"></div>
                <div class="input-group"><label for="lon" data-i18n="lon">Longitudine:</label><input type="text" id="lon" readonly value="13.23500"></div>
            </div>

            <div class="panel">
                <h3><span data-i18n="env_data">üéõÔ∏è Dati Ambientali</span></h3>
                <div class="meteo-grid">
                    <div class="meteo-item m-bassa active" id="btn-basse" onclick="toggleLayer('basse')"><h4 data-i18n="low_clouds">Nuvole Basse</h4><span id="val-basse">--%</span></div>
                    <div class="meteo-item m-media disabled" id="btn-medie" onclick="toggleLayer('medie')"><h4 data-i18n="mid_clouds">Nuvole Medie</h4><span id="val-medie">--%</span></div>
                    <div class="meteo-item m-alta disabled" id="btn-alte" onclick="toggleLayer('alte')"><h4 data-i18n="high_clouds">Nuvole Alte</h4><span id="val-alte">--%</span></div>
                    <div class="meteo-item m-jet disabled" id="btn-jet" onclick="toggleLayer('jet')"><h4>Jet Stream</h4><span id="val-jet">--<span class="jet-unit">km/h</span></span></div>
                    <div class="meteo-item m-luna disabled" id="btn-luna" onclick="toggleLayer('luna')"><h4 data-i18n="moon_poll">Inq. Lunare</h4><span id="val-luna">--%</span></div>
                    <div class="meteo-item m-umidita disabled" id="btn-umidita" onclick="toggleLayer('umidita')"><h4 data-i18n="humidity">Umidit√†</h4><span id="val-umidita-layer" style="color:#00ffff;">--%</span></div>
                    <div class="meteo-item m-seeing active" id="btn-seeing"><h4 data-i18n="seeing_est">Stima Seeing</h4><span id="val-seeing" style="color:#bb86fc;">--/5</span></div>
                </div>
            </div>
        </div>

        <div class="container" style="flex-direction: column;">
            <div class="timeline-container" style="position: relative;">
                <div id="time-display" class="time-display">Caricamento Timeline Meteo...</div>
                <input type="range" id="timeSlider" min="0" max="23" value="0" oninput="syncSliders(this.value)" disabled>
            </div>
            <div id="map"></div>
        </div>

        <div class="container dso-container" style="flex-direction: column;">
            <h3><span data-i18n="hybrid_planetarium">üî≠ Planetario Predittivo Ibrido</span></h3>
            <div class="timeline-container" style="margin-top: 10px; margin-bottom: 20px; padding: 10px; background-color: #222;">
                <div id="astro-time-display" class="time-display" style="color: #44ff44;">Caricamento Timeline Astro...</div>
                <input type="range" id="astroSlider" min="0" max="23" value="0" oninput="syncSliders(this.value)" disabled>
            </div>
            <div class="astro-section">
                <h4 style="color: #ffaa00; margin-bottom: 0; border-bottom: 1px solid #333; padding-bottom: 5px;" data-i18n="solar_system">ü™ê Sistema Solare</h4>
                <div class="horizontal-scroll" id="planets-list"></div>
            </div>
            <div class="astro-section" style="margin-top: 15px; margin-bottom: 25px;">
                <h4 style="color: #bb86fc; margin-bottom: 0; border-bottom: 1px solid #333; padding-bottom: 5px;" data-i18n="rec_targets">üåå Oggetti Consigliati</h4>
                <div class="horizontal-scroll" id="dso-list"></div>
            </div>

            <div class="search-local-box">
                <h4><span data-i18n="free_search">üîç Ricerca Libera Oggetto</span></h4>
                <div style="display: flex; justify-content: center; align-items: flex-start; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                    <div class="search-wrapper">
                        <input type="text" id="search-dash-input" class="search-local-input" placeholder="..." autocomplete="off">
                        <ul id="sugg-dash" class="search-suggestions"></ul>
                    </div>
                    <button class="btn-search" onclick="eseguiRicerca('search-dash-input')">Pianifica üöÄ</button>
                </div>
                <p id="status-search-dash-input" class="search-status"></p>
            </div>
        </div>
    </div>

    <div id="planning-view">
        <div class="planning-header-row">
            <button class="btn-back" onclick="tornaDashboard()" data-i18n="back_dash">Torna alla Dashboard</button>
            <div class="search-wrapper" style="margin-bottom: 30px;">
                <div style="display: flex; align-items: center;">
                    <input type="text" id="search-plan-input" class="search-local-input" placeholder="..." autocomplete="off">
                    <button class="btn-search" onclick="eseguiRicerca('search-plan-input')">Cambia</button>
                </div>
                <ul id="sugg-plan" class="search-suggestions"></ul>
            </div>
        </div>
        
        <h2 id="plan-target-name">Nome Oggetto</h2>
        
        <div class="panel" style="margin-bottom: 20px;">
            <h3 style="margin-top:0;" data-i18n="dossier">üìñ Dossier Astrofotografico</h3>
            <div class="stat-grid">
                <div class="stat-box t-type"><span data-i18n="type">Tipologia</span><b id="stat-type">--</b></div>
                <div class="stat-box t-mag"><span data-i18n="app_mag">Magnitudine App.</span><b id="stat-mag">--</b></div>
                <div class="stat-box t-dist"><span data-i18n="distance">Distanza</span><b id="stat-dist">--</b></div>
            </div>
            <div class="info-box"><span id="target-description">Caricamento...</span><br><a href="#" id="target-wiki" class="wiki-link" target="_blank">üîó Wikipedia</a></div>
            <div class="tip-box"><b data-i18n="tactical_tip">üí° Consiglio Tattico:</b> <span id="target-tips">--</span></div>
        </div>

        <div class="planning-grid">
            <div class="panel">
                <h3><span data-i18n="optical_setup">üì∏ Setup Ottico</span></h3>
                <div class="input-group">
                    <label data-i18n="telescope">Telescopio:</label>
                    <select id="preset-telescope" onchange="applicaPresetTelescopio()">
                        <option value="">-- Seleziona --</option>
                    </select>
                </div>
                <div class="input-group">
                    <label data-i18n="focal_len">Focale (mm):</label>
                    <input type="number" id="focal-length" value="400" oninput="aggiornaFOV()">
                </div>
                <div class="input-group">
                    <label style="color: #ffaa00;">Diametro (mm):</label>
                    <input type="number" id="aperture" value="72" oninput="aggiornaFOV()">
                </div>
                <hr style="border: 1px solid #333; margin: 15px 0;">
                <div class="input-group">
                    <label data-i18n="sensor">Sensore:</label>
                    <select id="preset-sensor" onchange="applicaPresetSensore()">
                        <option value="">-- Seleziona --</option>
                    </select>
                </div>
                <div class="input-group"><label data-i18n="width">Larg. W (mm):</label><input type="number" id="sensor-width" value="23.5" step="0.1" oninput="aggiornaFOV()"></div>
                <div class="input-group"><label data-i18n="height">Alt. H (mm):</label><input type="number" id="sensor-height" value="15.7" step="0.1" oninput="aggiornaFOV()"></div>
                
                <div style="margin-top: 15px; padding: 15px; background-color: #222; border-radius: 8px; border: 1px solid #444;">
                    <div class="input-group" style="margin-bottom: 5px; display: flex; align-items: center;">
                        <label data-i18n="mode" style="width: auto; margin-right:10px; font-weight: bold; color: #bb86fc;">Modalit√†:</label>
                        <select id="capture-mode" onchange="toggleMosaic()" style="flex: 1; padding: 6px; font-size: 0.95em; background: #1a1a1a; cursor: pointer;">
                            <option value="single" data-i18n="single_panel">Scatto Singolo</option>
                            <option value="mosaic" data-i18n="mosaic">Mosaico</option>
                        </select>
                    </div>
                    <div id="mosaic-settings" style="display: none; flex-direction: column; gap: 10px; margin-top: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <label data-i18n="panels" style="width: auto; margin:0;">Pannelli (X, Y):</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="number" id="mosaic-x" value="2" min="1" max="10" oninput="aggiornaFOV(); calcolaTempi();" style="width: 50px !important; padding: 4px !important; text-align: center;"> x 
                                <input type="number" id="mosaic-y" value="2" min="1" max="10" oninput="aggiornaFOV(); calcolaTempi();" style="width: 50px !important; padding: 4px !important; text-align: center;">
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <label data-i18n="overlap" style="width: auto; margin:0;">Sovrapposizione:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="number" id="mosaic-overlap" value="20" min="5" max="50" step="5" oninput="aggiornaFOV()" style="width: 60px !important; padding: 4px !important; text-align: center;"> %
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 25px; padding: 15px; background-color: #2a2a2a; border-radius: 8px; text-align: center;">
                    <h4 style="margin:0 0 5px 0; color:#aaa;" data-i18n="fov_calc">Campo Inquadrato Calcolato</h4>
                    <p id="fov-result" style="font-weight: bold; color: #44ff44; font-size: 1.4em; margin: 0;">--¬∞ x --¬∞</p>
                    <p id="mosaic-fov-result" style="margin: 5px 0 0 0; font-size: 1em; color: #bb86fc; font-weight: bold; display: none;">Totale: --¬∞ x --¬∞</p>
                    <p id="fov-warning-msg" style="color: #ffaa00; font-size: 0.85em; margin-top: 10px; display: none; font-weight: bold;">‚ö†Ô∏è Valuta un mosaico.</p>
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column;">
                <div class="panel" style="padding:0; overflow:hidden;">
                    <h3 style="padding: 15px 20px 0 20px;" data-i18n="fov_sim">üìê Simulatore FOV Realistico (DSS2)</h3>
                    <div class="fov-simulator-container" id="fov-simulator-container">
                        <div id="aladin-lite-div"></div>
                        <div class="center-cross">+</div>
                        <div id="fov-rectangle"></div>
                    </div>
                    <div class="zoom-control">
                        <span style="font-size: 1.2em; margin-right: 10px;">‚ûñ</span>
                        <input type="range" id="fov-zoom" min="20" max="500" value="100" style="width: 60%; margin: 0;" oninput="aggiornaFOV()">
                        <span style="font-size: 1.2em; margin-left: 10px;">‚ûï</span>
                    </div>
                </div>
                <div class="chart-container"><canvas id="altitudeChart"></canvas></div>
            </div>
        </div>

        <h2 id="calc-title" style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;"><span data-i18n="smart_calc">‚è±Ô∏è Calcolatore Sessione Smart AI</span></h2>
        
        <div class="twilight-grid">
            <div class="twilight-item"><span class="icon">üåá</span><span class="label" data-i18n="sunset">Tramonto</span><b id="info-sunset">--:--</b></div>
            <div class="twilight-item"><span class="icon">‚ú®</span><span class="label" data-i18n="night_start">Inizio Notte Astr.</span><b id="info-nightstart" class="twilight-night">--:--</b></div>
            <div class="twilight-item"><span class="icon">üî≠</span><span class="label" data-i18n="night_end">Fine Notte Astr.</span><b id="info-nightend" class="twilight-night">--:--</b></div>
            <div class="twilight-item"><span class="icon">üåÖ</span><span class="label" data-i18n="sunrise">Alba</span><b id="info-sunrise">--:--</b></div>
        </div>
        
        <div class="panel" style="margin-bottom: 20px; text-align: center; display: flex; justify-content: space-around; flex-wrap: wrap;">
            <div class="input-group" style="margin: 0;"><label style="width: auto; margin-right: 10px; color:#fff;" data-i18n="session_start">Inizio Sessione:</label><input type="time" id="time-start" onchange="calcolaTempi()"></div>
            <div class="input-group" style="margin: 0;"><label style="width: auto; margin-right: 10px; color:#fff;" data-i18n="session_end">Fine Sessione:</label><input type="time" id="time-end" onchange="calcolaTempi()"></div>
            <div class="input-group" style="margin: 0;">
                <label style="width: auto; margin-right: 10px; color:#bb86fc;" data-i18n="sensor_type">Tipo Sensore:</label>
                <select id="sensor-type" onchange="toggleSensorMode(); calcolaTempi();" style="border-color: #bb86fc; width: auto !important;">
                    <option value="color">OSC (Color)</option>
                    <option value="mono">Mono</option>
                </select>
            </div>
        </div>

        <div class="session-grid">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                    <h3 style="margin: 0;"><span data-i18n="seq_setup">Impostazione Sequenza</span></h3>
                    <span id="mosaic-total-badge" style="display:none; background: #bb86fc; color: #121212; padding: 4px 10px; border-radius: 4px; font-size: 0.9em; font-weight: bold;"></span>
                </div>
                <div class="smart-button-container">
                    <button class="btn-smart" onclick="generaSequenzaOttimale()" data-i18n="gen_seq_btn">‚ú® Genera Sequenza Ottimale</button>
                </div>
                <div style="display:flex; justify-content: space-between; margin-bottom: 10px; padding:0 10px; font-size:0.8em; color:#aaa;">
                    <span style="width:140px;" data-i18n="use_frame">Usa | Frame</span>
                    <span data-i18n="poses_sec">Pose x Sec.</span>
                    <span style="width:80px; text-align:right;" data-i18n="total">Totale</span>
                </div>
                
                <div id="frames-container"></div>

                <div class="calc-row" style="border-left-color: #ffaa00; margin-top: 10px; background: #2a2a2a;">
                    <div style="display:flex; align-items:center; width: 140px;">
                        <input type="checkbox" id="dither-check" checked style="margin-right:10px; transform: scale(1.2); cursor: pointer;" onchange="calcolaTempi()">
                        <label style="cursor: pointer; color: #ffaa00;" onclick="document.getElementById('dither-check').click()">Dither</label>
                    </div>
                    <div class="calc-inputs" style="font-size: 0.85em; color: #aaa; display: flex; align-items: center; gap: 6px;">
                        <span data-i18n="every">Ogni</span> <input type="number" id="dither-freq" value="3" min="1" oninput="calcolaTempi()" style="width: 45px !important; padding: 5px !important; text-align: center;">
                        t <input type="number" id="dither-duration" value="15" min="0" oninput="calcolaTempi()" style="width: 45px !important; padding: 5px !important; text-align: center;"> s
                    </div>
                    <div class="calc-total" id="dither-tot" style="color: #ffaa00;">0m</div>
                </div>
            </div>

            <div class="time-summary">
                <div class="summary-box"><h4 data-i18n="avail_window">Finestra Disponibile</h4><span id="calc-available">--h --m</span></div>
                <div class="summary-box"><h4 data-i18n="acq_time">Tempo Acquisizione</h4><span id="calc-total" style="color: #bb86fc;">--h --m</span></div>
                <div class="summary-box" style="border-color: #444; background-color: #222;">
                    <h4 data-i18n="res_time">Tempo Residuo</h4><span id="calc-residual" class="text-green">--h --m</span>
                    <p id="calc-warning" style="margin: 5px 0 0 0; font-size: 0.85em; display: none;" class="text-red" data-i18n="time_overflow">‚ö†Ô∏è Sforamento tempo!</p>
                </div>
                <div id="ai-advisor-panel" style="display:none; text-align:left; background:#1a1a1a; padding:15px; border-radius:5px; border:1px solid #333; margin-top:10px;"></div>
            </div>
        </div>

        <div class="panel" style="margin-top: 20px; border: 1px solid #bb86fc; background: linear-gradient(180deg, #1a1a1a 0%, #121212 100%);">
            <h3><span style="color: #bb86fc;" data-i18n="nina_export_title">üöÄ Esportazione N.I.N.A. Advanced Sequencer</span></h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: #222; padding: 15px; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: #fff;" data-i18n="seq_start">Avvio Sequenza</h4>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-cool" checked style="transform: scale(1.2);"> <span data-i18n="cool_cam">Raffredda Camera a</span> <input type="number" id="nina-temp" value="-10" style="width: 60px!important; padding: 4px!important;"> ¬∞C
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-slew" checked style="transform: scale(1.2);"> <span data-i18n="slew_center">Slew & Center</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-guide" checked style="transform: scale(1.2);"> <span data-i18n="start_guide">Avvia Autoguida</span>
                    </label>
                </div>
                <div style="background: #222; padding: 15px; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: #fff;" data-i18n="end_sec">Fine / Sicurezza</h4>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-warm" checked style="transform: scale(1.2);"> <span data-i18n="warm_cam">Riscalda Camera</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-park" checked style="transform: scale(1.2);"> <span data-i18n="park_mount">Parcheggia Montatura</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; width: 100%; cursor: pointer; color: #aaa; font-size: 0.9em;">
                        <input type="checkbox" id="nina-flip" checked style="transform: scale(1.2);"> <span data-i18n="meridian_flip">Attiva Meridian Flip</span>
                    </label>
                </div>
                <div style="background: #222; padding: 15px; border-radius: 8px; grid-column: 1 / -1;">
                    <h4 style="margin: 0 0 5px 0; color: #fff;"><span data-i18n="filter_map">Mappatura Nomi Filtri</span></h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;" id="nina-filters-container">
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button id="btn-export-nina" class="btn-smart" style="background: linear-gradient(135deg, #ff4444 0%, #aa0000 100%); box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);" onclick="esportaNINA()" data-i18n="gen_nina_btn">üíæ Genera File per N.I.N.A.</button>
                <button id="btn-report-mosaic" class="btn-smart" style="display: none; background: linear-gradient(135deg, #7c4dff 0%, #3f51b5 100%); box-shadow: 0 4px 15px rgba(124, 77, 255, 0.3);" onclick="apriReport()" data-i18n="gen_report_btn">üìù Genera Report Strategico</button>
                <p id="nina-mosaic-msg" style="display: none; color: #ffaa00; font-size: 0.9em; margin-top: 15px; padding: 15px; background: rgba(255, 170, 0, 0.1); border-left: 3px solid #ffaa00;">üìå Modalit√† Mosaico attiva. Usa il Framing Assistant di N.I.N.A.</p>
            </div>
        </div>
    </div>
<div id="floating-tooltip" class="floating-tooltip"></div>

    <div id="report-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="chiudiReport()">&times;</span>
            <h2 style="color: #bb86fc; margin-top:0; border-bottom: none; display: flex; align-items: center; gap: 10px;"><span data-i18n="report_title">Dossier Mosaico</span></h2>
            <div id="report-content"></div>
            <button class="btn-copy" onclick="copiaReport()" id="btn-copy-report"><span data-i18n="copy_report">üìã Copia negli Appunti</span></button>
        </div>
    </div>

    <div id="multinight-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-btn" onclick="chiudiMultiNight()">&times;</span>
            <h2 style="color: #ffaa00; margin-top:0; border-bottom: 1px solid #333; padding-bottom: 15px;">üìÖ Multi-Night Project Manager</h2>
            <div style="background: rgba(255, 68, 68, 0.1); border-left: 3px solid #ff4444; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
                <span style="font-size: 0.85em; color: #ffaaaa; display: block; line-height: 1.4;"><b>‚ö†Ô∏è ATTENZIONE N.I.N.A.:</b> Assicurati che i nomi dei filtri nella "Mappatura Nomi" (nel pannello principale in basso) corrispondano <b>esattamente</b> a quelli scritti nella tua ruota portafiltri, altrimenti il file dar√† errore!</span>
            </div>            
            <div style="display: flex; justify-content: space-between; align-items: center; background: #2a2a2a; padding: 15px; border-radius: 8px; border-left: 4px solid #bb86fc; margin-bottom: 20px;">
                <div>
                    <h4 style="margin: 0 0 5px 0; color: #aaa;">Target Consigliato (AI)</h4>
                    <b id="mn-target-hours" style="font-size: 1.4em; color: #fff;">-- Ore</b>
                </div>
                <div style="text-align: right;">
                    <h4 style="margin: 0 0 5px 0; color: #aaa;">Tempo Pianificato</h4>
                    <b id="mn-assigned-hours" style="font-size: 1.4em; color: #44ff44;">0 Ore</b>
                </div>
            </div>
            <div id="mn-nights-container" style="display: flex; flex-direction: column; gap: 15px;"></div>
            <button class="btn-smart" style="margin-top: 20px; width: 100%; background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); box-shadow: none;" onclick="aggiungiNotte()">‚ûï Aggiungi Sessione (Notte)</button>
        </div>
    </div>

    <div id="guide-view">
        <button class="btn-back" style="margin-bottom: 40px;" onclick="chiudiGuida()" data-i18n="back_dash">Torna Indietro</button>
        <div id="guide-it">
            <h2 style="font-size: 2.4em; border-bottom: 2px solid #bb86fc; padding-bottom: 15px; margin-bottom: 30px;">üìñ Manuale AstroDashboard PRO</h2>
            <div class="filosofia-box"><h3 style="color: #fff; margin-top:0;">La Filosofia del Software</h3><p>AstroDashboard √® progettata per essere il "Direttore d'Orchestra" della tua strumentazione.</p></div>
        </div>
    </div>

<script>
        const i18n = {
            it: {
                "manual_btn": "üìñ Apri Manuale", "pos_title": "üìç Posizione", "find_place": "Trova Luogo:", "search_place": "Es. Monte Lussari...",
                "lat": "Latitudine:", "lon": "Longitudine:", "env_data": "üéõÔ∏è Dati Ambientali",
                "low_clouds": "Nuvole Basse", "mid_clouds": "Nuvole Medie", "high_clouds": "Nuvole Alte", "moon_poll": "Inq. Lunare",
                "humidity": "Umidit√†", "seeing_est": "Stima Seeing", "now": "Adesso",
                "hybrid_planetarium": "üî≠ Planetario Predittivo Ibrido", "solar_system": "ü™ê Sistema Solare",
                "rec_targets": "üåå Oggetti Consigliati Visibili", "free_search": "üîç Ricerca Libera Oggetto", "search_target": "Es. M31, Pleiadi...",
                "plan_target_btn": "Pianifica üöÄ", "back_dash": "Torna alla Dashboard", "change_target": "Cambia",
                "dossier": "üìñ Dossier Astrofotografico", "type": "Tipologia", "app_mag": "Magnitudine App.", "distance": "Distanza", "wiki_link": "üîó Wikipedia",
                "tactical_tip": "üí° Consiglio Tattico:", "optical_setup": "üì∏ Setup Ottico", "telescope": "Telescopio:", "focal_len": "Focale (mm):",
                "sensor": "Sensore:", "width": "Larg. W (mm):", "height": "Alt. H (mm):", "fov_calc": "Campo Inquadrato Calcolato",
                "fov_sim": "üìê Simulatore FOV Realistico (DSS2)", "smart_calc": "‚è±Ô∏è Calcolatore Sessione Smart AI",
                "sunset": "Tramonto", "night_start": "Inizio Notte Astr.", "night_end": "Fine Notte Astr.", "sunrise": "Alba",
                "session_start": "Inizio Sessione:", "session_end": "Fine Sessione:", "sensor_type": "Tipo Sensore:",
                "seq_setup": "Impostazione Sequenza", "gen_seq_btn": "‚ú® Genera Sequenza Ottimale", "use_frame": "Usa | Frame", "poses_sec": "Pose x Sec.",
                "total": "Totale", "every": "Ogni", "avail_window": "Finestra Disponibile", "acq_time": "Tempo Acquisizione", "res_time": "Tempo Residuo", "time_overflow": "‚ö†Ô∏è Sforamento tempo!",
                "nina_export_title": "üöÄ Esportazione N.I.N.A. Advanced Sequencer", "seq_start": "Avvio Sequenza", "cool_cam": "Raffredda Camera a",
                "slew_center": "Slew & Center (Plate Solve)", "start_guide": "Avvia Autoguida", "end_sec": "Fine / Sicurezza", "warm_cam": "Riscalda Camera (Warm Up)",
                "park_mount": "Parcheggia Montatura", "meridian_flip": "Attiva Meridian Flip", "filter_map": "Mappatura Nomi Filtri", "gen_nina_btn": "üíæ Genera File per N.I.N.A.",
                "clear": "Sereno", "partly_cloudy": "Poco Nuvoloso", "mostly_cloudy": "Nubi Sparse", "overcast": "Coperto", "daytime": "Giorno",
                "new_moon": "Luna Nuova", "waxing_crescent": "Falce Crescente", "first_quarter": "Primo Quarto", "waxing_gibbous": "Gibbosa Crescente", "full_moon": "Luna Piena", "waning_gibbous": "Gibbosa Calante", "last_quarter": "Ultimo Quarto", "waning_crescent": "Falce Calante",
                "galaxy": "Galassia", "nebula": "Nebulosa", "cluster": "Ammasso", "star": "Stella", "unknown": "Sconosciuta",
                "alert_planetarium": "Scegli prima un bersaglio dal Planetario üî≠!", "alert_noseq": "Nessuna posa calcolata! Clicca prima su 'Genera Sequenza Ottimale'.",
                "alert_calib": "I frame di calibrazione occupano tutto il tempo!", "alert_nolight": "Seleziona almeno un filtro Light.", "alert_times": "Imposta prima gli orari di Inizio e Fine.", "no_target": "Nessun oggetto visibile.", "too_bright": "‚òÄÔ∏è Cielo troppo luminoso.", "dso_too_bright": "‚òÄÔ∏è Cielo troppo luminoso per il Deep Sky.", "select_opt": "-- Seleziona --",
                "jupiter": "Giove", "mars": "Marte", "venus": "Venere", "moon": "Luna", "sun": "Sole", "weather": "Meteo",
                "mode": "Modalit√†:", "single_panel": "Scatto Singolo", "mosaic": "Mosaico", "panels": "Pannelli (X, Y):", "overlap": "Sovrapposizione:", "time_per_panel": "Tempo per Pannello",
                "gen_report_btn": "üìù Genera Report Strategico", "report_title": "Dossier Mosaico", "copy_report": "Copia negli Appunti", "copied": "Copiato!", "report_general": "Info Generali Mosaico", "report_strategy": "Strategia Singolo Pannello", "report_plan": "Piano di Scatto"
            }
        };

        let lang = localStorage.getItem('ad_lang') || 'it';
        function t(key) { return i18n[lang] && i18n[lang][key] ? i18n[lang][key] : key; }

        function changeLanguage(l) {
            lang = l; localStorage.setItem('ad_lang', l);
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            let actBtn = document.getElementById('btn-lang-' + l);
            if(actBtn) actBtn.classList.add('active');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                let k = el.getAttribute('data-i18n');
                if (el.tagName === 'INPUT') el.placeholder = t(k); else el.innerHTML = t(k);
            });
        }

        const dbTelescopi = [{ nome: "Askar FRA 400", focale: 400, diametro: 72 }, { nome: "SW Explorer 150P", focale: 750, diametro: 150 }, { nome: "Celestron C8 SCT", focale: 2032, diametro: 203 }];
        const dbCamere = [{ nome: "ASI 533MC/MM (Square)", w: 11.31, h: 11.31 }, { nome: "SONY IMX571 ", w: 23.5, h: 15.7 }, { nome: "ASI 6200MC/MM (Full Frame)", w: 36.0, h: 24.0 }];

        function popolaMenuAttrezzatura() {
            const selTel = document.getElementById('preset-telescope'); dbTelescopi.forEach(t => { let opt = document.createElement('option'); opt.value = t.focale + ',' + t.diametro; opt.textContent = t.nome; selTel.appendChild(opt); });
            const selCam = document.getElementById('preset-sensor'); dbCamere.forEach(c => { let opt = document.createElement('option'); opt.value = `${c.w},${c.h}`; opt.textContent = c.nome; selCam.appendChild(opt); });
        }
        
        let latCorrente = 46.062, lonCorrente = 13.235, datiMeteo = null, indicePartenza = 0, chartAltezza = null, targetSelezionato = null, aladinSkyMap = null, vistaPrecedente = 'dashboard-view';
        let mappaScura = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 });
        let map = L.map('map', { center: [latCorrente, lonCorrente], zoom: 8, layers: [mappaScura], zoomControl: false });
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        let layers = { basse: L.layerGroup().addTo(map), medie: L.layerGroup(), alte: L.layerGroup(), jet: L.layerGroup(), luna: L.layerGroup(), umidita: L.layerGroup() };
        let marker = L.marker([latCorrente, lonCorrente]).addTo(map);
        let timerRicerca;

        const planetsDatabase = [ { id: "jupiter", name: "Giove", icon: "ü™ê", ra: 7.15, dec: 22.8 }, { id: "mars", name: "Marte", icon: "üî¥", ra: 18.50, dec: -23.5 } ];

        function getJulianDate(date) { return (date.getTime() / 86400000) + 2440587.5; }
        function calcolaAltAz(ra, dec, lat, lon, date) {
            let jd = getJulianDate(date), d = jd - 2451545.0, lst = (280.46061837 + 360.98564736629 * d + lon) % 360; if (lst < 0) lst += 360;
            let ra_deg = ra * 15, ha_deg = lst - ra_deg, rad = Math.PI / 180;
            let sin_alt = Math.sin(lat*rad)*Math.sin(dec*rad) + Math.cos(lat*rad)*Math.cos(dec*rad)*Math.cos(ha_deg*rad);
            let alt_deg = Math.asin(sin_alt) / rad;
            let cos_az = (Math.sin(dec*rad) - Math.sin(lat*rad)*sin_alt) / (Math.cos(lat*rad) * Math.cos(Math.asin(sin_alt)));
            cos_az = Math.max(-1, Math.min(1, cos_az)); 
            let az_deg = Math.acos(cos_az) / rad; if (Math.sin(ha_deg*rad) > 0) az_deg = 360 - az_deg;
            return { alt: alt_deg, az: az_deg };
        }
        function getPuntoCardinale(az) { return ["N", "NE", "E", "SE", "S", "SW", "W", "NW", "N"][Math.round(az / 45) % 8]; }

        function cercaIndirizzo() {
            let query = document.getElementById('ricerca').value, dropdown = document.getElementById('dropdown-risultati');
            if (query.length < 3) { dropdown.style.display = 'none'; return; }
            clearTimeout(timerRicerca);
            timerRicerca = setTimeout(() => {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                    .then(r => r.json()).then(data => {
                        dropdown.innerHTML = ''; 
                        if (data.length > 0) {
                            dropdown.style.display = 'block'; data.forEach(l => { let li = document.createElement('li'); li.textContent = l.display_name; li.onclick = () => selezionaLuogo(l.lat, l.lon, l.display_name); dropdown.appendChild(li); });
                        } else dropdown.style.display = 'none';
                    });
            }, 500); 
        }

        function selezionaLuogo(lat, lon, nome) {
            latCorrente = parseFloat(lat); lonCorrente = parseFloat(lon);
            document.getElementById('ricerca').value = nome.split(',')[0];
            document.getElementById('lat').value = latCorrente.toFixed(5); document.getElementById('lon').value = lonCorrente.toFixed(5);
            document.getElementById('dropdown-risultati').style.display = 'none';
            map.flyTo([latCorrente, lonCorrente], 9);
            aggiornaEffemeridi(new Date()); scaricaDatiPrevisionali();
        }
function aggiornaEffemeridi(data) {
            let orariSole = SunCalc.getTimes(data, latCorrente, lonCorrente), orariLuna = SunCalc.getMoonTimes(data, latCorrente, lonCorrente), faseLuna = SunCalc.getMoonIllumination(data);
            let formattaOra = (d) => d && !isNaN(d) ? d.toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}) : '--:--';
            document.getElementById('alba-sole').innerText = formattaOra(orariSole.sunrise); document.getElementById('tramonto-sole').innerText = formattaOra(orariSole.sunset);
            document.getElementById('alba-luna').innerText = orariLuna.rise ? formattaOra(orariLuna.rise) : '--:--'; document.getElementById('tramonto-luna').innerText = orariLuna.set ? formattaOra(orariLuna.set) : '--:--';
            let f = faseLuna.phase, i = 'üåë';
            if(f>0.03&&f<=0.22) i='üåí'; else if(f>0.22&&f<=0.28) i='üåì'; else if(f>0.28&&f<=0.47) i='üåî'; else if(f>0.47&&f<=0.53) i='üåï'; else if(f>0.53&&f<=0.72) i='üåñ'; else if(f>0.72&&f<=0.78) i='üåó'; else if(f>0.78&&f<=0.97) i='üåò';
            document.getElementById('moon-emoji').innerText = i;
        }

        function scaricaDatiPrevisionali() {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latCorrente}&longitude=${lonCorrente}&hourly=cloud_cover_low,cloud_cover_mid,cloud_cover_high,wind_speed_250hPa,wind_speed_10m,temperature_2m,relative_humidity_2m&forecast_days=3&timezone=auto`)
            .then(r => r.json()).then(data => {
                datiMeteo = data.hourly; let adesso = new Date();
                indicePartenza = Math.max(0, datiMeteo.time.findIndex(x => new Date(x).getTime() >= adesso.getTime() - 3600000));
                document.getElementById('timeSlider').disabled = false; document.getElementById('timeSlider').value = 0; 
                document.getElementById('astroSlider').disabled = false; document.getElementById('astroSlider').value = 0; 
                cambiaOraMeteo(); cambiaOraAstro();
            });
        }

        function syncSliders(val) { document.getElementById('timeSlider').value = val; document.getElementById('astroSlider').value = val; cambiaOraMeteo(); cambiaOraAstro(); }

        function cambiaOraMeteo() {
            if (!datiMeteo) return;
            let step = parseInt(document.getElementById('timeSlider').value), i = indicePartenza + step, dOra = new Date(datiMeteo.time[i]);
            let tOra = step === 0 ? t("now") + " (" + new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'}) + ")" : dOra.toLocaleDateString(lang==='it'?'it-IT':'en-US', { weekday: 'short', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            if (step > 0 && dOra.getHours() === 0) aggiornaEffemeridi(dOra);

            let b = datiMeteo.cloud_cover_low[i], m = datiMeteo.cloud_cover_mid[i], a = datiMeteo.cloud_cover_high[i], jet = Math.round(datiMeteo.wind_speed_250hPa[i]), vs = datiMeteo.wind_speed_10m[i], temp = datiMeteo.temperature_2m[i], um = datiMeteo.relative_humidity_2m[i];
            let altS = SunCalc.getPosition(dOra, latCorrente, lonCorrente).altitude * (180/Math.PI), mP = SunCalc.getMoonPosition(dOra, latCorrente, lonCorrente);
            
            let maxC = Math.max(b, m, a), icM = "‚òÅÔ∏è", dsM = "overcast";
            if (maxC < 15) { icM = "‚òÄÔ∏è"; dsM = "clear"; } else if (maxC < 40) { icM = "üå§Ô∏è"; dsM = "partly_cloudy"; } else if (maxC < 75) { icM = "‚õÖ"; dsM = "mostly_cloudy"; }
            if (altS < -6) { if (maxC < 15) icM = "‚ú®"; else if (maxC < 40) icM = "üåô"; }

            document.getElementById('time-display').innerHTML = `<span style="font-size: 1.5em; vertical-align: middle; margin-right: 5px;">${icM}</span> ${tOra} <br><span style="font-size: 0.75em; color: #aaa; text-transform: uppercase;">${t("weather")}: <b style="color: #fff;">${t(dsM)}</b></span>`;
            document.getElementById('meteo-temp').innerText = Math.round(temp) + "¬∞C";
            document.getElementById('meteo-umidita').innerText = t("humidity")+": " + um + "%"; document.getElementById('meteo-umidita').style.color = um > 85 ? "#ff4444" : "#44ff44";
            document.getElementById('val-umidita-layer').innerText = um + "%";
            
            let inqL = (altS < -6 && mP.altitude > 0) ? Math.max(0, Math.round((SunCalc.getMoonIllumination(dOra).fraction * Math.sin(mP.altitude)) * 100)) : 0;
            let scS = 5; if(jet>120)scS-=3;else if(jet>80)scS-=2;else if(jet>50)scS-=1; if(vs>15)scS-=1; if(vs>30)scS-=1;
            
            document.getElementById('val-seeing').innerText = altS > -6 ? t("daytime") : Math.max(1, scS) + "/5";
            document.getElementById('val-seeing').style.color = altS > -6 ? "#ffaa00" : "#bb86fc";
            document.getElementById('val-basse').innerText = b+"%"; document.getElementById('val-medie').innerText = m+"%"; document.getElementById('val-alte').innerText = a+"%"; document.getElementById('val-jet').innerHTML = jet+' <span class="jet-unit">km/h</span>'; document.getElementById('val-luna').innerText = inqL+"%";

            Object.values(layers).forEach(l => l.clearLayers());
            L.circle([latCorrente, lonCorrente], { radius: 50000, color: '#ff4444', fillColor: '#ff4444', fillOpacity: (b/100)*0.7, weight: 1 }).addTo(layers.basse);
            L.circle([latCorrente, lonCorrente], { radius: 50000, color: '#44ff44', fillColor: '#44ff44', fillOpacity: (m/100)*0.7, weight: 1 }).addTo(layers.medie);
            L.circle([latCorrente, lonCorrente], { radius: 50000, color: '#4444ff', fillColor: '#4444ff', fillOpacity: (a/100)*0.7, weight: 1 }).addTo(layers.alte);
            if(jet>50) L.circle([latCorrente, lonCorrente], { radius: 60000, color: '#ff00ff', fillColor: '#ff00ff', fillOpacity: (jet/200)*0.5, weight: 2, dashArray: '10, 10' }).addTo(layers.jet);
            if(inqL>0) L.circle([latCorrente, lonCorrente], { radius: 100000, color: '#ffffaa', fillColor: '#ffffaa', fillOpacity: (inqL/100)*0.4, weight: 0 }).addTo(layers.luna);
            if(um>60) L.circle([latCorrente, lonCorrente], { radius: 75000, color: '#00ffff', fillColor: '#00ffff', fillOpacity: ((um-60)/100)*0.5, weight: 1, dashArray: '5, 5' }).addTo(layers.umidita);
        }

        function toggleLayer(n) { let b = document.getElementById('btn-'+n), l = layers[n]; if (map.hasLayer(l)) { map.removeLayer(l); b.classList.replace('active','disabled'); } else { map.addLayer(l); b.classList.replace('disabled','active'); } }

        function cambiaOraAstro() {
            if (!datiMeteo) return;
            let step = parseInt(document.getElementById('astroSlider').value), dOra = new Date(datiMeteo.time[indicePartenza + step]);
            document.getElementById('astro-time-display').innerText = "üî≠ " + (step === 0 ? t("now") + " (" + new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'}) + ")" : dOra.toLocaleDateString(lang==='it'?'it-IT':'en-US', { weekday: 'short', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }));
            
            let pL = document.getElementById('planets-list'), dL = document.getElementById('dso-list'); pL.innerHTML = ''; dL.innerHTML = '';
            if (SunCalc.getPosition(dOra, latCorrente, lonCorrente).altitude * (180/Math.PI) > -6) { pL.innerHTML = dL.innerHTML = `<p style="color:#aaa; padding:10px;">${t("too_bright")}</p>`; return; }

            let vP = [], mP = SunCalc.getMoonPosition(dOra, latCorrente, lonCorrente), mA = mP.altitude * (180/Math.PI);
            if (mA > 5) vP.push({ html: creaCardHTML({id: "moon", name: "moon", icon: "üåï"}, mA, (mP.azimuth * 180/Math.PI + 180) % 360, false), alt: mA });
            planetsDatabase.forEach(p => { let pos = calcolaAltAz(p.ra, p.dec, latCorrente, lonCorrente, dOra); if (pos.alt > 10) vP.push({ html: creaCardHTML(p, pos.alt, pos.az, false), alt: pos.alt }); });
            vP.sort((a, b) => b.alt - a.alt).forEach(i => pL.appendChild(i.html));

            let vD = [];
            if (typeof dsoDatabase !== 'undefined') dsoDatabase.forEach(d => { let pos = calcolaAltAz(d.ra, d.dec, latCorrente, lonCorrente, dOra); if (pos.alt > 15) vD.push({ html: creaCardHTML(d, pos.alt, pos.az, true), alt: pos.alt }); });
            vD.sort((a, b) => b.alt - a.alt); if (vD.length > 0) vD[0].html.classList.add('top-target');
            vD.forEach(i => dL.appendChild(i.html));
            if (dL.innerHTML === '') dL.innerHTML = `<p style="color:#777; padding:10px;">${t("no_target")}</p>`;
        }

        function mapTypeTrans(type) { return type; }
        function getLocalizedName(obj) { return obj.name; }
        function getLocalizedText(obj, key) { return obj[key] || "--"; }

        function creaCardHTML(tObj, alt, az, c) {
            let div = document.createElement('div'); div.className = c ? 'dso-card card-clickable' : 'dso-card card-static';
            let finalName = getLocalizedName(tObj);
            div.innerHTML = `<div class="dso-icon">${tObj.icon||'üåå'}</div><div class="dso-info"><h4>${finalName}</h4><p>Alt: <b>${Math.round(alt)}¬∞</b></p><span class="dso-direction">${getPuntoCardinale(az)}</span></div>`;
            if(c) div.onclick = () => apriPianificazione(tObj); return div;
        }

        function eseguiRicerca(iId) {
            let q = document.getElementById(iId).value.trim(); if (!q) return;
            let mockRes = { name: q.toUpperCase(), ra: 10, dec: 40, type: "Galassia", mag: "8.0", dist: "N/D", link: "#", desc: "Dati estratti dal server SIMBAD.", tips: "Pianifica la sessione." };
            apriPianificazione(mockRes);
        }

        function apriPianificazione(tObj) {
            targetSelezionato = tObj; document.getElementById('dashboard-view').style.display = 'none'; document.getElementById('planning-view').style.display = 'block';
            document.getElementById('plan-target-name').innerText = getLocalizedName(targetSelezionato);
            document.getElementById('stat-type').innerText = targetSelezionato.type || "--";
            document.getElementById('stat-mag').innerText = targetSelezionato.mag || "--";
            
            let dOggi = new Date(); if (dOggi.getHours() < 12) dOggi.setDate(dOggi.getDate() - 1); 
            let atStart = SunCalc.getTimes(dOggi, latCorrente, lonCorrente);
            let dDomani = new Date(dOggi.getTime() + 86400000); let atEnd = SunCalc.getTimes(dDomani, latCorrente, lonCorrente);
            let ft = (x) => x && !isNaN(x) ? x.toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}) : '--:--';
            
            document.getElementById('info-sunset').innerText = ft(atStart.sunset); 
            document.getElementById('info-nightstart').innerText = ft(atStart.night); 
            document.getElementById('info-nightend').innerText = ft(atEnd.nightEnd); 
            document.getElementById('info-sunrise').innerText = ft(atEnd.sunrise);
            
            let nS = atStart.night || atStart.sunset; let nE = atEnd.nightEnd || atEnd.sunrise;
            let cur = new Date(nS.getTime()); let maxA = -90; let currentBlock = { start: null, end: null }; let bestBlock = { start: null, end: null, duration: 0 }; let isAbove = false;
            
            while(cur <= nE) {
                let a = calcolaAltAz(targetSelezionato.ra, targetSelezionato.dec, latCorrente, lonCorrente, cur).alt;
                if(a > maxA) maxA = a;
                if(a >= 30) { if(!isAbove) { currentBlock.start = new Date(cur); isAbove = true; } currentBlock.end = new Date(cur); } 
                else { if(isAbove) { let dur = currentBlock.end.getTime() - currentBlock.start.getTime(); if(dur > bestBlock.duration) { bestBlock = { start: currentBlock.start, end: currentBlock.end, duration: dur }; } isAbove = false; } }
                cur.setMinutes(cur.getMinutes() + 10);
            }
            if(isAbove) { let dur = currentBlock.end.getTime() - currentBlock.start.getTime(); if(dur > bestBlock.duration) { bestBlock = { start: currentBlock.start, end: currentBlock.end, duration: dur }; } }
            
            if(bestBlock.duration > 0) { document.getElementById('time-start').value = ft(bestBlock.start); document.getElementById('time-end').value = ft(bestBlock.end); } 
            else { document.getElementById('time-start').value = ft(nS); document.getElementById('time-end').value = ft(nE); }

            if (!aladinSkyMap) { aladinSkyMap = A.aladin('#aladin-lite-div', { survey: "P/DSS2/color", fov: 2, target: (targetSelezionato.ra * 15) + " " + targetSelezionato.dec, showReticle: false, showZoomControl: false, showFullscreenControl: false, showLayersControl: false, showGotoControl: false }); setTimeout(() => { toggleMosaic(); }, 300); } 
            else { setTimeout(() => { aladinSkyMap.gotoRaDec(targetSelezionato.ra * 15, targetSelezionato.dec); toggleMosaic(); }, 100); }
            disegnaGraficoAltezza(); toggleSensorMode(); calcolaTempi(); window.scrollTo(0,0);
        }

        function tornaDashboard() { document.getElementById('planning-view').style.display = 'none'; document.getElementById('dashboard-view').style.display = 'block'; }
        
        function applicaPresetTelescopio() { let v = document.getElementById('preset-telescope').value; if(v){ let p = v.split(','); document.getElementById('focal-length').value = p[0]; document.getElementById('aperture').value = p[1] || 100; aggiornaFOV(); } }
        function applicaPresetSensore() { let v = document.getElementById('preset-sensor').value; if(v){let p=v.split(',');document.getElementById('sensor-width').value=p[0];document.getElementById('sensor-height').value=p[1];aggiornaFOV();} }

        function toggleMosaic() {
            let isMosaic = document.getElementById('capture-mode').value === 'mosaic';
            document.getElementById('mosaic-settings').style.display = isMosaic ? 'flex' : 'none';
            document.getElementById('btn-export-nina').style.display = isMosaic ? 'none' : 'inline-block';
            aggiornaFOV(); calcolaTempi(); 
        }

        function aggiornaFOV() {
            let fl = parseFloat(document.getElementById('focal-length').value) || 1000, sw = parseFloat(document.getElementById('sensor-width').value) || 23.5, sh = parseFloat(document.getElementById('sensor-height').value) || 15.6;
            let fW = (2 * Math.atan(sw / (2 * fl)) * (180 / Math.PI)), fH = (2 * Math.atan(sh / (2 * fl)) * (180 / Math.PI));
            document.getElementById('fov-result').innerText = `${fW.toFixed(2)}¬∞ x ${fH.toFixed(2)}¬∞`;
            aggiornaAI();
        }

        function disegnaGraficoAltezza() {
            if (!targetSelezionato) return; if (chartAltezza) chartAltezza.destroy();
            let lbl = [], dat = [], d = new Date(), sd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 18, 0, 0);
            for (let i = 0; i <= 12; i++) { let fd = new Date(sd.getTime() + i*3600000); lbl.push(fd.getHours() + "h"); dat.push(Math.max(0, calcolaAltAz(targetSelezionato.ra, targetSelezionato.dec, latCorrente, lonCorrente, fd).alt)); }
            chartAltezza = new Chart(document.getElementById('altitudeChart').getContext('2d'), { type: 'line', data: { labels: lbl, datasets: [{ label: 'Alt (¬∞)', data: dat, borderColor: '#bb86fc', backgroundColor: 'rgba(187, 134, 252, 0.3)', tension: 0.4, fill: true, pointRadius: 2, borderWidth: 2 }] } });
        }

        const framesColor = [{ id: "c-light", name: "Light", class: "f-l", dC: 0, dE: 180 }, { id: "c-dark", name: "Dark", class: "f-dark", dC: 0, dE: 180 }, { id: "c-bias", name: "Bias", class: "f-bias", dC: 0, dE: 0 }];
        const framesMono = [{ id: "m-l", name: "L", class: "f-l", dC: 0, dE: 30 }, { id: "m-r", name: "R", class: "f-r", dC: 0, dE: 120 }, { id: "m-g", name: "G", class: "f-g", dC: 0, dE: 120 }, { id: "m-b", name: "B", class: "f-b", dC: 0, dE: 120 }, { id: "m-ha", name: "Ha", class: "f-ha", dC: 0, dE: 300 }, { id: "m-oiii", name: "O3", class: "f-oiii", dC: 0, dE: 300 }, { id: "m-sii", name: "S2", class: "f-sii", dC: 0, dE: 300 }];

        function toggleLock(id) { let el = document.getElementById(id + '-lock'); if (!el) return; if (el.innerText === 'üîì') { el.innerText = 'üîí'; el.style.opacity = '1'; el.classList.add('locked'); } else { el.innerText = 'üîì'; el.style.opacity = '0.5'; el.classList.remove('locked'); } }

        function toggleSensorMode() {
            let isM = document.getElementById('sensor-type').value === 'mono', c = document.getElementById('frames-container'); c.innerHTML = '';
            (isM ? framesMono : framesColor).forEach(f => {
                let isL = !f.id.includes('dark') && !f.id.includes('bias'), r = document.createElement('div'); r.className = `calc-row ${f.class}`;
                let lockHTML = isL ? `<span id="${f.id}-lock" style="cursor:pointer; font-size:1.1em; margin-left:5px; opacity:0.5;" onclick="toggleLock('${f.id}')">üîì</span>` : `<span style="display:inline-block; width:22px; margin-left:5px;"></span>`;
                r.innerHTML = `<div style="display:flex; align-items:center; width: 140px;">${isL ? `<input type="checkbox" id="${f.id}-check" checked style="margin-right:10px; transform: scale(1.2);" onchange="calcolaTempi()">` : ''}<label>${f.name}</label></div><div class="calc-inputs"><input type="number" id="${f.id}-count" value="${f.dC}" min="0" oninput="calcolaTempi()"> x <input type="number" id="${f.id}-exp" value="${f.dE}" min="0" oninput="calcolaTempi()"> s ${lockHTML}</div><div class="calc-total" id="${f.id}-tot">0m</div>`;
                c.appendChild(r);
            });
            aggiornaFiltriNina();
        }

        const dsoVIP = { "M31": { hours: 4, tips: "Nucleo estremo. HDR necessario." }, "M42": { hours: 3, tips: "Il Trapezio brucia." }, "M81": { hours: 12, tips: "Bode e IFN. Cieli scuri." }, "Ou4": { hours: 35, tips: "Segnale OIII debolissimo." } };
        let oreNecessarieGlobali = 0; 

        function aggiornaAI() {
            if(!targetSelezionato) return;
            let panel = document.getElementById('ai-advisor-panel'); if(!panel) return;
            panel.style.display = 'block';

            let ty = targetSelezionato.type ? targetSelezionato.type.toLowerCase() : "", nameID = targetSelezionato.id || targetSelezionato.name;
            let bH = dsoVIP[nameID] ? dsoVIP[nameID].hours : (ty.includes('galassi') ? 2 : 4);
            let tacticalMsg = dsoVIP[nameID] ? dsoVIP[nameID].tips : "Calcolo AI Standard.";

            let mMatch = targetSelezionato.mag ? targetSelezionato.mag.toString().match(/[\d.]+/) : null;
            let mVal = mMatch ? parseFloat(mMatch[0]) : 6.0;
            let subT = Math.max(0.5, bH + (mVal - 6.0));

            let fL = parseFloat(document.getElementById('focal-length').value)||400, ap = parseFloat(document.getElementById('aperture').value)||72;
            let fFact = Math.pow((fL / ap) / 4.0, 2);

            let isM = document.getElementById('sensor-type').value === 'mono', doingN = false;
            (isM ? framesMono : framesColor).forEach(f => { let c = document.getElementById(`${f.id}-check`); if(c && c.checked && (parseInt(document.getElementById(`${f.id}-count`).value)||0)>0 && (f.id.includes('ha')||f.id.includes('oiii')||f.id.includes('sii'))) doingN = true; });
            let sFact = (doingN && !ty.includes('emission')) ? 2.0 : 1.0;

            let mIll = SunCalc.getMoonIllumination(new Date()).fraction, mFact = (!doingN && mIll>0.75) ? 2.0 : (!doingN && mIll>0.3 ? 1.5 : 1.0);
            
            let totId = subT * sFact * mFact * fFact;
            let isMosaic = document.getElementById('capture-mode').value === 'mosaic';
            if (isMosaic) totId *= (parseInt(document.getElementById('mosaic-x').value)||1) * (parseInt(document.getElementById('mosaic-y').value)||1);

            oreNecessarieGlobali = totId;

            let tS = document.getElementById('time-start').value, tE = document.getElementById('time-end').value, aS = 0;
            if(tS && tE) { let dS = new Date(`1970-01-01T${tS}:00`), dE = new Date(`1970-01-01T${tE}:00`); if (dE <= dS) dE.setDate(dE.getDate() + 1); aS = (dE - dS) / 3600000; }
            
            let perc = totId > 0 ? Math.min(100, Math.round((aS / totId) * 100)) : 100;

            let html = `<h4 style="margin:0 0 10px 0; color:#ffaa00; border-bottom:1px solid #333; padding-bottom:5px;">üß† Criteri di Valutazione AI</h4>`;
            html += `<p style="font-size:0.95em; margin:0 0 5px 0;">Obiettivo Totale: <b style="color:#fff;">${totId.toFixed(1)} Ore</b></p><p style="font-size:0.8em; color:#aaa; margin-bottom:10px;"><i>${tacticalMsg}</i></p>`;
            
            if (aS < totId * 0.9) {
                html += `<div style="margin-top:10px; padding:10px; background:rgba(255,170,0,0.1); border-left:3px solid #ffaa00; border-radius:4px; font-size:0.85em; color:#fff;">‚è≥ <b>Avviso:</b> Stasera integri solo il <b>${perc}%</b> del segnale necessario.<button class="btn-guide" style="width:100%; margin-top:8px; border-color:#ffaa00; color:#ffaa00;" onclick="apriMultiNight()">üìÖ Crea Progetto Multi-Notte</button></div>`;
            } else {
                html += `<div style="margin-top:10px; padding:10px; background:rgba(68,255,68,0.1); border-left:3px solid #44ff44; border-radius:4px; font-size:0.85em; color:#fff;">‚úÖ <b>Segnale Ottimale:</b> La sessione di stasera √® sufficiente.</div>`;
            }
            panel.innerHTML = html;
        }

        function calcolaTempi() {
            let tS = document.getElementById('time-start').value, tE = document.getElementById('time-end').value; if(!tS || !tE) return;
            let dS = new Date(`1970-01-01T${tS}:00`), dE = new Date(`1970-01-01T${tE}:00`); if (dE <= dS) dE.setDate(dE.getDate() + 1);
            let aS = (dE - dS) / 1000; 
            
            let isMosaic = document.getElementById('capture-mode').value === 'mosaic';
            if (isMosaic) aS = aS / ((parseInt(document.getElementById('mosaic-x').value)||1) * (parseInt(document.getElementById('mosaic-y').value)||1));
            document.getElementById('calc-available').innerHTML = `${Math.floor(aS/3600)}h ${Math.floor((aS%3600)/60)}m`;

            let fL = document.getElementById('sensor-type').value === 'mono' ? framesMono : framesColor, tSec = 0, tLF = 0;
            fL.forEach(f => {
                let c = parseInt(document.getElementById(`${f.id}-count`).value)||0, e = parseInt(document.getElementById(`${f.id}-exp`).value)||0, rs = c * e;
                tSec += rs; if (!f.id.includes('dark') && !f.id.includes('bias')) tLF += c;
                document.getElementById(`${f.id}-tot`).innerText = Math.floor(rs/3600)>0 ? `${Math.floor(rs/3600)}h ${Math.floor((rs%3600)/60)}m` : `${Math.floor((rs%3600)/60)}m`;
            });

            let dC = document.getElementById('dither-check'), dSec = 0;
            if (dC && dC.checked) {
                let dF = parseInt(document.getElementById('dither-freq').value)||1, dD = parseInt(document.getElementById('dither-duration').value)||0;
                dSec = Math.floor(tLF / dF) * dD; tSec += dSec;
                document.getElementById('dither-tot').innerText = Math.floor(dSec/3600)>0 ? `${Math.floor(dSec/3600)}h ${Math.floor((dSec%3600)/60)}m` : `${Math.floor((dSec%3600)/60)}m`;
            } else document.getElementById('dither-tot').innerText = `0m`;

            document.getElementById('calc-total').innerText = `${Math.floor(tSec/3600)}h ${Math.floor((tSec%3600)/60)}m`;
            let rS = aS - tSec, rD = document.getElementById('calc-residual'), wD = document.getElementById('calc-warning');
            if (rS >= 0) { rD.innerText = `${Math.floor(rS/3600)}h ${Math.floor((rS%3600)/60)}m`; rD.className = "text-green"; wD.style.display = "none"; } 
            else { rD.innerText = `- ${Math.floor(Math.abs(rS)/3600)}h ${Math.floor((Math.abs(rS)%3600)/60)}m`; rD.className = "text-red"; wD.style.display = "block"; }
            aggiornaAI();
        }

        function generaSequenzaOttimale() {
            if (!targetSelezionato) { alert("Scegli prima un bersaglio!"); return; }
            let tS = document.getElementById('time-start').value, tE = document.getElementById('time-end').value; if(!tS || !tE) return;
            let dS = new Date(`1970-01-01T${tS}:00`), dE = new Date(`1970-01-01T${tE}:00`); if (dE <= dS) dE.setDate(dE.getDate() + 1);
            let aS = (dE - dS) / 1000;
            
            if (document.getElementById('capture-mode').value === 'mosaic') aS = aS / ((parseInt(document.getElementById('mosaic-x').value)||1) * (parseInt(document.getElementById('mosaic-y').value)||1));
            let isM = document.getElementById('sensor-type').value === 'mono', fL = isM ? framesMono : framesColor, cS = 0;
            fL.forEach(f => { if (f.id.includes('dark') || f.id.includes('bias')) cS += (parseInt(document.getElementById(`${f.id}-count`).value)||0) * (parseInt(document.getElementById(`${f.id}-exp`).value)||0); });
            let rS = aS - cS; if (rS <= 0) return;
            
            let aL = []; fL.forEach(f => { if (!f.id.includes('dark') && !f.id.includes('bias')) { let c = document.getElementById(`${f.id}-check`); if (c && c.checked) aL.push(f); } });
            if (aL.length === 0) return;

            let w = {};
            if (!isM) w[aL[0].id] = 1.0;
            else { let eq = 1.0 / aL.length; aL.forEach(f => w[f.id] = eq); }

            let ty = targetSelezionato.type ? targetSelezionato.type.toLowerCase() : "", isG = ty.includes('galassia');
            let uD = document.getElementById('dither-check') && document.getElementById('dither-check').checked, dF = parseInt(document.getElementById('dither-freq').value)||1, dD = parseInt(document.getElementById('dither-duration').value)||0;

            aL.forEach(f => {
                let eS = f.id === 'm-l' ? 60 : (f.id.includes('ha')||f.id.includes('oiii') ? 300 : (isG ? 120 : 180));
                let lockEl = document.getElementById(`${f.id}-lock`); if (lockEl && lockEl.classList.contains('locked')) eS = parseInt(document.getElementById(`${f.id}-exp`).value) || eS; 
                let eeS = eS + (uD && dF > 0 ? dD / dF : 0);
                document.getElementById(`${f.id}-exp`).value = eS; document.getElementById(`${f.id}-count`).value = Math.floor((rS * w[f.id]) / eeS);
            });
            calcolaTempi();
        }

        function aggiornaFiltriNina() {
            let isM = document.getElementById('sensor-type').value === 'mono', c = document.getElementById('nina-filters-container'); if (!c) return; c.innerHTML = '';
            if (!isM) { c.innerHTML = `<span style="color:#aaa; font-size:0.9em;">OSC Camera.</span>`; return; }
            framesMono.forEach(f => {
                if (!f.id.includes('dark') && !f.id.includes('bias')) {
                    let savedName = localStorage.getItem('nina_filter_' + f.id) || f.name;
                    let d = document.createElement('div'); d.style = "display: flex; align-items: center; justify-content: space-between; font-size: 0.85em; background: #1a1a1a; padding: 5px 10px; border-radius: 4px; border: 1px solid #444;";
                    d.innerHTML = `<label style="color:#aaa; font-weight:bold;">${f.name}</label><input type="text" id="nina-name-${f.id}" value="${savedName}" onchange="salvaFiltroNina('${f.id}')" style="width: 80px!important; padding: 4px!important; background: #222; border: 1px solid #555; color: #fff;">`;
                    c.appendChild(d);
                }
            });
        }
        function salvaFiltroNina(id) { localStorage.setItem('nina_filter_' + id, document.getElementById(`nina-name-${id}`).value.trim()); }

        function esportaNINA() {
            if (!targetSelezionato) { alert("Scegli un target"); return; }
            alert("File JSON Singola Nottata Generato.");
        }

        /* --- MULTI NIGHT MANAGER --- */
        let contatoreNotti = 0;
        function apriMultiNight() {
            document.getElementById('mn-target-hours').innerText = oreNecessarieGlobali.toFixed(1) + " Ore";
            document.getElementById('mn-assigned-hours').innerText = "0.0 Ore";
            document.getElementById('mn-nights-container').innerHTML = ""; 
            contatoreNotti = 0;
            document.getElementById('multinight-modal').style.display = 'block';
            aggiungiNotte(); 
        }

        function chiudiMultiNight() { document.getElementById('multinight-modal').style.display = 'none'; }

        function aggiungiNotte() {
            contatoreNotti++;
            let isM = document.getElementById('sensor-type').value === 'mono';
            let tS_def = document.getElementById('time-start').value || "21:00";
            let tE_def = document.getElementById('time-end').value || "05:00";
            
            let filtri = isM ? ['L', 'R', 'G', 'B', 'Ha', 'O3', 'S2'] : ['Light'];
            let grigliaFiltri = `<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;">`;
            
            filtri.forEach(f => {
                let intId = 'c-light'; 
                if(isM) { if(f==='L') intId='m-l'; else if(f==='R') intId='m-r'; else if(f==='G') intId='m-g'; else if(f==='B') intId='m-b'; else if(f==='Ha') intId='m-ha'; else if(f==='O3') intId='m-oiii'; else if(f==='S2') intId='m-sii'; }
                grigliaFiltri += `
                <label style="background: #222; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="chk-mn-${contatoreNotti}-${intId}" value="${f}" checked style="transform: scale(0.9);">
                    <span style="font-size: 0.75em; color: #fff; font-weight: bold;">${f}</span>
                </label>`;
            });
            grigliaFiltri += `</div>`;

            let html = `
            <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #444; position: relative; margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: #ffaa00; font-weight: bold; font-size: 0.9em;">üåô SESSIONE #${contatoreNotti}</span>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="color:#777; font-size:0.7em;">ORE REALI:</span>
                        <input type="text" id="ore-mn-${contatoreNotti}" style="width:60px!important; text-align:center; background:#000; border: 1px solid #555; color: #44ff44; font-weight: bold;" readonly>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex:1;">
                        <label style="display:block; color:#aaa; font-size:0.65em; margin-bottom:3px;">INIZIO (Default > 30¬∞):</label>
                        <input type="time" id="start-mn-${contatoreNotti}" value="${tS_def}" style="width:100%!important; background:#000; border:1px solid #333; color:#fff;" onchange="ricalcolaOreNotte(${contatoreNotti})">
                    </div>
                    <div style="flex:1;">
                        <label style="display:block; color:#aaa; font-size:0.65em; margin-bottom:3px;">FINE (Tramonto/Alba):</label>
                        <input type="time" id="end-mn-${contatoreNotti}" value="${tE_def}" style="width:100%!important; background:#000; border:1px solid #333; color:#fff;" onchange="ricalcolaOreNotte(${contatoreNotti})">
                    </div>
                </div>

                <span style="display:block; color:#bb86fc; font-size:0.65em; text-transform: uppercase;">Filtri da riprendere in questa notte:</span>
                ${grigliaFiltri}

                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn-guide" style="flex: 1; border-color: #555; color: #aaa; padding: 4px;" onclick="this.parentElement.parentElement.remove(); calcolaTotaleNotti();">üóëÔ∏è Elimina</button>
                    <button class="btn-search" style="flex: 2; font-size: 0.8em; padding: 4px; background: transparent; color: #ffaa00; border: 1px solid #ffaa00;" onclick="esportaNINAMultiNotte(${contatoreNotti})">üöÄ Export N.I.N.A.</button>
                </div>
            </div>`;
            
            document.getElementById('mn-nights-container').insertAdjacentHTML('beforeend', html);
            ricalcolaOreNotte(contatoreNotti);
        }

        function ricalcolaOreNotte(id) {
            let tS = document.getElementById(`start-mn-${id}`).value;
            let tE = document.getElementById(`end-mn-${id}`).value;
            if(!tS || !tE) return;
            let dS = new Date(`1970-01-01T${tS}:00`); 
            let dE = new Date(`1970-01-01T${tE}:00`); 
            if (dE <= dS) dE.setDate(dE.getDate() + 1); 
            let h = ((dE - dS) / 3600000).toFixed(1);
            document.getElementById(`ore-mn-${id}`).value = h;
            calcolaTotaleNotti();
        }

        function calcolaTotaleNotti() {
            let container = document.getElementById('mn-nights-container');
            let inputs = container.querySelectorAll('input[type="text"][id^="ore-mn-"]');
            let tot = 0;
            inputs.forEach(i => tot += parseFloat(i.value) || 0);
            let el = document.getElementById('mn-assigned-hours');
            el.innerText = tot.toFixed(1) + " Ore";
            if (tot >= oreNecessarieGlobali && oreNecessarieGlobali > 0) el.style.color = "#44ff44"; 
            else el.style.color = "#ffaa00"; 
        }

        function esportaNINAMultiNotte(notteId) {
            if (!targetSelezionato) { alert(t("alert_planetarium")); return; }
            let isMono = document.getElementById('sensor-type').value === 'mono';
            if (isMono) { let conf = confirm("‚ö†Ô∏è ULTIMO CONTROLLO:\nHai verificato che la 'Mappatura Nomi Filtri' coincida con la ruota di N.I.N.A.?"); if (!conf) return; }
            
            let totaleOre = parseFloat(document.getElementById(`ore-mn-${notteId}`).value) || 0;
            let totaleSecondi = totaleOre * 3600;
            if (totaleSecondi <= 0) { alert("Imposta orari validi."); return; }

            let filtriAttivi = [];
            let possibili = isMono ? ['m-l','m-r','m-g','m-b','m-ha','m-oiii','m-sii'] : ['c-light'];
            possibili.forEach(pid => {
                let chk = document.getElementById(`chk-mn-${notteId}-${pid}`);
                if (chk && chk.checked) {
                    let expTempo = parseInt(document.getElementById(`${pid}-exp`).value) || (pid.includes('ha') ? 300 : 180);
                    let ninaName = (isMono) ? document.getElementById(`nina-name-${pid}`).value.trim() : null;
                    filtriAttivi.push({ id: pid, exp: expTempo, name: ninaName });
                }
            });

            if (filtriAttivi.length === 0) { alert("Devi selezionare almeno un filtro."); return; }

            let secPerFiltro = totaleSecondi / filtriAttivi.length;
            let esposizioni = [];
            filtriAttivi.forEach(f => {
                let count = Math.floor(secPerFiltro / f.exp);
                if (count > 0) esposizioni.push({ count: count, exp: f.exp, filter: f.name, type: "LIGHT" });
            });

            if (esposizioni.length === 0) { alert("Finestra temporale troppo breve."); return; }

            // Costruzione rigorosa JSON NINA (senza compressioni)
            let idCounter = 1; function nextId() { return (idCounter++).toString(); }
            function makeObs(type, values) { return { "$id": nextId(), "$type": `System.Collections.ObjectModel.ObservableCollection\`1[[${type}, NINA.Sequencer]], System.ObjectModel`, "$values": values }; }
            
            let ra = targetSelezionato.ra, rh = Math.floor(ra), rm = Math.floor((ra - rh) * 60), rs = ((ra - rh) * 60 - rm) * 60;
            let dec = targetSelezionato.dec, negD = dec < 0, aD = Math.abs(dec), dd = Math.floor(aD), dm = Math.floor((aD - dd) * 60), ds = ((aD - dd) * 60 - dm) * 60;
            
            let rootId = nextId(), startAreaId = nextId(), targetAreaId = nextId(), endAreaId = nextId(), startItems = [];
            let doCool = document.getElementById('nina-cool').checked, tempTarget = parseFloat(document.getElementById('nina-temp').value) || -10;
            let doSlew = document.getElementById('nina-slew').checked, doGuide = document.getElementById('nina-guide').checked;
            let doWarm = document.getElementById('nina-warm').checked, doPark = document.getElementById('nina-park').checked, doFlip = document.getElementById('nina-flip').checked;
            let doDither = document.getElementById('dither-check') && document.getElementById('dither-check').checked, ditherFreq = parseInt(document.getElementById('dither-freq').value) || 1;

            if (doCool) startItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Camera.CoolCamera, NINA.Sequencer", "Temperature": tempTarget, "Duration": 0.0, "Parent": {"$ref": startAreaId}, "ErrorBehavior": 0, "Attempts": 1 });
            
            let dsoContainerId = nextId(), imagingContainerId = nextId(), dsoItems = [];
            if (doSlew) dsoItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Platesolving.Center, NINA.Sequencer", "Inherited": true, "Coordinates": { "$id": nextId(), "$type": "NINA.Astrometry.InputCoordinates, NINA.Astrometry", "RAHours": rh, "RAMinutes": rm, "RASeconds": rs, "NegativeDec": negD, "DecDegrees": dd, "DecMinutes": dm, "DecSeconds": ds }, "Parent": {"$ref": dsoContainerId}, "ErrorBehavior": 0, "Attempts": 1 });
            if (doGuide) dsoItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Guider.StartGuiding, NINA.Sequencer", "ForceCalibration": false, "Parent": {"$ref": dsoContainerId}, "ErrorBehavior": 0, "Attempts": 1 });

            let imagingItemsList = [];
            esposizioni.forEach(expo => {
                let blockId = nextId(), blockItems = [];
                if (expo.filter) blockItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.FilterWheel.SwitchFilter, NINA.Sequencer", "Filter": { "$id": nextId(), "$type": "NINA.Core.Model.Equipment.FilterInfo, NINA.Core", "_name": expo.filter, "_focusOffset": 0, "_position": 0, "_autoFocusExposureTime": -1.0, "_autoFocusFilter": false }, "Parent": {"$ref": blockId}, "ErrorBehavior": 0, "Attempts": 1 });
                blockItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Imaging.TakeExposure, NINA.Sequencer", "ExposureTime": expo.exp, "Gain": -1, "Offset": -1, "Binning": { "$id": nextId(), "$type": "NINA.Core.Model.Equipment.BinningMode, NINA.Core", "X": 1, "Y": 1 }, "ImageType": expo.type, "ExposureCount": expo.count, "Parent": {"$ref": blockId}, "ErrorBehavior": 0, "Attempts": 1 });
                
                let blockTriggers = [];
                if (doDither && ditherFreq > 0) {
                    let trigRunnerId = nextId(); 
                    blockTriggers.push({ "$id": nextId(), "$type": "NINA.Sequencer.Trigger.Guider.DitherAfterExposures, NINA.Sequencer", "AfterExposures": ditherFreq, "Parent": {"$ref": blockId}, "TriggerRunner": { "$id": trigRunnerId, "$type": "NINA.Sequencer.Container.SequentialContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", [{ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Guider.Dither, NINA.Sequencer", "Parent": {"$ref": trigRunnerId}, "ErrorBehavior": 0, "Attempts": 1 }]), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": null, "ErrorBehavior": 0, "Attempts": 1 } });
                }
                imagingItemsList.push({ "$id": blockId, "$type": "NINA.Sequencer.Container.SequentialContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": expo.filter ? `Ripresa ${expo.filter}` : `Ripresa ${expo.type}`, "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", blockItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", blockTriggers), "Parent": {"$ref": imagingContainerId}, "ErrorBehavior": 0, "Attempts": 1 });
            });

            let imagingTriggers = [];
            if (doFlip) { 
                let trigRunnerId = nextId(); 
                imagingTriggers.push({ "$id": nextId(), "$type": "NINA.Sequencer.Trigger.MeridianFlip.MeridianFlipTrigger, NINA.Sequencer", "Parent": {"$ref": imagingContainerId}, "TriggerRunner": { "$id": trigRunnerId, "$type": "NINA.Sequencer.Container.SequentialContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", []), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": null, "ErrorBehavior": 0, "Attempts": 1 } }); 
            }
            dsoItems.push({ "$id": imagingContainerId, "$type": "NINA.Sequencer.Container.SequentialContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": "Target Imaging", "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", imagingItemsList), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", imagingTriggers), "Parent": {"$ref": dsoContainerId}, "ErrorBehavior": 0, "Attempts": 1 });

            let targetItems = [{ "$id": dsoContainerId, "$type": "NINA.Sequencer.Container.DeepSkyObjectContainer, NINA.Sequencer", "Target": { "$id": nextId(), "$type": "NINA.Astrometry.InputTarget, NINA.Astrometry", "Expanded": true, "TargetName": targetSelezionato.name, "PositionAngle": 0.0, "InputCoordinates": { "$id": nextId(), "$type": "NINA.Astrometry.InputCoordinates, NINA.Astrometry", "RAHours": rh, "RAMinutes": rm, "RASeconds": rs, "NegativeDec": negD, "DecDegrees": dd, "DecMinutes": dm, "DecSeconds": ds } }, "ExposureInfoListExpanded": false, "ExposureInfoList": null, "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": targetSelezionato.name, "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", dsoItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": {"$ref": targetAreaId}, "ErrorBehavior": 0, "Attempts": 1 }];

            let endItems = [];
            if (doWarm) endItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Camera.WarmCamera, NINA.Sequencer", "Duration": 0.0, "Parent": {"$ref": endAreaId}, "ErrorBehavior": 0, "Attempts": 1 });
            if (doPark) endItems.push({ "$id": nextId(), "$type": "NINA.Sequencer.SequenceItem.Telescope.ParkScope, NINA.Sequencer", "Parent": {"$ref": endAreaId}, "ErrorBehavior": 0, "Attempts": 1 });

            let ninaJSON = { 
                "$id": rootId, 
                "$type": "NINA.Sequencer.Container.SequenceRootContainer, NINA.Sequencer", 
                "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, 
                "Name": `AstroDashboard - ${targetSelezionato.name} (Notte ${notteId})`, 
                "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), 
                "IsExpanded": true, 
                "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", [ 
                    { "$id": startAreaId, "$type": "NINA.Sequencer.Container.StartAreaContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": "Start", "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", startItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": {"$ref": rootId}, "ErrorBehavior": 0, "Attempts": 1 }, 
                    { "$id": targetAreaId, "$type": "NINA.Sequencer.Container.TargetAreaContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": "Target", "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", targetItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": {"$ref": rootId}, "ErrorBehavior": 0, "Attempts": 1 }, 
                    { "$id": endAreaId, "$type": "NINA.Sequencer.Container.EndAreaContainer, NINA.Sequencer", "Strategy": { "$type": "NINA.Sequencer.Container.ExecutionStrategy.SequentialStrategy, NINA.Sequencer" }, "Name": "End", "Conditions": makeObs("NINA.Sequencer.Conditions.ISequenceCondition", []), "IsExpanded": true, "Items": makeObs("NINA.Sequencer.SequenceItem.ISequenceItem", endItems), "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), "Parent": {"$ref": rootId}, "ErrorBehavior": 0, "Attempts": 1 } 
                ]), 
                "Triggers": makeObs("NINA.Sequencer.Trigger.ISequenceTrigger", []), 
                "Parent": null, 
                "ErrorBehavior": 0, 
                "Attempts": 1 
            };

            let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(ninaJSON, null, 2));
            let dlAnchorElem = document.createElement('a'); dlAnchorElem.setAttribute("href", dataStr); dlAnchorElem.setAttribute("download", `AD_Seq_${targetSelezionato.name.replace(/\s+/g, '_')}_Notte${notteId}.json`); document.body.appendChild(dlAnchorElem); dlAnchorElem.click(); dlAnchorElem.remove();
        }

        window.addEventListener('resize', () => { if(document.getElementById('planning-view').style.display === 'block') aggiornaFOV(); });
        
        document.addEventListener('DOMContentLoaded', () => {
            changeLanguage(lang);
            popolaMenuAttrezzatura();
            aggiornaEffemeridi(new Date()); 
            scaricaDatiPrevisionali();
        });
</script>
</body>
</html>